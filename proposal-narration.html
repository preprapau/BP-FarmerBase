<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Proposal Narration | BP-FarmerBase</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati","Mangal","Nirmala UI",system-ui;
  background:#f4f7f6;
  margin:0;
}
.wrap{
  max-width:950px;
  margin:25px auto;
  background:#fff;
  padding:25px;
  border-radius:10px;
}
h2{color:#2e7d32;margin-top:0}
.small{font-size:13px;color:#555}

/* ===== TOP BAR ===== */
.topBar{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  margin-bottom:12px;
}
.topBar .left{text-align:left}
.topBar .center{text-align:center}
.topBar .right{text-align:right}

/* textarea */
textarea{
  width:100%;
  min-height:260px;
  padding:12px;
  font-family:inherit;
  line-height:1.7;
}

/* buttons */
button{
  border:none;
  border-radius:6px;
  padding:8px 16px;
  cursor:pointer;
  background:#2e7d32;
  color:#fff;
}
.previewBtn{background:#0277bd}
.autoBtn{background:#455a64;margin-top:10px}

/* preview */
.preview textarea{
  pointer-events:none;
  background:#f3f3f3;
}
.previewNote{
  background:#fff3cd;
  padding:6px 10px;
  border-radius:6px;
  font-size:13px;
  margin-bottom:10px;
}

/* bottom nav */
.nav{
  display:flex;
  justify-content:space-between;
  margin-top:30px;
}
</style>
</head>

<body>

<div class="wrap" id="page">

<!-- ===== TOP CONTROLS ===== -->
<div class="topBar">
  <div class="left">
    <button onclick="location.href='business-detail.html'">‚¨Ö Business Detail</button>
  </div>

  <div class="center">
    <button class="previewBtn" onclick="togglePreview()">üëÅ Preview / ‚úèÔ∏è Edit</button>
  </div>

  <div class="right">
    <button onclick="location.href='executive-summary.html'">Next ‚û°</button>
  </div>
</div>

<div id="previewNote" class="previewNote" style="display:none">
üëÅ Preview Mode (Read-only)
</div>

<h2>üìÑ Proposal Narration (‡§∏‡•ç‡§µ‡§ö‡§æ‡§≤‡§ø‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£)</h2>
<p class="small">
‡§Ø‡•ã narration Short-Info, Existing-Status, Short-Analysis ‡§∞ Sustainability ‡§¨‡§æ‡§ü
‡§∏‡•ç‡§µ‡§§‡§É ‡§§‡§Ø‡§æ‡§∞ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§π‡•ã‡•§ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§™‡§∞‡•á ‡§∏‡§ö‡•ç‡§Ø‡§æ‡§â‡§® ‡§∏‡§ï‡•ç‡§®‡•Å‡§π‡•Å‡§®‡•ç‡§õ‡•§
</p>

<textarea id="narrationText"></textarea>

<button class="autoBtn" onclick="generateNarration()">‚ö° Auto-Generate / Refresh</button>

<!-- ===== BOTTOM NAV ===== -->
<div class="nav">
  <button onclick="location.href='business-detail.html'">‚¨Ö Previous</button>
  <button onclick="location.href='executive-summary.html'">Next ‚û°</button>
</div>

</div>

<script>
/* ===== LOAD PROJECT ===== */
const key = localStorage.getItem("activeProject");
if(!key){
  alert("‡§™‡§π‡§ø‡§≤‡•á Project ‡§∏‡•Å‡§∞‡•Å ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç");
  location.href="index.html";
}
const project = JSON.parse(localStorage.getItem(key));

project.proposalNarration ??= "";

/* ===== AUTO GENERATOR ===== */
function generateNarration(){
  const s = project.shortInfo || {};
  const ex = project.existingStatus || {};
  const works = ex.works || [];
  const checklist = ex.checklist || [];
  const checked = checklist.filter(c=>c.checked);
  const analysis = project.shortAnalysis || "";
  const sus = project.sustainability || {};

  let text = "";

  /* Intro */
  text += `${s.bp_name || "‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ‡§ø‡§§ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø"} `;
  if(s.bp_location)
    text += `${s.bp_location} ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§Æ‡§æ ‡§∏‡§û‡•ç‡§ö‡§æ‡§≤‡§® ‡§π‡•Å‡§®‡•á `;
  text += "‡§ï‡•É‡§∑‡§ø/‡§â‡§¶‡•ç‡§Ø‡§Æ ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡•Ä ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ ‡§π‡•ã‡•§ ";

  if(s.bp_products)
    text += `‡§Ø‡§∏‡§ï‡•ã ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§™‡•ç‡§∞‡§ï‡•É‡§§‡§ø ${s.bp_products} ‡§∞‡§π‡•á‡§ï‡•ã ‡§õ‡•§\n\n`;

  /* Existing status */
  if(works.length){
    text += `‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ‡§≤‡•á ‡§π‡§æ‡§≤‡§∏‡§Æ‡•ç‡§Æ ${works.length} ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞‡§ï‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§§‡§•‡§æ ‡§Ö‡§®‡•Å‡§≠‡§µ‡§π‡§∞‡•Ç ‡§π‡§æ‡§∏‡§ø‡§≤ ‡§ó‡§∞‡§ø‡§∏‡§ï‡•á‡§ï‡•ã ‡§õ‡•§ `;
  }
  if(checked.length){
    text += `${checked.length} ‡§ï‡§ø‡§∏‡§ø‡§Æ‡§ï‡§æ ‡§Ü‡§ß‡§æ‡§∞‡§≠‡•Ç‡§§ ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞ ‡§§‡§•‡§æ ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§õ‡§®‡•ç‡•§\n\n`;
  }

  /* Analysis */
  if(analysis){
    text += analysis + "\n\n";
  }

  /* Sustainability */
  if(sus.strengths?.length){
    text += `‡§∏‡§¨‡§≤ ‡§™‡§ï‡•ç‡§∑‡§π‡§∞‡•Ç: ${sus.strengths.join(", ")}‡•§\n`;
  }
  if(sus.weaknesses?.length){
    text += `‡§∏‡•Å‡§ß‡§æ‡§∞ ‡§ó‡§∞‡•ç‡§®‡•Å‡§™‡§∞‡•ç‡§®‡•á ‡§™‡§ï‡•ç‡§∑: ${sus.weaknesses.join(", ")}‡•§\n`;
  }
  if(sus.opportunities?.length){
    text += `‡§Ö‡§µ‡§∏‡§∞‡§π‡§∞‡•Ç: ${sus.opportunities.join(", ")}‡•§\n`;
  }
  if(sus.solutions?.length){
    text += `‡§∏‡§Æ‡§æ‡§ß‡§æ‡§®/‡§∞‡§£‡§®‡•Ä‡§§‡§ø: ${sus.solutions.join(", ")}‡•§\n\n`;
  }

  /* Conclusion */
  text += "‡§∏‡§Æ‡§ó‡•ç‡§∞‡§Æ‡§æ, ‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡•Å‡§§ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§∏‡•ç‡§∞‡•ã‡§§, ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§∞ ‡§∏‡§Æ‡•ç‡§≠‡§æ‡§µ‡§®‡§æ‡§Æ‡§æ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§≠‡§è‡§ï‡§æ‡§≤‡•á ";
  text += "‡§â‡§ö‡§ø‡§§ ‡§≤‡§ó‡§æ‡§®‡•Ä, ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§§‡§•‡§æ ‡§™‡•ç‡§∞‡§µ‡§ø‡§ß‡§ø ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§æ ‡§∏‡§æ‡§• ‡§¶‡•Ä‡§ó‡•ã, ‡§®‡§æ‡§´‡§æ‡§Æ‡•Å‡§ñ‡•Ä ‡§∞ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä ‡§∏‡§ø‡§∞‡•ç‡§ú‡§®‡§æ ‡§ó‡§∞‡•ç‡§®‡•á ";
  text += "‡§â‡§ö‡•ç‡§ö ‡§∏‡§Æ‡•ç‡§≠‡§æ‡§µ‡§®‡§æ ‡§∞‡§æ‡§ñ‡•ç‡§¶‡§õ‡•§";

  narrationText.value = text;
  project.proposalNarration = text;
  save();
}

/* ===== AUTOSAVE ===== */
narrationText.addEventListener("input",()=>{
  project.proposalNarration = narrationText.value;
  save();
});

function save(){
  project.lastEdited = new Date().toLocaleString("ne-NP");
  localStorage.setItem(key,JSON.stringify(project));
}

/* ===== LOAD EXISTING ===== */
if(project.proposalNarration){
  narrationText.value = project.proposalNarration;
}else{
  generateNarration();
}

/* ===== PREVIEW ===== */
let preview=false;
function togglePreview(){
  preview=!preview;
  page.classList.toggle("preview",preview);
  previewNote.style.display = preview ? "block":"none";
}
</script>

</body>
</html>
