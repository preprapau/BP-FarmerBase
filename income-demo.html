<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Income & Pricing | Farmerbase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;margin:0
}
header,footer{
  background:#e8f5e9;
  padding:10px 16px;
  display:flex;
  justify-content:space-between
}
header a,footer a{
  color:#2e7d32;
  font-weight:600;
  text-decoration:none
}
.wrap{
  max-width:1100px;
  margin:18px auto;
  background:#fff;
  padding:22px;
  border-radius:12px
}
h2{color:#2e7d32;margin-top:0}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:right}
th{background:#eef5ee}
.left{text-align:left}
input{width:100%;padding:6px;box-sizing:border-box}
.small{font-size:13px;color:#2e7d32}
.sum{font-weight:700;background:#fafafa}
</style>
</head>

<body>

<header>
  <a href="operating-cost-engine.html">‚óÄÔ∏è Operating Cost</a>
  <a href="profit-loss-demo.html">Profit‚ÄìLoss ‚ñ∂Ô∏è</a>
</header>

<div class="wrap">

<h2>üí∞ ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä ‡§§‡§•‡§æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§£</h2>

<table>
<thead>
<tr>
  <th class="left">‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®</th>
  <th>‡§™‡§∞‡§ø‡§Æ‡§æ‡§£</th>
  <th>‡§è‡§ï‡§æ‡§á</th>
  <th>‡§™‡•ç‡§∞‡§§‡§ø-‡§è‡§ï‡§æ‡§á ‡§≤‡§æ‡§ó‡§§</th>
  <th>‡§®‡§æ‡§´‡§æ %</th>
  <th>‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§¶‡§∞</th>
  <th>‡§∞‡§ï‡§Æ</th>
</tr>
</thead>
<tbody id="body"></tbody>
<tfoot>
<tr class="sum">
  <td colspan="6" class="left">‡§ï‡•Å‡§≤ ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</td>
  <td id="grandTotal">0</td>
</tr>
</tfoot>
</table>

<p class="small">
‚úîÔ∏è ‡§≤‡§æ‡§ó‡§§ Operating Cost ‡§¨‡§æ‡§ü ‡§∏‡•ç‡§µ‡§§‡§É ‡§Ü‡§è‡§ï‡•ã ‡§õ  
| ‚úîÔ∏è ‡§®‡§æ‡§´‡§æ % change ‡§ó‡§∞‡•ç‡§¶‡§æ Auto-Save  
| ‚úîÔ∏è ‡§¶‡§∞ ‡§ö‡§æ‡§π‡§ø‡§Å manual edit ‡§ó‡§∞‡•ç‡§® ‡§Æ‡§ø‡§≤‡•ç‡§õ
</p>

</div>

<footer>
  <a href="operating-cost-engine.html">‚óÄÔ∏è Operating Cost</a>
  <a href="profit-loss-demo.html">Next ‚ñ∂Ô∏è</a>
</footer>

<script>
/* =====================================================
   LOAD PROJECT & COST ALLOCATION
   ===================================================== */
const projectKey = localStorage.getItem("activeProject");
if(!projectKey){
  alert("‡§™‡§π‡§ø‡§≤‡•á Project ‡§ñ‡•ã‡§≤‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç");
  location.href="index.html";
}

let project = JSON.parse(localStorage.getItem(projectKey)) || {};
project.income = project.income || {};
let income = project.income;

const allocation = project.costAllocation || {};

/* =====================================================
   RENDER TABLE
   ===================================================== */
function renderIncome(){
  body.innerHTML = "";
  let total = 0;

  Object.keys(allocation).forEach(pid=>{
    const p = allocation[pid];

    // init income row if missing
    if(!income[pid]){
      income[pid] = {
        margin: 20,      // default margin %
        rate: 0,
        override: false
      };
    }

    const row = income[pid];
    const unitCost = p.unitCost || 0;

    // auto rate if not overridden
    if(!row.override){
      row.rate = unitCost * (1 + row.margin/100);
    }

    const amount = p.qty * row.rate;
    total += amount;

    body.innerHTML += `
    <tr>
      <td class="left">${p.name}</td>
      <td>${p.qty}</td>
      <td>${p.unit}</td>
      <td>${unitCost.toFixed(2)}</td>
      <td>
        <input type="number" value="${row.margin}"
          oninput="updateMargin('${pid}',this.value)">
      </td>
      <td>
        <input type="number" value="${row.rate.toFixed(2)}"
          oninput="updateRate('${pid}',this.value)">
      </td>
      <td>${amount.toFixed(2)}</td>
    </tr>
    `;
  });

  grandTotal.innerText = total.toFixed(2);

  project.income = income;
  project.totalIncome = total;
  localStorage.setItem(projectKey, JSON.stringify(project));
}

/* =====================================================
   UPDATE HANDLERS
   ===================================================== */
function updateMargin(pid,val){
  income[pid].margin = Number(val)||0;
  income[pid].override = false; // back to auto
  renderIncome();
}

function updateRate(pid,val){
  income[pid].rate = Number(val)||0;
  income[pid].override = true; // manual override
  renderIncome();
}

/* =====================================================
   INIT
   ===================================================== */
renderIncome();
</script>

</body>
</html>
