<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Income | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;
  margin:0;
}
header,footer{
  background:#e8f5e9;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header a,footer a{
  text-decoration:none;
  font-weight:700;
  color:#2e7d32;
}
.container{
  max-width:1200px;
  margin:0 auto;
  padding:20px;
}
h2,h3{color:#2e7d32;margin:8px 0}
.small{font-size:13px;color:#555}

.section{
  background:#fff;
  padding:14px;
  border-radius:12px;
  margin-bottom:16px;
}

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  font-size:14px;
}
th{background:#eef5ee}
.right{text-align:right}

input,select{
  width:100%;
  padding:6px;
  box-sizing:border-box;
}

.inline{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  align-items:center;
}

.highlight{
  background:#e8f5e9;
  font-weight:700;
}

.rateBox{
  font-size:14px;
  margin-top:6px;
}
.suggested{
  color:#1565c0;
  font-weight:700;
}
.finalRate{
  color:#2e7d32;
  font-weight:700;
}

.badge{
  display:inline-block;
  padding:4px 12px;
  border-radius:20px;
  font-size:13px;
  margin-left:6px;
}
.badge-suggest{background:#e3f2fd;color:#1565c0}
.badge-final{background:#e8f5e9;color:#2e7d32}

.del{
  color:#c62828;
  cursor:pointer;
  font-weight:700;
}

.totalIncome{
  background:#e8f5e9;
  font-size:20px;
  font-weight:700;
  text-align:center;
  padding:16px;
  border-radius:12px;
}

.footerNav{
  display:flex;
  justify-content:space-between;
  width:100%;
}

@media print{
  header, footer, button, .badge{display:none}
  body{background:#fff}
}
</style>
</head>

<body>

<!-- TOP NAV -->
<header>
  <a href="production-cost-summary.html">‚¨ÖÔ∏è Cost Summary</a>
  <strong>üìà Income</strong>
  <a href="profit-loss.html">‚û°Ô∏è Profit‚ÄìLoss</a>
</header>

<div class="container">

<h2>‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£ (Income Planning)</h2>
<p class="small">
‚ÑπÔ∏è ‡§™‡•ç‡§∞‡§§‡§ø ‡§á‡§ï‡§æ‡§à ‡§≤‡§æ‡§ó‡§§ <b>Production Cost Summary</b> ‡§¨‡§æ‡§ü ‡§Ü‡§è‡§ï‡•ã ‡§π‡•ã‡•§  
‡§®‡§æ‡§´‡§æ ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§/‡§∞‡§ï‡§Æ ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§® ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§¶‡§∞ ‡§∞ ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä ‡§∏‡•ç‡§µ‡§§‡§É ‡§ó‡§£‡§®‡§æ ‡§π‡•Å‡§®‡•ç‡§õ‡•§
</p>

<!-- INCOME TABLE -->
<div class="section">
<table>
<thead>
<tr>
  <th>‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®</th>
  <th>‡§á‡§ï‡§æ‡§à</th>
  <th class="right">‡§™‡§∞‡§ø‡§Æ‡§æ‡§£</th>
  <th class="right">‡§™‡•ç‡§∞‡§§‡§ø ‡§á‡§ï‡§æ‡§à ‡§≤‡§æ‡§ó‡§§</th>
  <th>‡§®‡§æ‡§´‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</th>
  <th class="right">‡§®‡§æ‡§´‡§æ</th>
  <th class="right">‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§¶‡§∞</th>
  <th class="right">‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</th>
  <th></th>
</tr>
</thead>
<tbody id="tbody"></tbody>
<tr class="highlight">
  <th colspan="7" class="right">‡§ï‡•Å‡§≤ ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</th>
  <th class="right" id="totalIncome">0</th>
  <th></th>
</tr>
</table>
</div>

</div>

<!-- BOTTOM NAV -->
<footer>
  <div class="footerNav">
    <a href="production-cost-summary.html">‚¨ÖÔ∏è Cost Summary</a>
    <span class="small">
      FarmerBase BP Engine ‚Äì Income Module
    </span>
    <a href="profit-loss.html">‚û°Ô∏è Profit‚ÄìLoss</a>
  </div>
</footer>

<script>
/* ===============================
   INCOME DEMO ‚Äì FINAL
   =============================== */

const key = localStorage.getItem("activeProject");
if(!key){ alert("Active ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§≠‡•á‡§ü‡§ø‡§è‡§®"); }

const project = JSON.parse(localStorage.getItem(key)) || {};

project.income = project.income || [];

/* --- source data --- */
const products = project.productionProducts || [];
const expenses = project.expenses || [];

/* --- helper: unit cost from expense allocation --- */
function allocateExpenseToProduct(exp, product){
  if(exp.allocationType==="LS"){
    return exp.amount / products.length;
  }
  if(exp.allocationType==="DIRECT"){
    return exp.appliesTo?.includes(product.id) ? exp.amount : 0;
  }
  if(exp.allocationType==="%"){
    const p = exp.allocationPercent?.[product.id] || 0;
    return exp.amount * (p/100);
  }
  return 0;
}

function getUnitCost(product){
  let total=0;
  expenses.forEach(e=>{
    total+=allocateExpenseToProduct(e,product);
  });
  return product.qty && product.qty>0 ? total/product.qty : 0;
}

/* --- initialize income rows if empty --- */
if(project.income.length===0){
  products.forEach(p=>{
    project.income.push({
      id:Date.now()+Math.random(),
      product:p.name,
      unit:p.unit,
      qty:p.qty||0,
      marginType:"%",
      marginValue:20,
      sellingRate:0
    });
  });
}

/* --- save --- */
function save(){
  localStorage.setItem(key,JSON.stringify(project));
  render();
}

/* --- render --- */
function render(){
  tbody.innerHTML="";
  let total=0;

  project.income.forEach((i,idx)=>{
    const prod = products.find(p=>p.name===i.product);
    const unitCost = prod ? getUnitCost(prod) : 0;

    let sellRate = unitCost;
    if(i.marginType==="%"){
      sellRate = unitCost + (unitCost * (i.marginValue||0)/100);
    }else{
      sellRate = unitCost + (i.marginValue||0);
    }
    i.sellingRate = sellRate;

    const amount = sellRate * (i.qty||0);
    total+=amount;

    tbody.innerHTML+=`
    <tr>
      <td>${i.product}</td>
      <td>${i.unit||""}</td>
      <td class="right">
        <input type="number" value="${i.qty}"
          oninput="project.income[${idx}].qty=+this.value||0;save()">
      </td>
      <td class="right">${unitCost.toFixed(2)}</td>
      <td>
        <select onchange="project.income[${idx}].marginType=this.value;save()">
          <option value="%" ${i.marginType==="%"?"selected":""}>%</option>
          <option value="LS" ${i.marginType==="LS"?"selected":""}>‡§∞‡•Å</option>
        </select>
      </td>
      <td class="right">
        <input type="number" value="${i.marginValue}"
          oninput="project.income[${idx}].marginValue=+this.value||0;save()">
      </td>
      <td class="right">
        <span class="finalRate">${sellRate.toFixed(2)}</span>
        <span class="badge badge-final">Final</span>
      </td>
      <td class="right">${amount.toLocaleString()}</td>
      <td class="del" onclick="removeRow(${idx})">‚úñ</td>
    </tr>`;
  });

  totalIncome.innerText=total.toLocaleString();
}

/* --- delete --- */
function removeRow(i){
  if(!confirm("‡§Ø‡•ã ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä ‡§π‡§ü‡§æ‡§â‡§®‡•á ?"))return;
  project.income.splice(i,1);
  save();
}

render();
</script>

</body>
</html>
