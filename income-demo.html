<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>рдЖрдореНрджрд╛рдиреА рд╡рд┐рд╡рд░рдг | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;
  margin:0;
}
header, footer{
  background:#e8f5e9;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header a, footer a{
  text-decoration:none;
  font-weight:700;
  color:#2e7d32;
}
.navAero a{ margin:0 8px; }
.container{
  max-width:1100px;
  margin:0 auto;
  padding:20px;
}
h2,h3{ color:#2e7d32; margin:10px 0; }
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  font-size:14px;
}
th{ background:#eef5ee; }
input,select{
  width:100%;
  padding:6px;
  box-sizing:border-box;
}
.footerBox{
  background:#fff;
  border:1px solid #ccc;
  padding:12px;
  margin-top:16px;
}
.small{ font-size:13px;color:#555; }
</style>
</head>

<body>

<!-- ===== TOP NAV ===== -->
<header>
  <div class="navAero">
    <a href="expense-demo.html">тмЕя╕П Expense</a>
  </div>

  <div>
    <a href="index.html" target="_blank">ЁЯПа Home</a> |
    <a href="income-report.html" target="_blank">ЁЯУИ Income Report</a>
  </div>

  <div class="navAero">
    <a href="profit-loss.html">ProfitтАУLoss тЮбя╕П</a>
  </div>
</header>

<div class="container">

<h2>ЁЯУИ рдЖрдореНрджрд╛рдиреА рд╡рд┐рд╡рд░рдг</h2>
<p class="small">
рдЙрддреНрдкрд╛рджрди рдкрд░рд┐рдорд╛рдг Production рдкреЗрдЬрдмрд╛рдЯ рд░ рдпреБрдирд┐рдЯ рд▓рд╛рдЧрдд Expense allocation рдмрд╛рдЯ рд╕реНрд╡рддрдГ рдЖрдПрдХреЛ рд╣реЛред  
рддрдкрд╛рдИрдВрд▓реЗ рдирд╛рдлрд╛ (Margin) рдорд╛рддреНрд░ рдирд┐рд░реНрдзрд╛рд░рдг рдЧрд░реНрдиреБрд╣реЛрд╕реНред
</p>

<table>
<thead>
<tr>
  <th>рдЙрддреНрдкрд╛рджрди</th>
  <th>рдкрд░рд┐рдорд╛рдг</th>
  <th>рдЗрдХрд╛рдЗ</th>
  <th>рдпреБрдирд┐рдЯ рд▓рд╛рдЧрдд (рд░реБ)</th>
  <th>Margin рдкреНрд░рдХрд╛рд░</th>
  <th>Margin</th>
  <th>рдмрд┐рдХреНрд░реА рджрд░</th>
  <th>рдЖрдореНрджрд╛рдиреА (рд░реБ)</th>
</tr>
</thead>
<tbody id="incomeBody"></tbody>
</table>

<div class="footerBox">
  <strong>рдХреБрд▓ рдЖрдореНрджрд╛рдиреА : рд░реБ <span id="grandIncome">0</span></strong>
</div>

</div>

<!-- ===== BOTTOM NAV ===== -->
<footer>
  <div class="navAero">
    <a href="expense-demo.html">тмЕя╕П Expense</a>
  </div>

  <div class="small">
    FarmerBase BP Engine тАУ рдЙрддреНрдкрд╛рджрди рд▓рд╛рдЧрддрдорд╛ рдЖрдзрд╛рд░рд┐рдд рдЖрдореНрджрд╛рдиреА рдпреЛрдЬрдирд╛
  </div>

  <div class="navAero">
    <a href="profit-loss.html">ProfitтАУLoss тЮбя╕П</a>
  </div>
</footer>

<script>
/* ===== LOAD PROJECT ===== */
const key = localStorage.getItem("activeProject");
if(!key){ alert("Active рдпреЛрдЬрдирд╛ рднреЗрдЯрд┐рдПрди"); }

let project = JSON.parse(localStorage.getItem(key)) || {};
project.income = project.income || [];
const products = project.productionProducts || [];
const expenses = project.expenses || [];

/* ===== ALLOCATION LOGIC (same as expense-demo) ===== */
function allocateExpense(e){
  const res = {};
  const totalQty = products.reduce((s,p)=>s+(Number(p.qty)||0),0);

  if(e.allocationType==="DIRECT"){
    res[e.appliesTo[0]] = e.amount;
    return res;
  }
  if(e.allocationType==="LS"){
    e.appliesTo.forEach(pid=>{
      const p = products.find(x=>x.id===pid);
      res[pid] = totalQty>0 ? e.amount*(p.qty/totalQty) : 0;
    });
    return res;
  }
  if(e.allocationType==="%"){
    e.appliesTo.forEach(pid=>{
      const pct = e.allocationPercent?.[pid] || 0;
      res[pid] = e.amount*(pct/100);
    });
    return res;
  }
  return res;
}

/* ===== UNIT COST ===== */
function computeUnitCost(){
  const costMap = {};
  products.forEach(p=>costMap[p.id]=0);

  expenses.forEach(e=>{
    const alloc = allocateExpense(e);
    Object.keys(alloc).forEach(pid=>{
      costMap[pid]+=alloc[pid];
    });
  });

  const unitCost = {};
  products.forEach(p=>{
    unitCost[p.id] = p.qty>0 ? costMap[p.id]/p.qty : 0;
  });
  return unitCost;
}

/* ===== RENDER ===== */
function render(){
  incomeBody.innerHTML="";
  let total = 0;

  const unitCostMap = computeUnitCost();

  products.forEach(p=>{
    if(p.qty<=0) return;

    let row = project.income.find(x=>x.productId===p.id);
    if(!row){
      row = { productId:p.id, marginType:"%", marginValue:20 };
      project.income.push(row);
    }

    const uc = unitCostMap[p.id] || 0;
    let sellRate = 0;

    if(row.marginType==="%"){
      sellRate = uc * (1 + (row.marginValue/100));
    }else{
      sellRate = uc + (row.marginValue||0);
    }

    const incomeAmt = sellRate * p.qty;
    total += incomeAmt;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${p.name}</td>
      <td>${p.qty}</td>
      <td>${p.unit}</td>
      <td>${uc.toFixed(2)}</td>
      <td>
        <select onchange="setMarginType('${p.id}',this.value)">
          <option value="%" ${row.marginType==="%"?"selected":""}>%</option>
          <option value="LS" ${row.marginType==="LS"?"selected":""}>рд░реБ</option>
        </select>
      </td>
      <td>
        <input type="number" value="${row.marginValue}"
          onchange="setMarginValue('${p.id}',this.value)">
      </td>
      <td>${sellRate.toFixed(2)}</td>
      <td>${incomeAmt.toFixed(2)}</td>
    `;
    incomeBody.appendChild(tr);
  });

  grandIncome.innerText = total.toFixed(2);
  project.totalIncome = total;
  save();
}

/* ===== UPDATE ===== */
function setMarginType(pid,v){
  project.income.find(x=>x.productId===pid).marginType=v;
  render();
}
function setMarginValue(pid,v){
  project.income.find(x=>x.productId===pid).marginValue=Number(v)||0;
  render();
}

/* ===== SAVE ===== */
function save(){
  localStorage.setItem(key,JSON.stringify(project));
}

/* INIT */
render();
</script>

</body>
</html>
