<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§≤‡§æ‡§ó‡§§ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;
  margin:0;
}
header,footer{
  background:#e8f5e9;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header a,footer a{
  text-decoration:none;
  font-weight:700;
  color:#2e7d32;
}
.container{
  max-width:1200px;
  margin:0 auto;
  padding:20px;
}
h2,h3{color:#2e7d32;margin:8px 0}
.small{font-size:13px;color:#555}

.costBox{
  background:#fff;
  border:1px solid #ccc;
  padding:16px;
  margin-bottom:16px;
  border-radius:12px;
}

.costTitle{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.costBadge{
  padding:4px 12px;
  border-radius:20px;
  font-size:13px;
  font-weight:700;
}
.badge-var{background:#e3f2fd;color:#1565c0}
.badge-fix{background:#fff3e0;color:#ef6c00}
.badge-total{background:#e8f5e9;color:#2e7d32}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  font-size:14px;
}
th{background:#eef5ee}
.right{text-align:right}
.highlight{
  background:#e8f5e9;
  font-weight:700;
}

.unitCost{
  margin-top:10px;
  font-size:18px;
  font-weight:700;
  color:#2e7d32;
}

.reportBar{
  margin-top:20px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.reportBar a{
  background:#fff;
  border:2px solid #2e7d32;
  padding:8px 12px;
  font-weight:700;
  color:#2e7d32;
  text-decoration:none;
}

.footerNav{
  display:flex;
  justify-content:space-between;
  width:100%;
}

@media print{
  header, footer, .reportBar{display:none}
  body{background:#fff}
}
</style>
</head>

<body>

<!-- TOP NAV -->
<header>
  <a href="expense-demo.html">‚¨ÖÔ∏è Expense</a>
  <strong>üßÆ Production Cost Summary</strong>
  <a href="income-demo.html">‚û°Ô∏è Income</a>
</header>

<div class="container">

<h2>‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§≤‡§æ‡§ó‡§§ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ (Auto)</h2>
<p class="small">
‚ÑπÔ∏è ‡§Ø‡•ã ‡§≤‡§æ‡§ó‡§§ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ <b>expense-demo.html</b> ‡§Æ‡§æ ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü ‡§ñ‡§∞‡•ç‡§ö‡§π‡§∞‡•Ç‡§ï‡•ã ‡§Ü‡§ß‡§æ‡§∞‡§Æ‡§æ
‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§∏‡•ç‡§µ‡§ö‡§æ‡§≤‡§ø‡§§ ‡§∞‡•Ç‡§™‡§Æ‡§æ ‡§ó‡§£‡§®‡§æ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§π‡•ã‡•§
</p>

<div id="tables"></div>

<!-- REPORT LINKS (NEW TAB) -->
<div class="reportBar">
  <a href="production-report.html" target="_blank">üì¶ Production Report</a>
  <a href="production-chart.html" target="_blank">üìà Production Chart</a>
  <a href="expense-report.html" target="_blank">üí∞ Expense Report</a>
  <a href="profit-loss.html" target="_blank">üìä Profit ‚Äì Loss</a>
</div>

</div>

<!-- BOTTOM NAV -->
<footer>
  <div class="footerNav">
    <a href="expense-demo.html">‚¨ÖÔ∏è Expense</a>
    <span class="small">
      FarmerBase BP Engine ‚Äì Expense ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§≤‡§æ‡§ó‡§§ ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä
    </span>
    <a href="income-demo.html">‚û°Ô∏è Income</a>
  </div>
</footer>

<script>
/* ==================================
   PRODUCTION COST SUMMARY (AUTO)
   ================================== */

const key = localStorage.getItem("activeProject");
if(!key){ alert("Active ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§≠‡•á‡§ü‡§ø‡§è‡§®"); }

const project = JSON.parse(localStorage.getItem(key)) || {};
const expenses = project.expenses || [];
const products = project.productionProducts || [];

/* -------- allocation helper -------- */
function allocateExpenseToProduct(exp, product){
  if(exp.allocationType==="LS"){
    return exp.amount / products.length;
  }
  if(exp.allocationType==="DIRECT"){
    return exp.appliesTo?.includes(product.id) ? exp.amount : 0;
  }
  if(exp.allocationType==="%"){
    const p = exp.allocationPercent?.[product.id] || 0;
    return exp.amount * (p/100);
  }
  return 0;
}

/* -------- render -------- */
function render(){
  tables.innerHTML="";

  if(products.length===0){
    tables.innerHTML="<p>‚ùó Production ‡§Æ‡§æ ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§≠‡•á‡§ü‡§ø‡§è‡§®‡•§</p>";
    return;
  }

  products.forEach(prod=>{
    let variable=0, fixed=0;

    expenses.forEach(e=>{
      const alloc = allocateExpenseToProduct(e, prod);
      if(
        e.category==="‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞ ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£" ||
        e.category==="‡§Æ‡•á‡§∂‡§ø‡§® ‡§î‡§ú‡§æ‡§∞"
      ){
        fixed += alloc;
      }else{
        variable += alloc;
      }
    });

    const total = variable + fixed;
    const unitCost =
      prod.qty && prod.qty>0 ? (total / prod.qty) : 0;

    tables.innerHTML += `
    <div class="costBox">

      <div class="costTitle">
        <h3>${prod.name}</h3>
        <span class="costBadge badge-total">‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§ó‡§§</span>
      </div>

      <table>
        <tr>
          <th>‡§≤‡§æ‡§ó‡§§ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</th>
          <th class="right">‡§∞‡§ï‡§Æ (‡§∞‡•Å)</th>
        </tr>
        <tr>
          <td>‡§ö‡§æ‡§≤‡•Å ‡§≤‡§æ‡§ó‡§§ (Variable)</td>
          <td class="right highlight">${variable.toFixed(2)}</td>
        </tr>
        <tr>
          <td>‡§∏‡•ç‡§•‡§ø‡§∞ ‡§≤‡§æ‡§ó‡§§ (Fixed)</td>
          <td class="right highlight">${fixed.toFixed(2)}</td>
        </tr>
        <tr class="highlight">
          <th>‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§ó‡§§</th>
          <th class="right">${total.toFixed(2)}</th>
        </tr>
      </table>

      <div class="unitCost">
        ‡§™‡•ç‡§∞‡§§‡§ø ${prod.unit || "‡§á‡§ï‡§æ‡§à"} ‡§≤‡§æ‡§ó‡§§ :
        ‡§∞‡•Å ${unitCost.toFixed(2)}
      </div>

    </div>`;
  });
}

render();
</script>

</body>
</html>
