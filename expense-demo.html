<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Expense Detail | Farmer Base BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;margin:0
}
header,footer{
  background:#e8f5e9;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:14px
}
header a, footer a{
  text-decoration:none;
  color:#2e7d32;
  font-weight:600
}
.wrap{
  max-width:1100px;margin:18px auto;
  background:#fff;padding:22px;border-radius:12px
}
h2{color:#2e7d32;margin-top:0}
h3{margin-bottom:6px;color:#1565c0}

/* FORM */
.form{
  display:grid;
  grid-template-columns:1.5fr 2fr 2fr 1fr 1fr auto;
  gap:8px;margin-bottom:12px
}
input,select,textarea{
  padding:8px;font-family:inherit
}
textarea{width:100%;resize:vertical}
button.add{
  background:#2e7d32;color:#fff;border:none;
  border-radius:6px;padding:8px 14px;cursor:pointer
}
button.add.editing{background:#ef6c00}

/* TABLE */
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:right}
th{background:#eef5ee}
.left{text-align:left}
.cat{background:#e8f5e9;font-weight:700}
.subcat{background:#f1f8f4;font-weight:600}
.sum{background:#fafafa;font-weight:700}
.ed{background:#1976d2;color:#fff;border:none;padding:4px 8px;border-radius:4px}
.del{background:#c62828;color:#fff;border:none;padding:4px 8px;border-radius:4px}

.note{font-size:13px;color:#555;margin-top:8px}
</style>
</head>

<body>

<header>
  <a href="index.html">ЁЯПа Back to Home</a>
  <div>
    <a href="income-demo.html">тЧАя╕П Income</a> |
    <a href="profit-loss-demo.html">ProfitтАУLoss тЦ╢я╕П</a>
  </div>
</header>

<div class="wrap">

<h2>ЁЯТ░ рдЦрд░реНрдЪ рд╡рд┐рд╡рд░рдг (рд╡рд╛рд░реНрд╖рд┐рдХ)</h2>

<!-- ===== NARRATION ===== -->
<h3>ЁЯУЭ рдЦрд░реНрдЪ рд╕рдореНрдмрдиреНрдзреА рд╡реНрдпрд╛рдЦреНрдпрд╛ (Narration)</h3>
<textarea id="narration" rows="4"
placeholder="рдпрд╣рд╛рдБ рдЖрдлреНрдиреЛ рд╡реНрдпрд╡рд╕рд╛рдпрдХреЛ рдЦрд░реНрдЪ рд╕рдореНрдмрдиреНрдзреА рд╕рдордЧреНрд░ рд╡реНрдпрд╛рдЦреНрдпрд╛ рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН...">
рдпрд╕ рд╡реНрдпрд╡рд╕рд╛рдп рд╕рдЮреНрдЪрд╛рд▓рдирдХрд╛ рдХреНрд░рдордорд╛ рдЪрд╛рд▓реБ рдЦрд░реНрдЪ рд░ рд╕реНрдерд┐рд░ рдЦрд░реНрдЪ рджреБрд╡реИ рдкреНрд░рдХрд╛рд░рдХрд╛ рдЦрд░реНрдЪрд╣рд░реВ рд╣реБрдиреЗрдЫрдиреНред рдЪрд╛рд▓реБ рдЦрд░реНрдЪ рдЙрддреНрдкрд╛рджрди рд░ рдмрд┐рдХреНрд░реАрд╕рдБрдЧ рдкреНрд░рддреНрдпрдХреНрд╖ рд╕рдореНрдмрдиреНрдзрд┐рдд рд╣реБрдиреЗрдЫрдиреН рднрдиреЗ рд╕реНрдерд┐рд░ рдЦрд░реНрдЪ рджреАрд░реНрдШрдХрд╛рд▓реАрди рд╕рдореНрдкрддреНрддрд┐рд╕рдБрдЧ рд╕рдореНрдмрдиреНрдзрд┐рдд рд░рд╣рдиреЗрдЫрдиреНред
</textarea>

<hr>

<!-- ===== ENTRY FORM ===== -->
<div class="form">
  <select id="mainCat">
    <option value="рдЪрд╛рд▓реБ рдЦрд░реНрдЪ">рдЪрд╛рд▓реБ рдЦрд░реНрдЪ</option>
    <option value="рд╕реНрдерд┐рд░ рдЦрд░реНрдЪ">рд╕реНрдерд┐рд░ рдЦрд░реНрдЪ</option>
  </select>

  <input id="subCat" placeholder="Sub-Category (рдЬрд╕реНрддреИ: рджрд╛рдирд╛, рдордЬрджреБрд░реА, рдЧреЛрда рдирд┐рд░реНрдорд╛рдг)">
  <input id="title" placeholder="рдЦрд░реНрдЪ рд╢реАрд░реНрд╖рдХ">
  <input id="qty" type="number" placeholder="рдкрд░рд┐рдорд╛рдг">
  <input id="rate" type="number" placeholder="рджрд░">
  <button id="addBtn" class="add" onclick="addOrUpdate()">+ Add</button>
</div>

<!-- ===== TABLE ===== -->
<table>
<thead>
<tr>
  <th class="left">рд╢реАрд░реНрд╖рдХ</th>
  <th>рдкрд░рд┐рдорд╛рдг</th>
  <th>рджрд░</th>
  <th>рд░рдХрдо</th>
  <th></th>
</tr>
</thead>
<tbody id="body"></tbody>
<tfoot>
<tr class="sum">
  <td colspan="3" class="left">рдХреБрд▓ рдЪрд╛рд▓реБ рдЦрд░реНрдЪ</td>
  <td id="cashTotal">0</td><td></td>
</tr>
<tr class="sum">
  <td colspan="3" class="left">рд╣реНрд░рд╛рд╕рдХрдЯреНрдЯреА (резрел%)</td>
  <td id="deprTotal">0</td><td></td>
</tr>
</tfoot>
</table>

<p class="note">
тЬФя╕П Sub-Category рд╡реНрдпрд╡рд╕рд╛рдпреА рдЖрдлреИрдВрд▓реЗ рдердкреНрди рд╕рдХреНрдиреЗ<br>
тЬФя╕П Narration Proposal рд░ Annex рдорд╛ рд╕реНрд╡рддрдГ рдкреНрд░рдпреЛрдЧ рдЧрд░реНрди рдорд┐рд▓реНрдиреЗ
</p>

</div>

<footer>
  <a href="income-demo.html">тЧАя╕П Previous</a>
  <a href="profit-loss-demo.html">Next тЦ╢я╕П</a>
</footer>

<script>
/* ===== LOAD PROJECT ===== */
let key = localStorage.getItem("activeProject");
if(!key){ alert("рдкрд╣рд┐рд▓реЗ Project рдЦреЛрд▓реНрдиреБрд╣реЛрд╕реН"); location.href="index.html"; }
let project = JSON.parse(localStorage.getItem(key));
project.expenseData = project.expenseData || [];
project.expenseNarration = project.expenseNarration || "";
let expenses = project.expenseData;
let editId=null;

/* ===== ADD / UPDATE ===== */
function addOrUpdate(){
  if(!title.value) return;
  let amt=(Number(qty.value)||0)*(Number(rate.value)||0);

  if(editId){
    let e=expenses.find(x=>x.id===editId);
    Object.assign(e,{
      mainCat:mainCat.value,
      subCat:subCat.value,
      title:title.value,
      qty:qty.value,
      rate:rate.value,
      amount:amt
    });
    editId=null;
    addBtn.innerText="+ Add";
    addBtn.classList.remove("editing");
  }else{
    expenses.push({
      id:Date.now(),
      mainCat:mainCat.value,
      subCat:subCat.value,
      title:title.value,
      qty:qty.value,
      rate:rate.value,
      amount:amt
    });
  }
  title.value=qty.value=rate.value=subCat.value="";
  save();
}

/* ===== EDIT / DELETE ===== */
function editRow(id){
  let e=expenses.find(x=>x.id===id);
  if(!e) return;
  mainCat.value=e.mainCat;
  subCat.value=e.subCat;
  title.value=e.title;
  qty.value=e.qty;
  rate.value=e.rate;
  editId=id;
  addBtn.innerText="ЁЯТ╛ Update";
  addBtn.classList.add("editing");
}
function delRow(id){
  if(confirm("рд╣рдЯрд╛рдЙрдиреЗ ?")){
    expenses=expenses.filter(e=>e.id!==id);
    project.expenseData=expenses;
    save();
  }
}

/* ===== SAVE / RENDER ===== */
function save(){
  project.expenseData=expenses;
  project.expenseNarration=narration.value;
  localStorage.setItem(key,JSON.stringify(project));
  render();
}
function render(){
  body.innerHTML="";
  let cash=0,depr=0;

  let grouped={};
  expenses.forEach(e=>{
    grouped[e.mainCat]=grouped[e.mainCat]||{};
    grouped[e.mainCat][e.subCat]=grouped[e.mainCat][e.subCat]||[];
    grouped[e.mainCat][e.subCat].push(e);
  });

  for(let m in grouped){
    body.innerHTML+=`<tr class="cat"><td colspan="5">ЁЯФ╣ ${m}</td></tr>`;
    for(let s in grouped[m]){
      body.innerHTML+=`<tr class="subcat"><td colspan="5">тЦля╕П ${s}</td></tr>`;
      grouped[m][s].forEach(e=>{
        if(m==="рд╕реНрдерд┐рд░ рдЦрд░реНрдЪ") depr+=e.amount*0.15;
        else cash+=e.amount;
        body.innerHTML+=`
        <tr>
          <td class="left">${e.title}</td>
          <td>${e.qty}</td>
          <td>${e.rate}</td>
          <td>${Math.round(e.amount)}</td>
          <td>
            <button class="ed" onclick="editRow(${e.id})">тЬПя╕П</button>
            <button class="del" onclick="delRow(${e.id})">тЭМ</button>
          </td>
        </tr>`;
      });
    }
  }
  cashTotal.innerText=Math.round(cash);
  deprTotal.innerText=Math.round(depr);
}

/* INIT */
narration.oninput=save;
render();
</script>

</body>
</html>
