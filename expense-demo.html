<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>рдЦрд░реНрдЪ рд╡рд┐рд╡рд░рдг | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;
  margin:0;
}
header,footer{
  background:#e8f5e9;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header a,footer a{
  text-decoration:none;
  font-weight:700;
  color:#2e7d32;
}
.navAero a{margin:0 8px}
.container{
  max-width:1200px;
  margin:0 auto;
  padding:20px;
}
h2,h3{color:#2e7d32;margin:10px 0}
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  font-size:14px;
  vertical-align:top;
}
th{background:#eef5ee}
input,select,textarea{
  width:100%;
  padding:6px;
  box-sizing:border-box;
}
textarea{resize:vertical}
.addBtn{
  margin:10px 0;
  padding:8px 14px;
  background:#2e7d32;
  color:#fff;
  border:none;
  cursor:pointer;
}
.editBtn{color:#1565c0;cursor:pointer;font-weight:700}
.delBtn{color:#c62828;cursor:pointer;font-weight:700}
.small{font-size:13px;color:#555}
.right{text-align:right}
.allocBox{font-size:13px;margin-top:6px}
.footerBox{
  background:#fff;
  border:1px solid #ccc;
  padding:12px;
  margin-top:16px;
}
</style>
</head>

<body>

<!-- TOP NAV -->
<header>
  <div class="navAero">
    <a href="production.html">тмЕя╕П Production</a>
  </div>
  <div>
    <a href="index.html" target="_blank">ЁЯПа Home</a> |
    <a href="expense-report.html" target="_blank">ЁЯУК Expense Report</a>
  </div>
  <div class="navAero">
    <a href="income-demo.html">Income тЮбя╕П</a>
  </div>
</header>

<div class="container">

<h2>ЁЯТ░ рдЦрд░реНрдЪ рд╡рд┐рд╡рд░рдг (рд╡рд╛рд░реНрд╖рд┐рдХ)</h2>

<label><strong>тЬНя╕П рдЦрд░реНрдЪ рд╕рдореНрдмрдиреНрдзреА рд╡рд┐рд╡рд░рдг</strong></label>
<textarea id="expenseNarration" rows="3"></textarea>

<table>
<thead>
<tr>
  <th style="width:22%">рдЦрд░реНрдЪ рд╢реАрд░реНрд╖рдХ / рдиреЛрдЯ</th>
  <th style="width:14%">рдмрд░реНрдЧ</th>
  <th style="width:8%">рдкрд░рд┐рдорд╛рдг</th>
  <th style="width:10%">рджрд░</th>
  <th style="width:12%" class="right">рд░рдХрдо</th>
  <th style="width:24%">рдЙрддреНрдкрд╛рджрдирдорд╛ рдмрд╛рдБрдбрдлрд╛рдБрдЯ</th>
  <th style="width:10%">Action</th>
</tr>
</thead>
<tbody id="expenseBody"></tbody>
</table>

<button class="addBtn" onclick="addExpense()">тЮХ рдирдпрд╛рдБ рдЦрд░реНрдЪ</button>

<!-- SUMMARY -->
<div class="footerBox">
  <h3>ЁЯУК рдЦрд░реНрдЪ рд╕рд╛рд░рд╛рдВрд╢</h3>
  <table>
    <thead>
      <tr>
        <th>рд╢реАрд░реНрд╖рдХ</th>
        <th>рдкрд░рд┐рдорд╛рдг</th>
        <th>рджрд░</th>
        <th class="right">рд░рдХрдо</th>
      </tr>
    </thead>
    <tbody id="summaryBody"></tbody>
    <tfoot>
      <tr>
        <th colspan="3">рдХреБрд▓ рдЦрд░реНрдЪ</th>
        <th class="right" id="summaryTotal">0</th>
      </tr>
    </tfoot>
  </table>
</div>

<!-- DEPRECIATION -->
<div class="footerBox">
  <h3>ЁЯУЙ рд╣реНрд░рд╛рд╕рдХрдЯреНрдЯреА (Depreciation)</h3>
  <table>
    <tr>
      <th style="width:40%">рд╣реНрд░рд╛рд╕рдХрдЯреНрдЯреА рджрд░ (%)</th>
      <th>рд╡рд╛рд░реНрд╖рд┐рдХ рд╣реНрд░рд╛рд╕рдХрдЯреНрдЯреА рд░рдХрдо</th>
    </tr>
    <tr>
      <td><input type="number" id="depRate" value="10"></td>
      <td id="depAmount">0</td>
    </tr>
  </table>
</div>

</div>

<!-- BOTTOM NAV -->
<footer>
  <div class="navAero">
    <a href="production.html">тмЕя╕П Production</a>
  </div>
  <div class="small">
    FarmerBase BP Engine тАУ рд▓рд╛рдЧрдд рдмрд╛рдБрдбрдлрд╛рдБрдЯрд╕рд╣рд┐рдд рдЦрд░реНрдЪ рдкреНрд░рдгрд╛рд▓реА
  </div>
  <div class="navAero">
    <a href="income-demo.html">Income тЮбя╕П</a>
  </div>
</footer>

<script>
/* LOAD PROJECT */
const key = localStorage.getItem("activeProject");
if(!key){ alert("Active рдпреЛрдЬрдирд╛ рднреЗрдЯрд┐рдПрди"); }
let project = JSON.parse(localStorage.getItem(key)) || {};
project.expenses = project.expenses || [];
project.depRate = project.depRate || 10;
const products = project.productionProducts || [];

/* NARRATION */
expenseNarration.value = project.expenseNarration ||
"рдпрд╕ рд╡реНрдпрд╡рд╕рд╛рдп рд╕рдЮреНрдЪрд╛рд▓рдирдХрд╛ рд▓рд╛рдЧрд┐ рдЖрд╡рд╢реНрдпрдХ рдЪрд╛рд▓реБ рддрдерд╛ рд╕реНрдерд┐рд░ рдЦрд░реНрдЪрд╣рд░реВ рдпрдерд╛рд░реНрдердкрд░рдХ рд░реВрдкрдорд╛ рдЕрдиреБрдорд╛рди рдЧрд░рд┐рдПрдХреЛ рдЫред";
expenseNarration.oninput=()=>{
  project.expenseNarration=expenseNarration.value;
  save();
};

/* RENDER */
function render(){
  expenseBody.innerHTML="";
  project.expenses.forEach((e,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
<td>
  <input value="${e.title||""}" readonly>
  <textarea rows="2" oninput="upd(${i},'note',this.value)">${e.note||""}</textarea>
</td>

<td>
  <select onchange="upd(${i},'category',this.value)">
    <optgroup label="рдЪрд╛рд▓реБ рдЦрд░реНрдЪ">
      <option ${e.category==="рдХрдЪреНрдЪрд╛рдкрджрд╛рд░реНрде"?"selected":""}>рдХрдЪреНрдЪрд╛рдкрджрд╛рд░реНрде</option>
      <option ${e.category==="рдХрд╛рдорджрд╛рд░"?"selected":""}>рдХрд╛рдорджрд╛рд░</option>
      <option ${e.category==="рд╡рд┐рд╡рд┐рдз"?"selected":""}>рд╡рд┐рд╡рд┐рдз</option>
    </optgroup>
    <optgroup label="рд╕реНрдерд┐рд░ рдЦрд░реНрдЪ">
      <option ${e.category==="рдкреВрд░реНрд╡рд╛рдзрд╛рд░ рдирд┐рд░реНрдорд╛рдг"?"selected":""}>рдкреВрд░реНрд╡рд╛рдзрд╛рд░ рдирд┐рд░реНрдорд╛рдг</option>
      <option ${e.category==="рдореЗрд╢рд┐рди рдФрдЬрд╛рд░"?"selected":""}>рдореЗрд╢рд┐рди рдФрдЬрд╛рд░</option>
    </optgroup>
  </select>
</td>

<td><input type="number" value="${e.qty||0}" oninput="calc(${i},'qty',this.value)"></td>
<td><input type="number" value="${e.rate||0}" oninput="calc(${i},'rate',this.value)"></td>
<td class="right">${(e.amount||0).toFixed(2)}</td>

<td>
  <select onchange="setAllocType(${i},this.value)">
    <option value="LS" ${e.allocationType==="LS"?"selected":""}>LS (рд╕рдмреИ)</option>
    <option value="%" ${e.allocationType==="%"?"selected":""}>%</option>
    <option value="DIRECT" ${e.allocationType==="DIRECT"?"selected":""}>Direct</option>
  </select>
  <div class="allocBox">${renderAllocUI(i)}</div>
</td>

<td>
  <span class="editBtn" onclick="editExpense(${i})">тЬПя╕П</span>
  <span class="delBtn" onclick="delExpense(${i})">тЬЦ</span>
</td>
    `;
    expenseBody.appendChild(tr);
  });
  renderSummary();
  calcDep();
}

/* ADD */
function addExpense(){
  const t = prompt("рдЦрд░реНрдЪ рд╢реАрд░реНрд╖рдХ рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН:");
  if(!t) return;
  project.expenses.push({
    title:t,
    category:"рдХрдЪреНрдЪрд╛рдкрджрд╛рд░реНрде",
    qty:1,rate:0,amount:0,note:"",
    allocationType:"LS",
    appliesTo:["ALL"],
    allocationPercent:{}
  });
  save();render();
}

/* EDIT / DELETE */
function editExpense(i){
  const e=project.expenses[i];
  const t=prompt("рдЦрд░реНрдЪ рд╢реАрд░реНрд╖рдХ:",e.title);
  if(t===null) return;
  const n=prompt("рдиреЛрдЯ:",e.note||"");
  e.title=t; e.note=n;
  save();render();
}
function delExpense(i){
  if(!confirm("рдпреЛ рдЦрд░реНрдЪ рд╣рдЯрд╛рдЙрдиреЗ ?")) return;
  project.expenses.splice(i,1);
  save();render();
}

/* UPDATE */
function upd(i,f,v){project.expenses[i][f]=v;save()}
function calc(i,f,v){
  project.expenses[i][f]=Number(v)||0;
  const e=project.expenses[i];
  e.amount=(Number(e.qty)||0)*(Number(e.rate)||0);
  save();render();
}

/* ALLOCATION */
function setAllocType(i,v){
  const e=project.expenses[i];
  e.allocationType=v;
  if(v==="LS"){ e.appliesTo=["ALL"]; e.allocationPercent={}; }
  if(v==="DIRECT"){ e.appliesTo=[products[0]?.id]; }
  if(v==="%"){ e.appliesTo=products.map(p=>p.id); }
  save();render();
}
function renderAllocUI(i){
  const e=project.expenses[i];
  if(products.length===0) return "рдЙрддреНрдкрд╛рджрди рдЫреИрди";
  if(e.allocationType==="LS") return "тЬФя╕П рд╕рдмреИ рдЙрддреНрдкрд╛рджрдирдорд╛ рдкрд░рд┐рдорд╛рдг рдЕрдиреБрд╕рд╛рд░";

  let html="";
  products.forEach(p=>{
    if(e.allocationType==="DIRECT"){
      html+=`
<label>
<input type="radio" name="d${i}"
${e.appliesTo[0]===p.id?"checked":""}
onchange="setDirect(${i},'${p.id}')"> ${p.name}
</label><br>`;
    }else{
      const v=e.allocationPercent[p.id]||0;
      html+=`${p.name}
<input type="number" style="width:60px"
value="${v}"
oninput="setPercent(${i},'${p.id}',this.value)"> %<br>`;
    }
  });
  return html;
}
function setDirect(i,pid){
  project.expenses[i].appliesTo=[pid];
  save();
}
function setPercent(i,pid,val){
  project.expenses[i].allocationPercent[p.id]=Number(val)||0;
  save();
}

/* SUMMARY */
function renderSummary(){
  summaryBody.innerHTML="";
  let tot=0;
  project.expenses.forEach(e=>{
    tot+=Number(e.amount)||0;
    summaryBody.innerHTML+=`
<tr>
<td>${e.title}</td>
<td>${e.qty}</td>
<td>${e.rate}</td>
<td class="right">${(e.amount||0).toFixed(2)}</td>
</tr>`;
  });
  summaryTotal.innerText=tot.toFixed(2);
}

/* DEPRECIATION */
depRate.value=project.depRate;
depRate.oninput=()=>{project.depRate=Number(depRate.value)||0;save();calcDep()}
function calcDep(){
  let fixed=0;
  project.expenses.forEach(e=>{
    if(e.category==="рдкреВрд░реНрд╡рд╛рдзрд╛рд░ рдирд┐рд░реНрдорд╛рдг"||e.category==="рдореЗрд╢рд┐рди рдФрдЬрд╛рд░"){
      fixed+=Number(e.amount)||0;
    }
  });
  depAmount.innerText=(fixed*(project.depRate/100)).toFixed(2);
}

/* SAVE */
function save(){
  localStorage.setItem(key,JSON.stringify(project));
}

/* INIT */
render();
</script>

</body>
</html>
