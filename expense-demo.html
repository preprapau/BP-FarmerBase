<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>‡§ñ‡§∞‡•ç‡§ö ‡§µ‡§ø‡§µ‡§∞‡§£ (‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï) | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;
  margin:0;
}
header{
  background:#e8f5e9;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header a{
  text-decoration:none;
  font-weight:700;
  color:#2e7d32;
}
.container{
  max-width:1100px;
  margin:0 auto;
  padding:20px;
}
h2,h3{
  color:#2e7d32;
  margin:10px 0;
}
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  font-size:14px;
}
th{
  background:#eef5ee;
}
input,select,textarea{
  width:100%;
  box-sizing:border-box;
  padding:6px;
  font-size:14px;
}
textarea{ resize:vertical }
.addBtn{
  margin:10px 0;
  padding:8px 14px;
  background:#2e7d32;
  color:#fff;
  border:none;
  cursor:pointer;
}
.delBtn{
  color:#c62828;
  font-weight:700;
  cursor:pointer;
  text-align:center;
}
.footerBox{
  background:#fff;
  border:1px solid #ccc;
  padding:12px;
  margin-top:16px;
}
.small{ font-size:13px;color:#555 }
</style>
</head>

<body>

<header>
  <a href="index.html" target="_blank">üè† Home</a>
  <a href="expense-summary.html" target="_blank">üìÑ Summary / Print</a>
</header>

<div class="container">

<h2>üí∞ ‡§ñ‡§∞‡•ç‡§ö ‡§µ‡§ø‡§µ‡§∞‡§£ (‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï)</h2>

<!-- ===== OVERALL NARRATION ===== -->
<label><strong>‚úçÔ∏è ‡§ñ‡§∞‡•ç‡§ö ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£</strong></label>
<textarea id="expenseNarration" rows="3"></textarea>

<!-- ===== EXPENSE TABLE ===== -->
<table>
<thead>
<tr>
  <th>‡§ñ‡§∞‡•ç‡§ö ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th>
  <th>‡§¨‡§∞‡•ç‡§ó</th>
  <th style="width:90px">‡§™‡§∞‡§ø‡§Æ‡§æ‡§£</th>
  <th style="width:110px">‡§¶‡§∞</th>
  <th style="width:130px;text-align:right">‡§∞‡§ï‡§Æ</th>
  <th>‚ùå</th>
</tr>
</thead>
<tbody id="expenseBody"></tbody>
</table>

<button class="addBtn" onclick="addExpense()">‚ûï ‡§®‡§Ø‡§æ‡§Å ‡§ñ‡§∞‡•ç‡§ö</button>

<!-- ===== SUMMARY ===== -->
<div class="footerBox">
  <h3>üìä ‡§ñ‡§∞‡•ç‡§ö ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</h3>
  <table>
    <thead>
      <tr>
        <th>‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th>
        <th>‡§™‡§∞‡§ø‡§Æ‡§æ‡§£</th>
        <th>‡§¶‡§∞</th>
        <th style="text-align:right">‡§∞‡§ï‡§Æ</th>
      </tr>
    </thead>
    <tbody id="summaryBody"></tbody>
    <tfoot>
      <tr>
        <th colspan="3">‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö</th>
        <th style="text-align:right" id="summaryTotal">0</th>
      </tr>
    </tfoot>
  </table>
</div>

<!-- ===== DEPRECIATION ===== -->
<div class="footerBox">
  <h3>üìâ ‡§π‡•ç‡§∞‡§æ‡§∏‡§ï‡§ü‡•ç‡§ü‡•Ä (Depreciation)</h3>
  <div class="small">‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö (‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞ / ‡§Æ‡•á‡§∂‡•Ä‡§®) ‡§Æ‡§æ ‡§Æ‡§æ‡§§‡•ç‡§∞ ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•Å‡§®‡•ç‡§õ</div>
  <table>
    <tr>
      <th>‡§π‡•ç‡§∞‡§æ‡§∏‡§ï‡§ü‡•ç‡§ü‡•Ä ‡§¶‡§∞ (%)</th>
      <th>‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§π‡•ç‡§∞‡§æ‡§∏‡§ï‡§ü‡•ç‡§ü‡•Ä ‡§∞‡§ï‡§Æ (‡§∞‡•Å)</th>
    </tr>
    <tr>
      <td><input type="number" id="depRate" value="10"></td>
      <td id="depAmount">0</td>
    </tr>
  </table>
</div>

</div>

<script>
/* ================= LOAD PROJECT ================= */
const key = localStorage.getItem("activeProject");
if(!key){ alert("Active ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§≠‡•á‡§ü‡§ø‡§è‡§®"); }

let project = JSON.parse(localStorage.getItem(key)) || {};
project.expenses = project.expenses || [];
project.depRate = project.depRate || 10;

/* ================= DEFAULT NARRATION ================= */
if(!project.expenseNarration){
  project.expenseNarration =
    "‡§Ø‡§∏ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§∏‡§û‡•ç‡§ö‡§æ‡§≤‡§®‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ö‡§æ‡§≤‡•Å ‡§§‡§•‡§æ ‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö‡§π‡§∞‡•Ç ‡§Ø‡§•‡§æ‡§∞‡•ç‡§•‡§™‡§∞‡§ï ‡§∞‡•Ç‡§™‡§Æ‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§® ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ‡•§";
}
expenseNarration.value = project.expenseNarration;
expenseNarration.oninput = ()=>{
  project.expenseNarration = expenseNarration.value;
  save();
};

/* ================= BUDGET CODE ================= */
function generateBudgetCode(category){
  if(category.includes("‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞")) return "FX-INF-"+Date.now().toString().slice(-4);
  if(category.includes("‡§Æ‡•á‡§∂‡•Ä‡§®")) return "FX-MAC-"+Date.now().toString().slice(-4);
  return "OP-OTH-"+Date.now().toString().slice(-4);
}

/* ================= RENDER ================= */
function render(){
  expenseBody.innerHTML="";
  project.expenses.forEach((e,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>
        <input value="${e.title||""}" readonly>
        <textarea rows="2"
          oninput="upd(${i},'note',this.value)">${e.note||"‡§Ø‡§∏ ‡§ñ‡§∞‡•ç‡§ö‡§ï‡•ã ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£"}</textarea>
      </td>
      <td>
        <select onchange="upd(${i},'category',this.value)">
          <optgroup label="üîµ ‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö">
            <option ${e.category==="‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞ ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£"?"selected":""}>‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞ ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£</option>
            <option ${e.category==="‡§Æ‡•á‡§∂‡•Ä‡§® ‡§î‡§ú‡§æ‡§∞"?"selected":""}>‡§Æ‡•á‡§∂‡•Ä‡§® ‡§î‡§ú‡§æ‡§∞</option>
            <option ${e.category==="‡§Ö‡§®‡•ç‡§Ø (‡§∏‡•ç‡§•‡§ø‡§∞)"?"selected":""}>‡§Ö‡§®‡•ç‡§Ø (‡§∏‡•ç‡§•‡§ø‡§∞)</option>
          </optgroup>
          <optgroup label="üü¢ ‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö">
            <option ${e.category==="‡§ï‡§ö‡•ç‡§ö‡§æ‡§™‡§¶‡§æ‡§∞‡•ç‡§•"?"selected":""}>‡§ï‡§ö‡•ç‡§ö‡§æ‡§™‡§¶‡§æ‡§∞‡•ç‡§•</option>
            <option ${e.category==="‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ / ‡§Æ‡§ú‡§¶‡•Å‡§∞‡•Ä"?"selected":""}>‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ / ‡§Æ‡§ú‡§¶‡•Å‡§∞‡•Ä</option>
            <option ${e.category==="‡§µ‡§ø‡§µ‡§ø‡§ß"?"selected":""}>‡§µ‡§ø‡§µ‡§ø‡§ß</option>
            <option ${e.category==="‡§Ö‡§®‡•ç‡§Ø (‡§ö‡§æ‡§≤‡•Å)"?"selected":""}>‡§Ö‡§®‡•ç‡§Ø (‡§ö‡§æ‡§≤‡•Å)</option>
          </optgroup>
        </select>
      </td>
      <td><input type="number" value="${e.qty||0}"
        oninput="calc(${i},'qty',this.value)"></td>
      <td><input type="number" value="${e.rate||0}"
        oninput="calc(${i},'rate',this.value)"></td>
      <td style="text-align:right">${(e.amount||0).toFixed(2)}</td>
      <td class="delBtn" onclick="del(${i})">‚úñ</td>
    `;
    expenseBody.appendChild(tr);
  });
  renderSummary();
  calcDepreciation();
}

/* ================= CRUD ================= */
function addExpense(){
  const title = prompt("‡§ñ‡§∞‡•ç‡§ö ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç:");
  if(!title) return;

  project.expenses.push({
    title:title,
    category:"‡§ï‡§ö‡•ç‡§ö‡§æ‡§™‡§¶‡§æ‡§∞‡•ç‡§•",
    qty:1,
    rate:0,
    amount:0,
    note:"‡§Ø‡§∏ ‡§ñ‡§∞‡•ç‡§ö‡§ï‡•ã ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£",
    budgetCode:generateBudgetCode("‡§ï‡§ö‡•ç‡§ö‡§æ‡§™‡§¶‡§æ‡§∞‡•ç‡§•")
  });
  save(); render();
}

function upd(i,f,v){
  project.expenses[i][f]=v;
  save();
}

function calc(i,f,v){
  project.expenses[i][f]=Number(v)||0;
  const q=Number(project.expenses[i].qty)||0;
  const r=Number(project.expenses[i].rate)||0;
  project.expenses[i].amount=q*r;
  save(); render();
}

function del(i){
  if(!confirm("‡§Ø‡•ã ‡§ñ‡§∞‡•ç‡§ö ‡§π‡§ü‡§æ‡§â‡§®‡•á ?")) return;
  project.expenses.splice(i,1);
  save(); render();
}

/* ================= SUMMARY ================= */
function renderSummary(){
  summaryBody.innerHTML="";
  let total=0, lastCat="";
  project.expenses.forEach(e=>{
    const amt=Number(e.amount)||0;
    total+=amt;
    if(e.category!==lastCat){
      const r=document.createElement("tr");
      r.innerHTML=`<td colspan="4" style="background:#eef5ee;font-weight:700">
        ‚óº ${e.category}</td>`;
      summaryBody.appendChild(r);
      lastCat=e.category;
    }
    const tr=document.createElement("tr");
    tr.dataset.budgetCode=e.budgetCode||"";
    tr.innerHTML=`
      <td>${e.title}</td>
      <td>${e.qty}</td>
      <td>${e.rate}</td>
      <td style="text-align:right">${amt.toFixed(2)}</td>`;
    summaryBody.appendChild(tr);
  });
  summaryTotal.innerText=total.toFixed(2);
}

/* ================= DEPRECIATION ================= */
depRate.oninput=()=>{
  project.depRate=Number(depRate.value)||0;
  save(); calcDepreciation();
};
function calcDepreciation(){
  let fixed=0;
  project.expenses.forEach(e=>{
    if(e.category.includes("‡§∏‡•ç‡§•‡§ø‡§∞")||e.category.includes("‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞")||e.category.includes("‡§Æ‡•á‡§∂‡•Ä‡§®")){
      fixed+=Number(e.amount)||0;
    }
  });
  depAmount.innerText=(fixed*(project.depRate/100)).toFixed(2);
}

/* ================= PRODUCTION COST LOGIC (READY) ================= */
/*
  Production page must provide:
  project.productionProducts = [
    { id:"cauliflower", name:"‡§ï‡§æ‡§â‡§≤‡•Ä", qty:6000 },
    { id:"potato", name:"‡§Ü‡§≤‡•Å", qty:4000 }
  ];

  Unit cost per product =
   (Operating Cost + Annual Depreciation)
    √ó (product.qty / totalQty)
    √∑ product.qty
*/

/* ================= SAVE ================= */
function save(){
  localStorage.setItem(key,JSON.stringify(project));
}

/* INIT */
render();
</script>

</body>
</html>
