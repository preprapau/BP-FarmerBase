<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>‡§ñ‡§∞‡•ç‡§ö ‡§µ‡§ø‡§µ‡§∞‡§£ | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;
  margin:0;
}
header{
  background:#e8f5e9;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header a{
  text-decoration:none;
  font-weight:700;
  color:#2e7d32;
}
.container{
  max-width:1000px;
  margin:0 auto;
  padding:20px;
}
h2{
  margin-top:0;
  color:#2e7d32;
}
textarea{
  width:100%;
  box-sizing:border-box;
  padding:10px;
  font-size:14px;
  margin:6px 0 12px;
}
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  font-size:14px;
}
th{
  background:#eef5ee;
  text-align:left;
}
input,select{
  width:100%;
  box-sizing:border-box;
  padding:6px;
  font-size:14px;
}
.addBtn{
  margin-top:10px;
  padding:8px 14px;
  background:#2e7d32;
  color:#fff;
  border:none;
  cursor:pointer;
}
.note{
  font-size:13px;
  color:#2e7d32;
  margin-top:8px;
}
</style>
</head>

<body>

<header>
  <a href="index.html" target="_blank">üè† Home</a>
  <a href="expense-summary.html" target="_blank">üìÑ Summary / Print</a>
</header>

<div class="container">

<h2>üí∞ ‡§ñ‡§∞‡•ç‡§ö ‡§µ‡§ø‡§µ‡§∞‡§£ (‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï)</h2>

<!-- ===== EXPENSE NARRATION ===== -->
<label><strong>‚úçÔ∏è ‡§ñ‡§∞‡•ç‡§ö ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£ (Editable)</strong></label>
<textarea id="expenseNarration" rows="4"
  placeholder="‡§Ø‡§π‡§æ‡§Å ‡§ñ‡§∞‡•ç‡§ö ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡•Ä ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç..."></textarea>

<!-- ===== EXPENSE TABLE ===== -->
<table>
<thead>
<tr>
  <th>‡§ñ‡§∞‡•ç‡§ö ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th>
  <th>‡§¨‡§∞‡•ç‡§ó</th>
  <th style="text-align:right">‡§∞‡§ï‡§Æ (‡§∞‡•Å)</th>
</tr>
</thead>
<tbody id="expenseBody"></tbody>
</table>

<button class="addBtn" onclick="addExpense()">‚ûï ‡§®‡§Ø‡§æ‡§Å ‡§ñ‡§∞‡•ç‡§ö</button>

<p class="note">‚úîÔ∏è ‡§∏‡§¨‡•à ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§∏‡•ç‡§µ‡§§‡§É ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§π‡•Å‡§®‡•ç‡§õ (Auto-Save)</p>

</div>

<script>
/* ===== Load Project ===== */
const key = localStorage.getItem("activeProject");
if(!key){
  alert("Active ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§≠‡•á‡§ü‡§ø‡§è‡§®");
}
let project = JSON.parse(localStorage.getItem(key)) || {};
project.expenses = project.expenses || [];

/* ===== Default Narration ===== */
if(!project.expenseNarration){
  project.expenseNarration =
    "‡§Ø‡§∏ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§∏‡§û‡•ç‡§ö‡§æ‡§≤‡§®‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ö‡§æ‡§≤‡•Å ‡§§‡§•‡§æ ‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö‡§π‡§∞‡•Ç ‡§Ø‡§•‡§æ‡§∞‡•ç‡§•‡§™‡§∞‡§ï ‡§∞‡•Ç‡§™‡§Æ‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§® ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ‡•§ " +
    "‡§ñ‡§∞‡•ç‡§ö‡§π‡§∞‡•Ç ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø‡§ï‡•ã ‡§™‡•ç‡§∞‡§ï‡•É‡§§‡§ø, ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ ‡§∞ ‡§¨‡§ú‡§æ‡§∞ ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ‡§≤‡§æ‡§à ‡§ß‡•ç‡§Ø‡§æ‡§®‡§Æ‡§æ ‡§∞‡§æ‡§ñ‡•Ä ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§£ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§π‡•ã‡•§";
  saveProject();
}
expenseNarration.value = project.expenseNarration;

/* ===== Narration Save ===== */
expenseNarration.addEventListener("input",()=>{
  project.expenseNarration = expenseNarration.value;
  saveProject();
});

/* ===== Budget Code Generator ===== */
function generateBudgetCode(category){
  let prefix="OP-OTH";
  if(category.includes("‡§ï‡§ö‡•ç‡§ö‡§æ")) prefix="OP-RAW";
  else if(category.includes("‡§Æ‡§ú‡§¶‡•Å‡§∞‡•Ä")) prefix="OP-LAB";
  else if(category.includes("‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞")) prefix="FX-INF";
  else if(category.includes("‡§Æ‡•á‡§∂‡•Ä‡§®")) prefix="FX-MAC";
  return prefix+"-"+Date.now().toString().slice(-4);
}

/* ===== Ensure Budget Codes ===== */
function ensureBudgetCodes(){
  project.expenses.forEach(e=>{
    if(!e.budgetCode){
      e.budgetCode = generateBudgetCode(e.category||"");
    }
  });
  saveProject();
}

/* ===== Render ===== */
function renderExpenses(){
  expenseBody.innerHTML="";
  project.expenses.forEach((e,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>
        <input value="${e.title||""}"
          oninput="updateExpense(${i},'title',this.value)">
      </td>
      <td>
        <select onchange="updateExpense(${i},'category',this.value)">
          <optgroup label="üîµ ‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ñ‡§∞‡•ç‡§ö">
            <option ${e.category==="‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞ ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£"?"selected":""}>‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞ ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£</option>
            <option ${e.category==="‡§Æ‡•á‡§∂‡•Ä‡§® ‡§î‡§ú‡§æ‡§∞"?"selected":""}>‡§Æ‡•á‡§∂‡•Ä‡§® ‡§î‡§ú‡§æ‡§∞</option>
            <option ${e.category==="‡§Ö‡§®‡•ç‡§Ø (‡§∏‡•ç‡§•‡§ø‡§∞)"?"selected":""}>‡§Ö‡§®‡•ç‡§Ø (‡§∏‡•ç‡§•‡§ø‡§∞)</option>
          </optgroup>
          <optgroup label="üü¢ ‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö">
            <option ${e.category==="‡§ï‡§ö‡•ç‡§ö‡§æ‡§™‡§¶‡§æ‡§∞‡•ç‡§•"?"selected":""}>‡§ï‡§ö‡•ç‡§ö‡§æ‡§™‡§¶‡§æ‡§∞‡•ç‡§•</option>
            <option ${e.category==="‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ / ‡§Æ‡§ú‡§¶‡•Å‡§∞‡•Ä"?"selected":""}>‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ / ‡§Æ‡§ú‡§¶‡•Å‡§∞‡•Ä</option>
            <option ${e.category==="‡§µ‡§ø‡§µ‡§ø‡§ß"?"selected":""}>‡§µ‡§ø‡§µ‡§ø‡§ß</option>
            <option ${e.category==="‡§Ö‡§®‡•ç‡§Ø (‡§ö‡§æ‡§≤‡•Å)"?"selected":""}>‡§Ö‡§®‡•ç‡§Ø (‡§ö‡§æ‡§≤‡•Å)</option>
          </optgroup>
        </select>
      </td>
      <td>
        <input type="number" value="${e.amount||0}"
          style="text-align:right"
          oninput="updateExpense(${i},'amount',this.value)">
      </td>
    `;
    expenseBody.appendChild(tr);
  });
}

/* ===== CRUD ===== */
function addExpense(){
  project.expenses.push({
    title:"",
    category:"‡§ï‡§ö‡•ç‡§ö‡§æ‡§™‡§¶‡§æ‡§∞‡•ç‡§•",
    amount:0,
    budgetCode:generateBudgetCode("‡§ï‡§ö‡•ç‡§ö‡§æ‡§™‡§¶‡§æ‡§∞‡•ç‡§•")
  });
  saveProject();
  renderExpenses();
}

function updateExpense(i,f,v){
  project.expenses[i][f]=f==="amount"?Number(v):v;
  saveProject();
}

/* ===== Save ===== */
function saveProject(){
  localStorage.setItem(key,JSON.stringify(project));
}

/* Init */
ensureBudgetCodes();
renderExpenses();
</script>

</body>
</html>
