<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>‡§ñ‡§∞‡•ç‡§ö ‡§µ‡§ø‡§µ‡§∞‡§£ | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;margin:0
}
header{
  background:#e8f5e9;
  padding:12px 18px;
  display:flex;
  justify-content:space-between;
  font-size:16px;
}
header a{color:#2e7d32;font-weight:700;text-decoration:none}

.wrap{
  max-width:1200px;
  margin:20px auto;
  background:#fff;
  padding:24px;
  border-radius:14px;
}

h2,h3{
  color:#2e7d32;
  margin-top:0;
}
.small{font-size:14px;color:#555}

button{
  padding:8px 16px;
  border:none;
  border-radius:8px;
  background:#2e7d32;
  color:#fff;
  cursor:pointer;
  font-size:14px;
}
.gray{background:#607d8b}
.red{background:#c62828}
.blue{background:#0277bd}

.card{
  border:1px solid #c8e6c9;
  border-radius:14px;
  margin-bottom:22px;
}
.cardHead{
  background:#f1f8e9;
  padding:14px 18px;
  display:flex;
  justify-content:space-between;
  cursor:pointer;
  font-size:18px;
}
.cardBody{
  padding:18px;
}

.row{
  display:grid;
  grid-template-columns:2fr 1.4fr 1fr 1fr 1fr 1.2fr;
  gap:10px;
  margin-bottom:12px;
}
input,select,textarea{
  padding:8px;
  width:100%;
  font-size:15px;
}

.item{
  display:grid;
  grid-template-columns:2fr 1.4fr 1fr 1fr 1fr 1fr auto auto;
  gap:10px;
  margin-bottom:10px;
  align-items:center;
}
.item input:disabled{
  background:#f5f5f5;
  border:1px solid #ddd;
}
hr{margin:18px 0}
</style>
</head>

<body>

<header>
  <a href="production.html">‚¨Ö Production</a>
  <strong>‡§ñ‡§∞‡•ç‡§ö ‡§µ‡§ø‡§µ‡§∞‡§£ (Expense)</strong>
  <a href="income-demo.html">‚û° Income</a>
</header>

<div class="wrap">

<div id="expenseRoot"></div>

<hr>

<h2>üìù ‡§∏‡§Æ‡§ó‡•ç‡§∞ ‡§ñ‡§∞‡•ç‡§ö Narration</h2>
<textarea id="expenseNarration" rows="4"
  placeholder="‡§∏‡§Æ‡§ó‡•ç‡§∞ ‡§ñ‡§∞‡•ç‡§ö‡§ï‡•ã ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§Ø‡§π‡§æ‡§Å ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç..."></textarea>
<br><br>
<button class="gray" onclick="autoNarration()">‚ú® Auto Narration</button>

</div>

<script>
/* ===== STORAGE ===== */
const KEY="FB_EXPENSE_ENGINE";
let data = JSON.parse(localStorage.getItem(KEY)) || {
  categories:{
    "‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö":{ subs:[], items:[], adding:false, open:true },
    "‡§™‡•Å‡§Å‡§ú‡•Ä‡§ó‡§§ ‡§ñ‡§∞‡•ç‡§ö":{ subs:[], items:[], adding:false, open:true }
  },
  narration:""
};
let tempForm = {};

function save(){
  localStorage.setItem(KEY,JSON.stringify(data));
}

/* ===== SUB CATEGORY ===== */
function addSub(cat){
  const n=prompt("‡§®‡§Ø‡§æ‡§Å ‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï");
  if(!n) return;
  if(data.categories[cat].subs.includes(n)){
    alert("‡§™‡§π‡§ø‡§≤‡•á ‡§®‡•à ‡§õ"); return;
  }
  data.categories[cat].subs.push(n);
  save(); render();
}
function editSub(cat,old){
  const n=prompt("‡§®‡§Ø‡§æ‡§Å ‡§®‡§æ‡§Æ",old);
  if(!n) return;
  const C=data.categories[cat];
  C.subs=C.subs.map(s=>s===old?n:s);
  C.items.forEach(i=>{ if(i.sub===old) i.sub=n; });
  save(); render();
}
function delSub(cat,sub){
  const C=data.categories[cat];
  if(C.items.some(i=>i.sub===sub)){
    alert("‡§™‡§π‡§ø‡§≤‡•á ‡§ñ‡§∞‡•ç‡§ö ‡§π‡§ü‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç"); return;
  }
  C.subs=C.subs.filter(s=>s!==sub);
  save(); render();
}

/* ===== ADD EXPENSE ===== */
function startAdd(cat){
  tempForm={};
  data.categories[cat].adding=true;
  data.categories[cat].open=true;
  render();
}
function cancelAdd(cat){
  tempForm={};
  data.categories[cat].adding=false;
  render();
}
function saveAdd(cat){
  if(!tempForm.name || !tempForm.rate || !tempForm.qty){
    alert("‡§ñ‡§∞‡•ç‡§ö ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï, ‡§¶‡§∞ ‡§∞ ‡§™‡§∞‡§ø‡§Æ‡§æ‡§£ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø");
    return;
  }
  data.categories[cat].items.push({
    id:Date.now(),
    name:tempForm.name,
    sub:tempForm.sub||"",
    unit:tempForm.unit||"",
    rate:+tempForm.rate,
    qty:+tempForm.qty,
    amt:(+tempForm.rate)*(+tempForm.qty),
    edit:false
  });
  tempForm={};
  data.categories[cat].adding=false;
  save(); render();
}

/* ===== ITEM EDIT ===== */
function startEdit(cat,id){
  const i=data.categories[cat].items.find(x=>x.id===id);
  i._bak={...i}; i.edit=true;
  data.categories[cat].open=true;
  render();
}
function saveEdit(cat,id){
  const i=data.categories[cat].items.find(x=>x.id===id);
  i.amt=i.rate*i.qty;
  delete i._bak; i.edit=false;
  save(); render();
}
function cancelEdit(cat,id){
  const C=data.categories[cat];
  const idx=C.items.findIndex(x=>x.id===id);
  C.items[idx]=C.items[idx]._bak;
  C.items[idx].edit=false;
  render();
}
function delItem(cat,id){
  if(!confirm("‡§π‡§ü‡§æ‡§â‡§®‡•á?"))return;
  data.categories[cat].items=
    data.categories[cat].items.filter(i=>i.id!==id);
  save(); render();
}
function e(cat,id,f,v){
  const i=data.categories[cat].items.find(x=>x.id===id);
  i[f]=f==="rate"||f==="qty"?+v:v;
  if(f==="rate"||f==="qty") i.amt=i.rate*i.qty;
}

/* ===== NARRATION ===== */
function autoNarration(){
  let total=0;
  Object.values(data.categories).forEach(c=>{
    total+=c.items.reduce((s,i)=>s+i.amt,0);
  });
  data.narration=
    "‡§Ø‡§∏ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§ö‡§æ‡§≤‡•Å ‡§§‡§•‡§æ ‡§™‡•Å‡§Å‡§ú‡•Ä‡§ó‡§§ ‡§ñ‡§∞‡•ç‡§ö ‡§Ö‡§®‡•ç‡§§‡§∞‡•ç‡§ó‡§§ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ñ‡§∞‡•ç‡§ö‡§π‡§∞‡•Ç ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§£ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ‡•§ "+
    "‡§ï‡•Å‡§≤ ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§ñ‡§∞‡•ç‡§ö ‡§∞‡§ï‡§Æ ‡§∞‡•Å. "+total+" ‡§∞‡§π‡•á‡§ï‡•ã ‡§õ‡•§";
  expenseNarration.value=data.narration;
  save();
}

/* ===== RENDER ===== */
function render(){
  expenseRoot.innerHTML="";
  Object.keys(data.categories).forEach(cat=>{
    const C=data.categories[cat];
    const total=C.items.reduce((s,i)=>s+i.amt,0);

    const card=document.createElement("div");
    card.className="card";

    const head=document.createElement("div");
    head.className="cardHead";
    head.innerHTML=`<b>${cat}</b><span>‡§ú‡§Æ‡•ç‡§Æ‡§æ: ‡§∞‡•Å. ${total}</span>`;
    head.onclick=()=>{
      C.open=!C.open;
      save(); render();
    };

    const body=document.createElement("div");
    body.className="cardBody";
    body.style.display=C.open?"block":"none";

    body.innerHTML+=`<b>‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</b><br>`;
    C.subs.forEach(s=>{
      body.innerHTML+=`
        <div class="small">
          ‚Ä¢ ${s}
          <button onclick="editSub('${cat}','${s}')">‚úèÔ∏è</button>
          <button onclick="delSub('${cat}','${s}')">‚ùå</button>
        </div>`;
    });
    body.innerHTML+=`<button class="gray" onclick="addSub('${cat}')">‚ûï ‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</button><hr>`;

    if(C.adding){
      const opts=C.subs.map(s=>`<option>${s}</option>`).join("");
      body.innerHTML+=`
        <h3>‚ûï ‡§®‡§Ø‡§æ‡§Å ‡§ñ‡§∞‡•ç‡§ö</h3>
        <div class="row">
          <input placeholder="‡§ñ‡§∞‡•ç‡§ö ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï" oninput="tempForm.name=this.value">
          <select onchange="tempForm.sub=this.value">
            <option value="">‡§â‡§™‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</option>${opts}
          </select>
          <input placeholder="‡§á‡§ï‡§æ‡§à" oninput="tempForm.unit=this.value">
          <input type="number" placeholder="‡§¶‡§∞" oninput="tempForm.rate=this.value">
          <input type="number" placeholder="‡§™‡§∞‡§ø‡§Æ‡§æ‡§£" oninput="tempForm.qty=this.value">
          <input disabled value="${(tempForm.rate||0)*(tempForm.qty||0)}">
        </div>
        <button onclick="saveAdd('${cat}')">üíæ Save</button>
        <button class="gray" onclick="cancelAdd('${cat}')">‚Ü© Cancel</button>
        <hr>`;
    }else{
      body.innerHTML+=`<button onclick="startAdd('${cat}')">‚ûï ‡§ñ‡§∞‡•ç‡§ö ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button><hr>`;
    }

    C.items.forEach(i=>{
      body.innerHTML+=`
        <div class="item">
          <input ${i.edit?"":"disabled"} value="${i.name}"
            oninput="e('${cat}',${i.id},'name',this.value)">
          <input ${i.edit?"":"disabled"} value="${i.sub}">
          <input ${i.edit?"":"disabled"} value="${i.unit}"
            oninput="e('${cat}',${i.id},'unit',this.value)">
          <input type="number" ${i.edit?"":"disabled"} value="${i.rate}"
            oninput="e('${cat}',${i.id},'rate',this.value)">
          <input type="number" ${i.edit?"":"disabled"} value="${i.qty}"
            oninput="e('${cat}',${i.id},'qty',this.value)">
          <input disabled value="${i.amt}">
          ${
            i.edit
            ? `<button onclick="saveEdit('${cat}',${i.id})">üíæ</button>
               <button class="gray" onclick="cancelEdit('${cat}',${i.id})">‚Ü©</button>`
            : `<button onclick="startEdit('${cat}',${i.id})">‚úèÔ∏è</button>
               <button class="red" onclick="delItem('${cat}',${i.id})">‚ùå</button>`
          }
        </div>`;
    });

    card.appendChild(head);
    card.appendChild(body);
    expenseRoot.appendChild(card);
  });

  expenseNarration.value=data.narration||"";
}
render();
</script>

</body>
</html>
