<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Expense Detail | BPMS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;margin:0
}
.wrap{
  max-width:1100px;margin:25px auto;
  background:#fff;padding:25px;border-radius:12px
}
h2{color:#2e7d32;margin-top:0}

/* FORM */
.form{
  display:grid;
  grid-template-columns:2fr 3fr 1fr 1fr auto;
  gap:8px;margin-bottom:12px
}
input,select{padding:8px;font-family:inherit}
button.add{
  background:#2e7d32;color:#fff;border:none;
  border-radius:6px;padding:8px 14px;cursor:pointer
}
button.add.editing{background:#ef6c00}

/* TABLE */
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:right}
th{background:#eef5ee}
.left{text-align:left}
.cat{background:#e8f5e9;font-weight:700}
.sum{background:#fafafa;font-weight:700}
.ed{background:#1976d2;color:#fff;border:none;padding:4px 8px;border-radius:4px}
.del{background:#c62828;color:#fff;border:none;padding:4px 8px;border-radius:4px}

/* FINANCE */
.note{font-size:13px;color:#555;margin-top:8px}
.warn{color:#c62828;font-size:13px}
</style>
</head>

<body>
<div class="wrap">

<h2>ЁЯТ░ рдЦрд░реНрдЪ рд╡рд┐рд╡рд░рдг (рд╡рд╛рд░реНрд╖рд┐рдХ)</h2>

<!-- ===== ENTRY FORM ===== -->
<div class="form">
  <select id="category">
    <option>рдкреНрд░рд╛рд░рдореНрднрд┐рдХ рд▓рдЧрд╛рдиреА</option>
    <option>рдореЗрд╢реАрди рдФрдЬрд╛рд░ / рдкреНрд░рд╡рд┐рдзрд┐</option>
    <option>рдкреВрд░реНрд╡рд╛рдзрд╛рд░ рдирд┐рд░реНрдорд╛рдг</option>
    <option>рдЪрд╛рд▓реБ рдЦрд░реНрдЪ</option>
    <option>рд╡рд┐рд╡рд┐рдз</option>
  </select>
  <input id="title" placeholder="рдЦрд░реНрдЪ рд╢реАрд░реНрд╖рдХ">
  <input id="qty" type="number" placeholder="рдкрд░рд┐рдорд╛рдг">
  <input id="rate" type="number" placeholder="рджрд░">
  <button id="addBtn" class="add" onclick="addOrUpdate()">+ Add</button>
</div>

<!-- ===== EXPENSE TABLE ===== -->
<table>
<thead>
<tr>
  <th class="left">рд╢реАрд░реНрд╖рдХ</th>
  <th>рдкрд░рд┐рдорд╛рдг</th>
  <th>рджрд░</th>
  <th>рд░рдХрдо</th>
  <th></th>
</tr>
</thead>
<tbody id="body"></tbody>
<tfoot>
<tr class="sum">
  <td colspan="3" class="left">рдХреБрд▓ рдЪрд╛рд▓реБ рдЦрд░реНрдЪ</td>
  <td id="cashTotal">0</td><td></td>
</tr>
<tr class="sum">
  <td colspan="3" class="left">рд╣реНрд░рд╛рд╕рдХрдЯреНрдЯреА (резрел%)</td>
  <td id="deprTotal">0</td><td></td>
</tr>
</tfoot>
</table>

<hr>

<!-- ===== FINANCING ===== -->
<h3>ЁЯПж рд▓рдЧрд╛рдиреАрдХреЛ рд╕реНрд░реЛрдд</h3>

<table>
<tr>
  <th class="left">рд╕реНрд░реЛрдд</th>
  <th>%</th>
  <th>рд░рдХрдо</th>
  <th>рдмреНрдпрд╛рдЬ %</th>
  <th>рд╡рд╛рд░реНрд╖рд┐рдХ рдмреНрдпрд╛рдЬ</th>
</tr>
<tr>
  <td class="left">рд╕реНрд╡рд▓рдЧрд╛рдиреА</td>
  <td><input id="ownPct" value="40"></td>
  <td id="ownAmt">0</td>
  <td>тАФ</td>
  <td>тАФ</td>
</tr>
<tr>
  <td class="left">рдЕрдиреБрджрд╛рди / рдкреНрд░рд╕реНрддрд╛рд╡</td>
  <td><input id="grantPct" value="30"></td>
  <td id="grantAmt">0</td>
  <td>тАФ</td>
  <td>тАФ</td>
</tr>
<tr>
  <td class="left">рдмреИрдВрдХ / рд╕рд╣рдХрд╛рд░реА рдЛрдг</td>
  <td><input id="loanPct" value="30"></td>
  <td id="loanAmt">0</td>
  <td><input id="loanRate" value="12"></td>
  <td id="loanInterest">0</td>
</tr>
<tr class="sum">
  <td class="left">рдЬрдореНрдорд╛</td>
  <td id="totPct">100%</td>
  <td id="totAmt">0</td>
  <td></td>
  <td id="totInt">0</td>
</tr>
</table>

<p class="note">
тЬФя╕П рдмреНрдпрд╛рдЬ Profit-Loss рд░ ROI рдорд╛ рд╕реНрд╡рддрдГ рддрд╛рдирд┐рдиреНрдЫ<br>
тЬФя╕П Edit/Delete рдЧрд░реНрджрд╛ data рд╕реБрд░рдХреНрд╖рд┐рдд рд░рд╣рдиреНрдЫ
</p>

</div>

<script>
/* ================= LOAD PROJECT ================= */
let key = localStorage.getItem("activeProject");
if(!key){
  alert("рдкрд╣рд┐рд▓реЗ Project рдЦреЛрд▓реНрдиреБрд╣реЛрд╕реН");
  location.href="index.html";
}
let project = JSON.parse(localStorage.getItem(key));
project.expenseData = project.expenseData || [];
project.financing = project.financing || {};
let expenses = project.expenseData;

let editId = null;

/* ================= ADD / UPDATE ================= */
function addOrUpdate(){
  if(!title.value) return;
  let amount = (Number(qty.value)||0) * (Number(rate.value)||0);

  if(editId){
    let e = expenses.find(x=>x.id===editId);
    if(e){
      e.category = category.value;
      e.title = title.value;
      e.qty = qty.value;
      e.rate = rate.value;
      e.amount = amount;
    }
    editId=null;
    addBtn.innerText="+ Add";
    addBtn.classList.remove("editing");
  }else{
    expenses.push({
      id:Date.now(),
      category:category.value,
      title:title.value,
      qty:qty.value,
      rate:rate.value,
      amount:amount
    });
  }
  title.value=""; qty.value=""; rate.value="";
  save();
}

/* ================= EDIT ================= */
function editRow(id){
  let e = expenses.find(x=>x.id===id);
  if(!e) return;
  category.value=e.category;
  title.value=e.title;
  qty.value=e.qty;
  rate.value=e.rate;
  editId=id;
  addBtn.innerText="ЁЯТ╛ Update";
  addBtn.classList.add("editing");
}

/* ================= DELETE ================= */
function delRow(id){
  if(!confirm("рдпреЛ рдЦрд░реНрдЪ рд╣рдЯрд╛рдЙрдиреЗ ?")) return;
  expenses = expenses.filter(e=>e.id!==id);
  project.expenseData = expenses;
  save();
}

/* ================= SAVE ================= */
function save(){
  project.expenseData = expenses;
  localStorage.setItem(key,JSON.stringify(project));
  render();
}

/* ================= RENDER ================= */
function render(){
  body.innerHTML="";
  let groups={}, cash=0, depr=0, capital=0;

  expenses.forEach(e=>{
    if(!groups[e.category]) groups[e.category]=[];
    groups[e.category].push(e);
  });

  for(let c in groups){
    body.innerHTML+=`<tr class="cat"><td colspan="5">ЁЯФ╣ ${c}</td></tr>`;
    groups[c].forEach(e=>{
      if(c==="рдореЗрд╢реАрди рдФрдЬрд╛рд░ / рдкреНрд░рд╡рд┐рдзрд┐"||c==="рдкреВрд░реНрд╡рд╛рдзрд╛рд░ рдирд┐рд░реНрдорд╛рдг"){
        depr += e.amount*0.15;
        capital += e.amount;
      }else{
        cash += e.amount;
        if(c==="рдкреНрд░рд╛рд░рдореНрднрд┐рдХ рд▓рдЧрд╛рдиреА") capital += e.amount;
      }
      body.innerHTML+=`
      <tr>
        <td class="left">${e.title}</td>
        <td>${e.qty}</td>
        <td>${e.rate}</td>
        <td>${Math.round(e.amount)}</td>
        <td>
          <button class="ed" onclick="editRow(${e.id})">тЬПя╕П</button>
          <button class="del" onclick="delRow(${e.id})">тЭМ</button>
        </td>
      </tr>`;
    });
  }

  cashTotal.innerText=Math.round(cash);
  deprTotal.innerText=Math.round(depr);

  /* ===== FINANCING ===== */
  let op=Number(ownPct.value||0),
      gp=Number(grantPct.value||0),
      lp=Number(loanPct.value||0),
      lr=Number(loanRate.value||0);

  if(op+gp+lp!==100){
    totPct.innerText="тЪая╕П 100% рд╣реБрдиреБрдкрд░реНрдЫ";
    return;
  }

  let oa=capital*op/100,
      ga=capital*gp/100,
      la=capital*lp/100,
      li=la*lr/100;

  ownAmt.innerText=Math.round(oa);
  grantAmt.innerText=Math.round(ga);
  loanAmt.innerText=Math.round(la);
  loanInterest.innerText=Math.round(li);

  totPct.innerText="100%";
  totAmt.innerText=Math.round(capital);
  totInt.innerText=Math.round(li);

  project.financing={
    capital, ownPct:op, grantPct:gp, loanPct:lp, loanRate:lr,
    ownAmt:oa, grantAmt:ga, loanAmt:la, loanInterest:li
  };
  localStorage.setItem(key,JSON.stringify(project));
}

/* INIT */
[ownPct,grantPct,loanPct,loanRate].forEach(i=>i.oninput=render);
render();
</script>

</body>
</html>
