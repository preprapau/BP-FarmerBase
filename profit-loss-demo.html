<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Profit / Loss | FarmerBase BPMS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati","Mangal","Nirmala UI",system-ui,Arial;
  background:#f4f7f6;
  margin:0;
}
.container{
  max-width:950px;
  margin:25px auto;
  background:#fff;
  padding:25px;
  border-radius:10px;
}
h2{margin-top:0;color:#2e7d32}

/* ===== PROGRESS ===== */
.progress{
  background:#e8f5e9;
  border:1px solid #c8e6c9;
  padding:12px;
  border-radius:8px;
  margin-bottom:15px;
}
.bar{height:8px;background:#2e7d32;width:71%;border-radius:6px;margin-top:8px}

/* ===== BOX ===== */
.box{
  border:1px solid #ddd;
  border-radius:8px;
  padding:15px;
  margin-bottom:15px;
}
.green{background:#e8f5e9}
.blue{background:#e3f2fd}
.yellow{background:#fffde7}
.gray{background:#fafafa}
.big{font-size:20px;font-weight:700}
.right{text-align:right}

/* ===== TABLE ===== */
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px}
th{background:#f0f0f0}

/* ===== INPUT ===== */
input[type=text]{width:100%}
input[type=number]{width:80px}

/* ===== BUTTON ===== */
button{
  padding:6px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#2e7d32;
  color:#fff;
}
.del{background:#c62828}

/* ===== NAV ===== */
.nav{
  display:flex;
  justify-content:space-between;
  margin-top:30px;
}

@media print{
  button,.progress,.nav{display:none}
}
</style>
</head>

<body>

<div class="container">

<div class="progress">
  <b>‡§ö‡§∞‡§£ ‡•´ / ‡•≠ (‡•≠‡•ß%)</b><br>
  Short Info ‚Üí Detail ‚Üí Expense ‚Üí Income ‚Üí <b>Profit/Loss</b> ‚Üí ROI ‚Üí Proposal
  <div class="bar"></div>
</div>

<h2>üìä ‡§®‡§æ‡§´‡§æ / ‡§®‡•ã‡§ï‡•ç‡§∏‡§æ‡§® ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ (‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï)</h2>

<!-- SUMMARY -->
<div class="box gray">
<table>
<tr>
  <th>‡§ï‡•Å‡§≤ ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</th>
  <td class="right" id="totalIncome">0</td>
</tr>
<tr>
  <th>‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö</th>
  <td class="right" id="cashExpense">0</td>
</tr>
<tr>
  <th>‡§π‡•ç‡§∞‡§æ‡§∏‡§ï‡§ü‡•ç‡§ü‡•Ä (Depreciation)</th>
  <td class="right" id="depreciation">0</td>
</tr>
<tr>
  <th>‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö</th>
  <td class="right" id="totalExpense">0</td>
</tr>
</table>
</div>

<!-- FINAL PROFIT -->
<div id="profitBox" class="box green">
  <div>‚úî ‡§®‡§æ‡§´‡§æ (Final)</div>
  <div class="big" id="netProfit">0</div>
</div>

<!-- PROFIT ALLOCATION (BOTTOM) -->
<div class="box blue">
  <h3>üîπ ‡§®‡§æ‡§´‡§æ ‡§µ‡§ø‡§§‡§∞‡§£ / ‡§≤‡§æ‡§≠‡§æ‡§Ç‡§∂ (Profit Allocation)</h3>

  <div class="big">‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§´‡§æ: <span id="profitBase">0</span></div><br>

  <table>
    <thead>
      <tr>
        <th>‡§µ‡§ø‡§ß‡§æ / ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ú‡§®</th>
        <th>%</th>
        <th>‡§∞‡§ï‡§Æ</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="allocBody"></tbody>
    <tfoot>
      <tr class="big">
        <td>‡§ú‡§Æ‡•ç‡§Æ‡§æ</td>
        <td id="totalPercent">0%</td>
        <td id="totalAmount">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <br>
  <input id="method" type="text" placeholder="‡§ú‡§∏‡•ç‡§§‡•à: ‡§Æ‡§æ‡§≤‡§ø‡§ï / ‡§™‡•Å‡§®‡§É ‡§≤‡§ó‡§æ‡§®‡•Ä / ‡§∏‡§π‡§ï‡§æ‡§∞‡•Ä">
  <input id="percent" type="number" min="0" max="100" placeholder="%">
  <button onclick="addAlloc()">Ôºã Add</button>

  <div id="notice" class="box yellow" style="display:none;margin-top:10px"></div>
</div>

<div class="nav">
  <button onclick="location.href='income-demo.html'">‚¨Ö Previous</button>
  <button onclick="location.href='five-year-roi.html'">Next ‚û°</button>
</div>

</div>

<script>
let key = localStorage.getItem("activeProject");
if(!key){
  alert("‡§™‡§π‡§ø‡§≤‡•á Project ‡§ñ‡•ã‡§≤‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç");
  location.href="index.html";
}
let p = JSON.parse(localStorage.getItem(key));

/* ===== INCOME ===== */
let income = 0;
(p.incomeData||[]).forEach(i=> income += Number(i.amount||0));

/* ===== EXPENSE ===== */
let cash = 0, depr = 0;
(p.expenseData||[]).forEach(e=>{
  if(e.category==="‡§™‡•ç‡§∞‡§æ‡§∞‡§Æ‡•ç‡§≠‡§ø‡§ï ‡§≤‡§ó‡§æ‡§®‡•Ä") depr += Number(e.amount||0)*0.10;
  else cash += Number(e.amount||0);
});

/* ===== PROFIT ===== */
let profit = income - (cash + depr);

/* DISPLAY SUMMARY */
totalIncome.innerText = income;
cashExpense.innerText = cash;
depreciation.innerText = Math.round(depr);
totalExpense.innerText = Math.round(cash + depr);
netProfit.innerText = profit>=0 ? "‡§∞‡•Å. "+Math.round(profit) : "‡§®‡•ã‡§ï‡•ç‡§∏‡§æ‡§® : ‡§∞‡•Å. "+Math.abs(Math.round(profit));
profitBase.innerText = Math.round(profit);

/* ===== ALLOCATION ===== */
let alloc = p.profitAllocation || [];

function renderAlloc(){
  allocBody.innerHTML="";
  let sumP=0,sumA=0;

  alloc.forEach((a,i)=>{
    let amt = profit * (a.percent/100);
    sumP += a.percent;
    sumA += amt;

    allocBody.innerHTML+=`
      <tr>
        <td>${a.method}</td>
        <td>${a.percent}%</td>
        <td class="right">${Math.round(amt)}</td>
        <td><button class="del" onclick="removeAlloc(${i})">‚úñ</button></td>
      </tr>`;
  });

  totalPercent.innerText = sumP+"%";
  totalAmount.innerText = Math.round(sumA);

  notice.style.display = sumP===100?"none":"block";
  notice.innerText = "‚ö†Ô∏è ‡§ï‡•Å‡§≤ ‡§µ‡§ø‡§§‡§∞‡§£ 100% ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ (‡§Ö‡§π‡§ø‡§≤‡•á "+sumP+"%)";
}
renderAlloc();

function addAlloc(){
  if(!method.value||!percent.value) return;
  alloc.push({method:method.value,percent:Number(percent.value)});
  method.value="";percent.value="";
  saveAlloc();
}
function removeAlloc(i){
  alloc.splice(i,1);
  saveAlloc();
}
function saveAlloc(){
  p.profitAllocation = alloc;
  p.lastEdited = new Date().toLocaleString("ne-NP");
  localStorage.setItem(key, JSON.stringify(p));
  renderAlloc();
}
</script>

</body>
</html>
