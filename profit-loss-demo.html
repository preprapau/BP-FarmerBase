<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>рдирд╛рдлрд╛ / рдиреЛрдХреНрд╕рд╛рди (рд╡рд╛рд░реНрд╖рд┐рдХ)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;margin:0;
}
.wrap{
  max-width:1000px;margin:25px auto;
  background:#fff;padding:25px;border-radius:12px;
}
h2,h3{color:#2e7d32;margin-top:0}

table{
  width:100%;border-collapse:collapse;margin-top:15px;
}
th,td{
  border-bottom:1px solid #ddd;padding:10px;
}
th{background:#f1f5f1;text-align:left}
.right{text-align:right}

.green{color:#2e7d32;font-weight:bold}
.red{color:#c62828;font-weight:bold}

input[type=number]{width:70px;padding:4px}

button{
  padding:6px 14px;border:none;border-radius:6px;
  background:#2e7d32;color:#fff;cursor:pointer;
}
.small{font-size:13px;color:#555}

@media print{
  button{display:none}
  a[href]:after{content:""}
}
</style>
</head>

<body>
<div class="wrap">

<h2>ЁЯУК рдирд╛рдлрд╛ / рдиреЛрдХреНрд╕рд╛рди (рд╡рд╛рд░реНрд╖рд┐рдХ)</h2>

<table>
<tr><th>рд╢реАрд░реНрд╖рдХ</th><th class="right">рд░рдХрдо (рд░реБ.)</th></tr>
<tr><td>рдХреБрд▓ рдЖрдореНрджрд╛рдиреА</td><td class="right" id="inc">0</td></tr>
<tr><td>рдЪрд╛рд▓реБ рдЦрд░реНрдЪ</td><td class="right" id="cash">0</td></tr>
<tr><td>рд╣реНрд░рд╛рд╕рдХрдЯреНрдЯреА (резрел%)</td><td class="right" id="depr">0</td></tr>
<tr><td>рдмреИрдВрдХ рдмреНрдпрд╛рдЬ</td><td class="right" id="interest">0</td></tr>
<tr><th>рдХрд░ рдЕрдШрд┐рдХреЛ рдирд╛рдлрд╛ (PBT)</th><th class="right" id="pbt">0</th></tr>
<tr><td>рдХрд░ (реирел%)</td><td class="right" id="tax">0</td></tr>
<tr>
  <th>рдЦреБрдж рдирд╛рдлрд╛ (PAT)</th>
  <th class="right green" id="pat">0</th>
</tr>
</table>

<!-- ================= DIVIDEND ================= -->
<h3 style="margin-top:30px">ЁЯТ░ рд▓рд╛рднрд╛рдВрд╢ рд╡рд┐рддрд░рдг</h3>

<table id="divTable">
<tr>
  <th>рд╡рд┐рдзрд╛</th>
  <th>%</th>
  <th class="right">рд░рдХрдо</th>
  <th></th>
</tr>
<tr>
  <td><input value="рд╕реНрд╡рд╛рдореА / рд╕рд╛рдЭреЗрджрд╛рд░"></td>
  <td><input type="number" value="60" class="dPerc"></td>
  <td class="right dAmt">0</td>
  <td></td>
</tr>
<tr>
  <td><input value="рдкреБрдирдГ рд▓рдЧрд╛рдиреА"></td>
  <td><input type="number" value="40" class="dPerc"></td>
  <td class="right dAmt">0</td>
  <td></td>
</tr>
</table>

<button onclick="addDividend()">тЮХ Add</button>
<div class="small" id="warn"></div>

</div>

<script>
/* ================= LOAD PROJECT ================= */
let key = localStorage.getItem("activeProject");
if(!key){
  alert("Project рднреЗрдЯрд┐рдПрди");
  location.href="index.html";
}
let p = JSON.parse(localStorage.getItem(key)) || {};

/* ================= TOTAL INCOME ================= */
let totalIncome = 0;
(p.incomeData||[]).forEach(i=>{
  totalIncome += Number(i.amount||0);
});

/* ================= EXPENSE BREAKDOWN ================= */
let operating = 0;
let depreciation = 0;
let interestAmt = 0;

(p.expenseData||[]).forEach(e=>{
  let amt = Number(e.amount||0);
  let cat = (e.category||"").toLowerCase();
  let title = (e.title||"").toLowerCase();

  /* ЁЯФ┤ BANK INTEREST (FINAL FIX) */
  if(title.includes("рдмреНрдпрд╛рдЬ") || cat.includes("рд▓рдЧрд╛рдиреА")){
    interestAmt += amt;
    return;
  }

  /* ЁЯФ╡ DEPRECIATION ITEMS */
  if(
    cat.includes("рдореЗрд╢рд┐рди") ||
    cat.includes("рдФрдЬрд╛рд░") ||
    cat.includes("рдкреВрд░реНрд╡рд╛рдзрд╛рд░") ||
    cat.includes("рднрд╡рди")
  ){
    depreciation += amt * 0.15;
    return;
  }

  /* ЁЯЯв OPERATING EXPENSE */
  operating += amt;
});

/* ================= PROFIT CALC ================= */
let PBT = totalIncome - operating - depreciation - interestAmt;
let taxRate = Number(p.taxRate || 25);   // default 25%
let taxAmount = PBT > 0 ? (PBT * taxRate / 100) : 0;
let PAT = PBT - taxAmount;

/* ================= RENDER ================= */
document.getElementById("inc").innerText = Math.round(totalIncome);
document.getElementById("cash").innerText = Math.round(operating);
document.getElementById("depr").innerText = Math.round(depreciation);
document.getElementById("interest").innerText = Math.round(interestAmt);
document.getElementById("pbt").innerText = Math.round(PBT);
document.getElementById("tax").innerText = Math.round(taxAmount);
document.getElementById("pat").innerText = Math.round(PAT);

/* ================= DIVIDEND ================= */
function calcDividend(){
  let rows=document.querySelectorAll("#divTable tr");
  let totalPerc=0;
  rows.forEach((r,i)=>{
    if(i===0) return;
    let p = Number(r.querySelector(".dPerc").value||0);
    totalPerc+=p;
    r.querySelector(".dAmt").innerText = Math.round(PAT*p/100);
  });
  warn.innerText = totalPerc>100 ? "тЪая╕П рдХреБрд▓ % 100 рднрдиреНрджрд╛ рдмрдвреА рднрдпреЛ" : "";
}

document.addEventListener("input",e=>{
  if(e.target.classList.contains("dPerc")) calcDividend();
});

function addDividend(){
  let tr=document.createElement("tr");
  tr.innerHTML=`
    <td><input placeholder="рд╡рд┐рдзрд╛"></td>
    <td><input type="number" class="dPerc" value="0"></td>
    <td class="right dAmt">0</td>
    <td><button onclick="this.parentElement.parentElement.remove();calcDividend()">тЬЦ</button></td>
  `;
  divTable.appendChild(tr);
}

calcDividend();
</script>

</body>
</html>
