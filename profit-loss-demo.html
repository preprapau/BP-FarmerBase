<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Profit / Loss | BPMS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati","Mangal","Nirmala UI",system-ui,Arial;
  background:#f4f7f6;margin:0;
}
.wrap{max-width:1100px;margin:auto;padding:20px}

/* NAV */
.nav{
  display:flex;gap:8px;flex-wrap:wrap;
  background:#e9f5ea;padding:12px;border-radius:12px
}
.nav a{
  padding:8px 14px;border-radius:20px;
  text-decoration:none;color:#000;background:#dff0e1
}
.nav a.active{background:#2e7d32;color:#fff}

/* CARD */
.card{background:#fff;border-radius:14px;padding:20px;margin-top:20px}
table{width:100%;border-collapse:collapse}
td,th{padding:10px;border-bottom:1px solid #ddd}
th{text-align:left;background:#f1f5f1}
.right{text-align:right}

input[type=number],input[type=text]{width:80px;padding:6px}

.total{font-weight:bold}
.green{color:#2e7d32}
.red{color:#c62828}

/* ACTION */
.actions{
  display:flex;justify-content:space-between;
  margin-top:25px
}
button{
  padding:8px 18px;
  border:none;border-radius:6px;
  background:#2e7d32;color:#fff;
  cursor:pointer;
}
.small{font-size:13px;color:#555}
</style>
</head>

<body>
<div class="wrap">

<!-- ===== MENU ===== -->
<div class="nav">
  <a href="short-info.html">Short Info</a>
  <a href="business-detail.html">Detail</a>
  <a href="expense-demo.html">Expense</a>
  <a href="income-demo.html">Income</a>
  <a class="active">Profit / Loss</a>
  <a href="five-year-roi.html">5-Year ROI</a>
  <a href="full-proposal.html">Proposal</a>
</div>

<!-- ================= PROFIT LOSS ================= -->
<div class="card">
<h2>üìä ‡§®‡§æ‡§´‡§æ / ‡§®‡•ã‡§ï‡•ç‡§∏‡§æ‡§® (‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï)</h2>

<table>
<tr><th>‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th><th class="right">‡§∞‡§ï‡§Æ (‡§∞‡•Å.)</th></tr>
<tr><td>‡§ï‡•Å‡§≤ ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</td><td class="right" id="inc">0</td></tr>
<tr><td>‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö</td><td class="right" id="cash">0</td></tr>
<tr><td>‡§π‡•ç‡§∞‡§æ‡§∏‡§ï‡§ü‡•ç‡§ü‡•Ä (‡•ß‡•´%)</td><td class="right" id="depr">0</td></tr>
<tr><td>‡§¨‡•à‡§Ç‡§ï ‡§¨‡•ç‡§Ø‡§æ‡§ú</td><td class="right" id="interest">0</td></tr>

<tr class="total">
  <td>‡§ï‡§∞ ‡§Ö‡§ò‡§ø‡§ï‡•ã ‡§®‡§æ‡§´‡§æ (PBT)</td>
  <td class="right" id="pbt">0</td>
</tr>
<tr>
  <td>‡§ï‡§∞ (‡•®‡•´%)</td>
  <td class="right" id="tax">0</td>
</tr>
<tr class="total">
  <td>‡§ñ‡•Å‡§¶ ‡§®‡§æ‡§´‡§æ (PAT)</td>
  <td class="right" id="net">0</td>
</tr>
</table>
</div>

<!-- ================= DIVIDEND ================= -->
<div class="card">
<h3>üí∞ ‡§≤‡§æ‡§≠‡§æ‡§Ç‡§∂ ‡§µ‡§ø‡§§‡§∞‡§£ (‡§ñ‡•Å‡§¶ ‡§®‡§æ‡§´‡§æ ‡§Ü‡§ß‡§æ‡§∞‡§Æ‡§æ)</h3>

<table>
<thead>
<tr>
  <th>‡§µ‡§ø‡§ß‡§æ</th>
  <th class="right">%</th>
  <th class="right">‡§∞‡§ï‡§Æ</th>
</tr>
</thead>
<tbody id="divBody"></tbody>
<tfoot>
<tr class="total">
  <td>‡§ï‡•Å‡§≤</td>
  <td class="right" id="divPct">0%</td>
  <td></td>
</tr>
</tfoot>
</table>

<button onclick="addDividend()">‚ûï Add Option</button>
<p class="small">‚úîÔ∏è % ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§® ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§∞‡§ï‡§Æ ‡§∏‡•ç‡§µ‡§§‡§É ‡§¨‡§¶‡§≤‡§ø‡§®‡•ç‡§õ</p>
</div>

<!-- ================= ACTION ================= -->
<div class="actions">
  <button onclick="goPrev()">‚¨Ö Expense / Income</button>
  <button onclick="goNext()">ROI ‚û°</button>
</div>

</div>

<script>
/* ===== LOAD PROJECT ===== */
let key = localStorage.getItem("activeProject");
let p = JSON.parse(localStorage.getItem(key) || "{}");

/* ===== CALC BASE ===== */
let income=0, cash=0, depr=0, interest=0;

/* INCOME */
(p.incomeData||[]).forEach(i=>{
  income += Number(i.amount||0);
});

/* EXPENSE (KEYWORD BASED FINAL) */
(p.expenseData||[]).forEach(e=>{
  let amt = Number(e.amount||0);
  let cat = (e.category||"").toLowerCase();
  let title = (e.title||"").toLowerCase();
  let source = (e.source||"").toLowerCase();

  /* BANK INTEREST */
  if(
    cat.includes("‡§¨‡•ç‡§Ø‡§æ‡§ú") ||
    title.includes("‡§¨‡•ç‡§Ø‡§æ‡§ú") ||
    title.includes("interest") ||
    title.includes("loan") ||
    source.includes("loan") ||
    source.includes("bank") ||
    source.includes("coop")
  ){
    interest += amt;
  }

  /* DEPRECIATION */
  else if(
    cat.includes("‡§Æ‡•á‡§∏‡§ø‡§®") ||
    cat.includes("‡§Æ‡•á‡§∂‡•Ä‡§®") ||
    cat.includes("machine") ||
    cat.includes("‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞") ||
    cat.includes("‡§≠‡§µ‡§®") ||
    cat.includes("‡§ï‡•á‡§ú") ||
    cat.includes("shed")
  ){
    depr += amt * 0.15;
  }

  /* CASH EXPENSE */
  else{
    cash += amt;
  }
});

/* ===== PROFIT CALC ===== */
let pbt = income - cash - depr - interest;
let tax = pbt > 0 ? pbt * 0.25 : 0;
let net = pbt - tax;

/* ===== DISPLAY ===== */
inc.innerText = Math.round(income);
cash.innerText = Math.round(cash);
depr.innerText = Math.round(depr);
interest.innerText = Math.round(interest);

pbtEl = document.getElementById("pbt");
taxEl = document.getElementById("tax");
netEl = document.getElementById("net");

pbtEl.innerText = Math.round(pbt);
taxEl.innerText = Math.round(tax);
netEl.innerText = Math.round(net);
netEl.className = net>=0 ? "green" : "red";

/* ===== DIVIDEND ===== */
let dividends = p.dividends || [
  {title:"‡§∏‡•ç‡§µ‡§æ‡§Æ‡•Ä / ‡§∏‡§æ‡§ù‡•á‡§¶‡§æ‡§∞", pct:60},
  {title:"‡§™‡•Å‡§®‡§É ‡§≤‡§ó‡§æ‡§®‡•Ä", pct:40}
];

function renderDividend(){
  divBody.innerHTML="";
  let total=0;

  dividends.forEach((d,i)=>{
    total+=Number(d.pct||0);
    let amt = net>0 ? Math.round(net*d.pct/100) : 0;

    divBody.innerHTML+=`
      <tr>
        <td><input type="text" value="${d.title}"
          onchange="dividends[${i}].title=this.value"></td>
        <td class="right">
          <input type="number" value="${d.pct}"
            onchange="updatePct(${i},this.value)">
        </td>
        <td class="right">${amt}</td>
      </tr>`;
  });

  divPct.innerText=total+"%";
  divPct.style.color = total===100 ? "#2e7d32" : "#c62828";

  /* SAVE FOR PROPOSAL */
  p.dividends = dividends;
  p.netProfit = net;
  localStorage.setItem(key,JSON.stringify(p));
}

function updatePct(i,val){
  dividends[i].pct = Number(val||0);
  renderDividend();
}
function addDividend(){
  dividends.push({title:"‡§®‡§Ø‡§æ‡§Å ‡§µ‡§ø‡§ß‡§æ",pct:0});
  renderDividend();
}
renderDividend();

/* ===== NAV ===== */
function goPrev(){ location.href="expense-demo.html"; }
function goNext(){ location.href="five-year-roi.html"; }
</script>

</body>
</html>
