<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>‡§®‡§æ‡§´‡§æ / ‡§®‡•ã‡§ï‡•ç‡§∏‡§æ‡§® (‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï) | BPMS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati","Mangal","Nirmala UI",system-ui,Arial;
  background:#f4f7f6;margin:0
}
.wrap{max-width:1100px;margin:auto;padding:20px}
h2,h3{color:#2e7d32}

.card{
  background:#fff;
  border-radius:14px;
  padding:20px;
  margin-top:20px
}

table{
  width:100%;
  border-collapse:collapse
}
th,td{
  padding:10px;
  border-bottom:1px solid #ddd
}
th{
  background:#f1f5f1;
  text-align:left
}
.right{text-align:right}

input[type=number]{
  width:80px;
  padding:6px
}

.green{color:#2e7d32;font-weight:bold}
.red{color:#c62828;font-weight:bold}

button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  background:#2e7d32;
  color:#fff;
  cursor:pointer
}

@media print{
  button{display:none}
}
</style>
</head>

<body>
<div class="wrap">

<!-- ================= PROFIT LOSS ================= -->
<div class="card">
<h2>üìä ‡§®‡§æ‡§´‡§æ / ‡§®‡•ã‡§ï‡•ç‡§∏‡§æ‡§® (‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï)</h2>

<table>
<tr><th>‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th><th class="right">‡§∞‡§ï‡§Æ (‡§∞‡•Å.)</th></tr>

<tr><td>‡§ï‡•Å‡§≤ ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä</td><td class="right" id="inc">0</td></tr>
<tr><td>‡§ö‡§æ‡§≤‡•Å ‡§ñ‡§∞‡•ç‡§ö</td><td class="right" id="cash">0</td></tr>
<tr><td>‡§π‡•ç‡§∞‡§æ‡§∏‡§ï‡§ü‡•ç‡§ü‡•Ä (‡•ß‡•´%)</td><td class="right" id="depr">0</td></tr>
<tr><td>‡§¨‡•à‡§Ç‡§ï ‡§¨‡•ç‡§Ø‡§æ‡§ú</td><td class="right" id="int">0</td></tr>

<tr><th>‡§ï‡§∞ ‡§Ö‡§ò‡§ø‡§ï‡•ã ‡§®‡§æ‡§´‡§æ (PBT)</th><th class="right" id="pbt">0</th></tr>
<tr>
  <td>‡§ï‡§∞ (%)
    <input type="number" id="taxRate" value="25">
  </td>
  <td class="right" id="tax">0</td>
</tr>
<tr>
  <th>‡§ñ‡•Å‡§¶ ‡§®‡§æ‡§´‡§æ (PAT)</th>
  <th class="right" id="profit">0</th>
</tr>
</table>
</div>

<!-- ================= DIVIDEND ================= -->
<div class="card">
<h3>üí∞ ‡§≤‡§æ‡§≠‡§æ‡§Ç‡§∂ ‡§µ‡§ø‡§§‡§∞‡§£</h3>

<table id="divTable">
<thead>
<tr>
  <th>‡§µ‡§ø‡§µ‡§∞‡§£</th>
  <th>%</th>
  <th class="right">‡§∞‡§ï‡§Æ</th>
  <th></th>
</tr>
</thead>
<tbody>
<tr>
  <td><input value="‡§∏‡•ç‡§µ‡§æ‡§Æ‡•Ä / ‡§∏‡§æ‡§ù‡•á‡§¶‡§æ‡§∞"></td>
  <td><input type="number" class="divPct" value="60"></td>
  <td class="right divAmt">0</td>
  <td></td>
</tr>
<tr>
  <td><input value="‡§™‡•Å‡§®‡§É ‡§≤‡§ó‡§æ‡§®‡•Ä"></td>
  <td><input type="number" class="divPct" value="40"></td>
  <td class="right divAmt">0</td>
  <td></td>
</tr>
</tbody>
</table>

<br>
<button onclick="addDividend()">‚ûï Add Option</button>
</div>

</div>

<script>
/* ================= LOAD PROJECT ================= */
let key = localStorage.getItem("activeProject");
let p = JSON.parse(localStorage.getItem(key)) || {};

/* ================= TOTAL INCOME ================= */
let totalIncome = 0;
(p.incomeData||[]).forEach(i=>{
  totalIncome += Number(i.amount||0);
});

/* ================= EXPENSE SPLIT ================= */
let operatingExpense = 0;
let depreciation = 0;
let interest = 0;

(p.expenseData||[]).forEach(e=>{
  let amt = Number(e.amount||0);
  let cat = (e.category||"").toLowerCase();
  let title = (e.title||"").toLowerCase();

  if(cat.includes("‡§¨‡•ç‡§Ø‡§æ‡§ú") || title.includes("‡§¨‡•ç‡§Ø‡§æ‡§ú")){
    interest += amt;
  }
  else if(
    cat.includes("‡§Æ‡•á‡§∂‡§ø‡§®") ||
    cat.includes("‡§î‡§ú‡§æ‡§∞") ||
    cat.includes("‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§ß‡§æ‡§∞") ||
    cat.includes("‡§≠‡§µ‡§®")
  ){
    depreciation += amt * 0.15;
  }
  else{
    operatingExpense += amt;
  }
});

/* ================= PROFIT CALC ================= */
function calcPL(){
  let taxRate = Number(document.getElementById("taxRate").value||0);

  let PBT = totalIncome - operatingExpense - depreciation - interest;
  let tax = PBT>0 ? (PBT*taxRate/100) : 0;
  let PAT = PBT - tax;

  inc.innerText = Math.round(totalIncome);
  cash.innerText = Math.round(operatingExpense);
  depr.innerText = Math.round(depreciation);
  int.innerText = Math.round(interest);
  pbt.innerText = Math.round(PBT);
  taxEl.innerText = Math.round(tax);

  profit.innerText = Math.round(PAT);
  profit.className = PAT>=0?"green":"red";

  calcDividend(PAT);
}

/* ================= DIVIDEND ================= */
function calcDividend(PAT){
  let rows = document.querySelectorAll("#divTable tbody tr");
  rows.forEach(r=>{
    let pct = Number(r.querySelector(".divPct").value||0);
    r.querySelector(".divAmt").innerText = Math.round(PAT*pct/100);
  });
}

function addDividend(){
  let tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input placeholder="‡§®‡§Ø‡§æ‡§Å ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™"></td>
    <td><input type="number" class="divPct" value="0"></td>
    <td class="right divAmt">0</td>
    <td><button onclick="this.parentElement.parentElement.remove()">‚úñ</button></td>
  `;
  document.querySelector("#divTable tbody").appendChild(tr);
  calcPL();
}

/* ================= EVENTS ================= */
document.addEventListener("input",calcPL);

/* ================= INIT ================= */
const taxEl = document.getElementById("tax");
calcPL();
</script>

</body>
</html>
