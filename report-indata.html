<script>
/* ================= LOAD PROJECT ================= */
let key = localStorage.getItem("activeProject");
let p = key ? JSON.parse(localStorage.getItem(key)) : {};

/* ================= INCOME ================= */
let income = 0;
(p.incomeData||[]).forEach(i=>{
  income += Number(i.amount||0);
});

/* ================= EXPENSE ================= */
let operating = 0;
let depreciation = 0;

/* operating + depreciation */
(p.expenseData||[]).forEach(e=>{
  let amt = Number(e.amount||0);
  let cat = (e.category||"").toLowerCase();

  if(cat.includes("मेशिन") || cat.includes("औजार") || cat.includes("पूर्वाधार")){
    depreciation += amt * 0.15;
  }else{
    operating += amt;
  }
});

/* ================= INTEREST ================= */
let interest = Number(localStorage.getItem("ANNUAL_LOAN_INTEREST")) || 0;

/* ================= PROFIT ================= */
let PBT = income - operating - depreciation - interest;
let tax = PBT > 0 ? PBT * 0.25 : 0;
let PAT = PBT - tax;
let OCF = PAT + depreciation;

/* ================= INITIAL INVESTMENT ================= */
let investment = 0;

/* 1️⃣ from Short Info */
if(p.shortInfo?.bp_capital){
  investment = Number(
    p.shortInfo.bp_capital.replace(/[^\d]/g,"")
  ) || 0;
}

/* 2️⃣ fallback: expense category = प्रारम्भिक लगानी */
if(!investment){
  (p.expenseData||[]).forEach(e=>{
    if((e.category||"").includes("प्रारम्भिक")){
      investment += Number(e.amount||0);
    }
  });
}

/* ================= ROI INDICATORS ================= */
let payback = OCF>0 ? (investment/OCF).toFixed(2)+" वर्ष" : "N/A";

/* simple IRR approx */
let irr = investment>0 ? ((PAT/investment)*100).toFixed(1)+" %" : "N/A";

/* NPV @10% */
let npv = -investment;
for(let y=1;y<=5;y++){
  npv += OCF / Math.pow(1.1,y);
}

/* ================= RENDER ================= */
inc.innerText = Math.round(income);
op.innerText  = Math.round(operating);
dep.innerText = Math.round(depreciation);
int.innerText = Math.round(interest);
pbt.innerText = Math.round(PBT);
tax.innerText = Math.round(tax);
pat.innerText = Math.round(PAT);
ocf.innerText = Math.round(OCF);

inv.innerText = Math.round(investment);
paybackEl.innerText = payback;
irrEl.innerText = irr;
npvEl.innerText = Math.round(npv);
</script>
