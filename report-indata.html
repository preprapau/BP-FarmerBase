<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>ROI Detail | FarmerBase BPMS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;margin:0;
}
.page{
  max-width:1100px;margin:25px auto;background:#fff;
  padding:30px;border-radius:12px;
}
h1,h2{color:#2e7d32;margin-top:0}
table{
  width:100%;border-collapse:collapse;margin-top:12px;
}
th,td{
  border:1px solid #ccc;padding:8px;
}
th{background:#eef5ee}
.right{text-align:right}
.note{
  margin-top:10px;font-size:13px;color:#555
}
.badge{
  display:inline-block;
  padding:4px 10px;
  background:#2e7d32;color:#fff;
  border-radius:14px;font-size:13px
}
@media print{
  a[href]:after{content:""}
}
</style>
</head>

<body>
<div class="page">

<h1>ЁЯУИ ROI Detail Report</h1>
<span class="badge">5-Year Financial Analysis</span>

<!-- ================= LOAD DATA ================= -->
<script>
let key = localStorage.getItem("activeProject");
let p = key ? JSON.parse(localStorage.getItem(key)) : {};
</script>

<!-- ================= BASE PROFIT ================= -->
<h2>рез. рдЖрдзрд╛рд░рднреВрдд рдирд╛рдлрд╛ / рдирдЧрдж рдкреНрд░рд╡рд╛рд╣</h2>
<table>
<tr><th>рд╡рд┐рд╡рд░рдг</th><th class="right">рд░рдХрдо (рд░реБ.)</th></tr>
<tr><td>рдХреБрд▓ рдЖрдореНрджрд╛рдиреА</td><td class="right" id="income"></td></tr>
<tr><td>рдЪрд╛рд▓реБ рдЦрд░реНрдЪ</td><td class="right" id="operating"></td></tr>
<tr><td>рд╣реНрд░рд╛рд╕рдХрдЯреНрдЯреА</td><td class="right" id="depr"></td></tr>
<tr><td>рдмреИрдВрдХ рдмреНрдпрд╛рдЬ</td><td class="right" id="interest"></td></tr>
<tr><td>рдХрд░ рдЕрдШрд┐рдХреЛ рдирд╛рдлрд╛ (PBT)</td><td class="right" id="pbt"></td></tr>
<tr><td>рдХрд░ (реирел%)</td><td class="right" id="tax"></td></tr>
<tr><td><b>рдЦреБрдж рдирд╛рдлрд╛ (PAT)</b></td><td class="right" id="pat"></td></tr>
<tr><td><b>Operating Cash Flow</b></td><td class="right" id="ocf"></td></tr>
</table>

<!-- ================= ROI SUMMARY ================= -->
<h2>реи. рд▓рдЧрд╛рдиреА рдкреНрд░рддрд┐рдлрд▓ (ROI Indicators)</h2>
<table>
<tr><th>рд╕реВрдЪрдХ</th><th class="right">рдкрд░рд┐рдгрд╛рдо</th></tr>
<tr><td>рдкреНрд░рд╛рд░рдореНрднрд┐рдХ рд▓рдЧрд╛рдиреА</td><td class="right" id="investment"></td></tr>
<tr><td>Payback Period</td><td class="right" id="payback"></td></tr>
<tr><td>IRR (Approx)</td><td class="right" id="irr"></td></tr>
<tr><td>NPV @10% (5 Years)</td><td class="right" id="npv"></td></tr>
</table>

<!-- ================= BANK RATIOS ================= -->
<h2>рей. рдмреИрдВрдХ / рд╡рд┐рддреНрддреАрдп рдЕрдиреБрдкрд╛рдд</h2>
<table>
<tr><th>рдЕрдиреБрдкрд╛рдд</th><th class="right">рдореВрд▓реНрдп</th></tr>
<tr><td>DebtтАУEquity Ratio</td><td class="right" id="de"></td></tr>
<tr><td>Interest Coverage Ratio</td><td class="right" id="icr"></td></tr>
<tr><td>Cash Flow Adequacy Ratio</td><td class="right" id="cfa"></td></tr>
<tr><td>Operating Margin</td><td class="right" id="opm"></td></tr>
<tr><td>Dividend / Profit Distribution</td><td class="right" id="divr"></td></tr>
</table>

<p class="note">
тЬФя╕П рдпреЛ ROI Detail Page рдмреИрдВрдХ, рд╕рд╣рдХрд╛рд░реА, рд▓рдЧрд╛рдиреАрдХрд░реНрддрд╛ рддрдерд╛ рдЕрдиреБрджрд╛рди рдкреНрд░рдпреЛрдЬрдирдХрд╛ рд▓рд╛рдЧрд┐ рдкреНрд░рдпреЛрдЧ рдЧрд░реНрди рдорд┐рд▓реНрдиреЗ  
тЬФя╕П рд╕рдмреИ рдбрд╛рдЯрд╛ BPMS Entry рдмрд╛рдЯ рд╕реНрд╡рддрдГ рддрд╛рдирд┐рдПрдХреЛ рд╣реЛ
</p>

</div>

<script>
/* ================= INCOME ================= */
let totalIncome=0;
(p.incomeData||[]).forEach(i=>totalIncome+=Number(i.amount||0));

/* ================= EXPENSE ================= */
let operating=0, depreciation=0, interest=0, capital=0;
(p.expenseData||[]).forEach(e=>{
  let amt=Number(e.amount||0);
  let cat=(e.category||"").toLowerCase();
  let title=(e.title||"").toLowerCase();

  if(title.includes("рдмреНрдпрд╛рдЬ")) interest+=amt;
  else if(cat.includes("рдореЗрд╢реАрди")||cat.includes("рдФрдЬрд╛рд░")||cat.includes("рдкреВрд░реНрд╡рд╛рдзрд╛рд░")){
    depreciation+=amt*0.15;
    capital+=amt;
  }else{
    operating+=amt;
    if(cat.includes("рд▓рдЧрд╛рдиреА")) capital+=amt;
  }
});

/* ================= PROFIT ================= */
let PBT = totalIncome-operating-depreciation-interest;
let tax = PBT>0 ? PBT*0.25 : 0;
let PAT = PBT-tax;
let OCF = PAT + depreciation;

/* ================= INITIAL INVESTMENT ================= */
let s=p.shortInfo||{};
let investment = Number((s.bp_capital||"").replace(/[^\d]/g,"")) || capital;

/* ================= ROI ================= */
let payback = OCF>0 ? (investment/OCF).toFixed(2)+" рд╡рд░реНрд╖" : "N/A";

/* NPV */
let rate=0.10, npv=-investment;
for(let y=1;y<=5;y++) npv+=OCF/Math.pow(1+rate,y);

/* IRR (Approx) */
let irr = investment>0 ? ((PAT/investment)*100).toFixed(1)+" %" : "N/A";

/* ================= RATIOS ================= */
let debt = interest>0 ? interest*10 : 0;
let equity = investment-debt;
let DE = equity>0 ? (debt/equity).toFixed(2)+" : 1" : "N/A";
let ICR = interest>0 ? ((PBT+interest)/interest).toFixed(2) : "тИЮ";
let CFA = (OCF/(interest+investment/5)).toFixed(2);
let OPM = totalIncome>0 ? (((totalIncome-operating)/totalIncome)*100).toFixed(1)+" %" : "0 %";
let DIV = "60% Dividend / 40% Reinvestment";

/* ================= RENDER ================= */
income.innerText=Math.round(totalIncome);
operating.innerText=Math.round(operating);
depr.innerText=Math.round(depreciation);
interest.innerText=Math.round(interest);
pbt.innerText=Math.round(PBT);
tax.innerText=Math.round(tax);
pat.innerText=Math.round(PAT);
ocf.innerText=Math.round(OCF);

investment.innerText=Math.round(investment);
payback.innerText=payback;
irr.innerText=irr;
npv.innerText=Math.round(npv);

de.innerText=DE;
icr.innerText=ICR;
cfa.innerText=CFA;
opm.innerText=OPM;
divr.innerText=DIV;
</script>

</body>
</html>
