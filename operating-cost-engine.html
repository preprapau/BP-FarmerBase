/* =========================================================
   Farmerbase BP Engine
   Advanced Cost Allocation Engine (FINAL)
   ---------------------------------------------------------
   - Uses PRODUCTION_MASTER
   - Uses project.expenses
   - Checklist-based allocation
   - Operating cost only
   - Fixed cost excluded (ROI module uses it)
   ========================================================= */

(function(){

  function getActiveProject(){
    const key = localStorage.getItem("activeProject");
    if(!key) return null;
    return {
      key,
      data: JSON.parse(localStorage.getItem(key)) || {}
    };
  }

  function getProduction(){
    return JSON.parse(
      localStorage.getItem("PRODUCTION_MASTER")
    ) || [];
  }

  function runCostAllocation(){

    const projectWrap = getActiveProject();
    if(!projectWrap) return null;

    const project = projectWrap.data;
    const expenses = project.expenses || [];
    const products = getProduction();

    let allocation = {};

    /* -----------------------------------------
       STEP 1: Prepare production base
       ----------------------------------------- */
    products.forEach(p=>{
      const qty = Number(p.qty) || 0;
      if(qty === 0) return;

      allocation[p.id] = {
        productId: p.id,
        name: p.name,
        qty: qty,
        unit: p.unit || "",
        directCost: 0,
        allocatedCost: 0,
        totalCost: 0,
        unitCost: 0
      };
    });

    /* -----------------------------------------
       STEP 2: Filter operating expenses only
       ----------------------------------------- */
    const operatingExpenses = expenses.filter(e =>
      e.costType === "operating" &&
      Array.isArray(e.appliesTo) &&
      Number(e.amount) > 0
    );

    /* -----------------------------------------
       STEP 3: Allocate expenses
       ----------------------------------------- */
    operatingExpenses.forEach(e=>{
      const amount = Number(e.amount) || 0;

      // Case A: applies to ALL
      if(e.appliesTo.includes("all")){

        const totalQty = Object.values(allocation)
          .reduce((s,p)=>s+p.qty,0);

        Object.values(allocation).forEach(p=>{
          const share = totalQty > 0
            ? (p.qty / totalQty) * amount
            : 0;
          p.allocatedCost += share;
        });

      }
      // Case B: applies to specific products (array)
      else{

        const targets = e.appliesTo
          .filter(id => allocation[id]);

        const targetQty = targets
          .reduce((s,id)=>s+allocation[id].qty,0);

        targets.forEach(id=>{
          const p = allocation[id];
          const share = targetQty > 0
            ? (p.qty / targetQty) * amount
            : 0;
          p.directCost += share;
        });
      }
    });

    /* -----------------------------------------
       STEP 4: Final per-unit calculation
       ----------------------------------------- */
    Object.values(allocation).forEach(p=>{
      p.totalCost = p.directCost + p.allocatedCost;
      p.unitCost = p.qty > 0
        ? p.totalCost / p.qty
        : 0;
    });

    /* -----------------------------------------
       STEP 5: Save back to project
       ----------------------------------------- */
    project.costAllocation = allocation;
    localStorage.setItem(
      projectWrap.key,
      JSON.stringify(project)
    );

    return allocation;
  }

  /* -----------------------------------------
     Auto-run once on load
     ----------------------------------------- */
  runCostAllocation();

  /* -----------------------------------------
     Expose globally (optional)
     ----------------------------------------- */
  window.runCostAllocation = runCostAllocation;

})();
