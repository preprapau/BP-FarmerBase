<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Final Business Proposal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;margin:0;
}
.page{
  max-width:1000px;margin:25px auto;background:#fff;
  padding:30px;border-radius:12px;
}
h1,h2,h3{color:#2e7d32;margin-top:0}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#eef5ee}
.right{text-align:right}
.cat{background:#f1f8f2;font-weight:bold}
tfoot td{font-weight:bold;background:#f7fbf7}
@media print{
  a[href]:after{content:""}
}
</style>
</head>

<body>
<div class="page">

<h1 style="text-align:center">व्यवसाय प्रस्ताव</h1>

<!-- ================= SHORT INFO ================= -->
<h2>१. संक्षिप्त परिचय</h2>
<table>
<tr><th>व्यवसायको नाम</th><td id="bp_name"></td></tr>
<tr><th>स्थान</th><td id="bp_location"></td></tr>
<tr><th>सञ्चालक संस्था</th><td id="bp_org"></td></tr>
<tr><th>प्रोप्राइटर</th><td id="bp_owner"></td></tr>
<tr><th>सम्पर्क नम्बर</th><td id="bp_phone"></td></tr>
<tr><th>व्यवसायिक प्रकृति</th><td id="bp_products"></td></tr>
</table>

<h3>संस्थागत परिचय</h3>
<table>
<tr><th>दर्ता मिति</th><td id="reg_date"></td></tr>
<tr><th>दर्ता निकाय</th><td id="reg_authority"></td></tr>
<tr><th>दर्ता नं</th><td id="reg_no"></td></tr>
<tr><th>PAN नं</th><td id="pan_no"></td></tr>
</table>

<h3>लाभान्वित समूह</h3>
<table>
<tr><th>समूह प्रकार</th><td id="benef_group_type"></td></tr>
<tr><th>महिला</th><td id="female_count"></td></tr>
<tr><th>पुरुष</th><td id="male_count"></td></tr>
<tr><th>जम्मा</th><td id="total_count"></td></tr>
</table>

<!-- ================= BUSINESS DETAIL ================= -->
<h2>२. व्यवसायको विस्तृत विवरण</h2>
<div id="businessDetail"></div>

<!-- ================= PRODUCTION SALES ================= -->
<h2>३. उत्पादन तथा बिक्री योजना</h2>
<table>
<thead>
<tr>
<th>वर्ष</th>
<th>बयस्क संख्या</th>
<th>जन्मिएका (बाँचेक)</th>
<th>बिक्री (बच्चा)</th>
<th>बयस्क बिक्री</th>
<th>अर्को वर्षका बयस्क</th>
</tr>
</thead>
<tbody id="prodBody"></tbody>
</table>

<!-- ================= EXPENSE CATEGORY ================= -->
<h2>४. खर्च विवरण (विधागत)</h2>
<table>
<thead>
<tr><th>विधा</th><th>शीर्षक</th><th class="right">रकम</th></tr>
</thead>
<tbody id="expenseBody"></tbody>
<tfoot>
<tr><td colspan="2" class="right">कुल खर्च</td><td class="right" id="expTotal"></td></tr>
</tfoot>
</table>

<!-- ================= INCOME ================= -->
<h2>५. आम्दानी विवरण</h2>
<table>
<tr><th>कुल आम्दानी</th><td class="right" id="incTotal"></td></tr>
</table>

<!-- ================= PROFIT ================= -->
<h2>६. नाफा / नोक्सान</h2>
<table>
<tr><th>कुल आम्दानी</th><td class="right" id="pl_inc"></td></tr>
<tr><th>कुल खर्च</th><td class="right" id="pl_exp"></td></tr>
<tr><th>खुद नाफा</th><td class="right" id="pl_net"></td></tr>
</table>

</div>

<script>
let key=localStorage.getItem("activeProject");
let p=key?JSON.parse(localStorage.getItem(key)):{};

/* SHORT INFO */
let s=p.shortInfo||{};
["bp_name","bp_location","bp_org","bp_owner","bp_phone","bp_products",
 "reg_date","reg_authority","reg_no","pan_no",
 "benef_group_type","female_count","male_count","total_count"
].forEach(id=>{
  if(document.getElementById(id))
    document.getElementById(id).innerText=s[id]||"";
});

/* BUSINESS DETAIL */
let bd=document.getElementById("businessDetail");
(p.businessDetail||[]).forEach(d=>{
  bd.innerHTML+=`<h3>${d.topic}</h3><p>${d.content}</p>`;
});

/* PRODUCTION */
let ps=JSON.parse(localStorage.getItem("productionSalesPlan")||"null");
if(ps){
  let adult=ps.adult;
  for(let y=1;y<=5;y++){
    let born=adult*ps.breedRate/100*ps.kids;
    let alive=born*(100-ps.death)/100;
    let male=alive*ps.maleRate/100;
    let female=alive-male;
    let keepF=female*ps.keepFemale/100;
    let sellKids=alive-keepF;
    let sellAdult=adult*ps.replacement/100;

    prodBody.innerHTML+=`
    <tr>
      <td>${y}</td>
      <td>${Math.round(adult)}</td>
      <td>${Math.round(alive)}</td>
      <td>${Math.round(sellKids)}</td>
      <td>${Math.round(sellAdult)}</td>
      <td>${Math.round(adult+keepF)}</td>
    </tr>`;
    adult+=keepF;
  }
}

/* EXPENSE CATEGORY */
let expTotal=0;
let groups={};
(p.expenseData||[]).forEach(e=>{
  if(!groups[e.category])groups[e.category]=[];
  groups[e.category].push(e);
});
for(let c in groups){
  expenseBody.innerHTML+=`<tr class="cat"><td colspan="3">${c}</td></tr>`;
  groups[c].forEach(e=>{
    expTotal+=Number(e.amount||0);
    expenseBody.innerHTML+=`
    <tr>
      <td></td><td>${e.title}</td>
      <td class="right">${e.amount}</td>
    </tr>`;
  });
}
expTotalEl=document.getElementById("expTotal");
expTotalEl.innerText=Math.round(expTotal);

/* INCOME */
let inc=0;
(p.incomeData||[]).forEach(i=>inc+=Number(i.amount||0));
incTotal.innerText=Math.round(inc);

/* PROFIT */
pl_inc.innerText=Math.round(inc);
pl_exp.innerText=Math.round(expTotal);
pl_net.innerText=Math.round(inc-expTotal);
</script>

</body>
</html>
