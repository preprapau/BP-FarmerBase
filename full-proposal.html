<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Final Business Proposal | FarmerBase BPMS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:"Noto Sans Devanagari","Kalimati",system-ui;margin:0}
.page{max-width:1100px;margin:auto;padding:35px}
h1,h2,h3{color:#2e7d32}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #999;padding:6px}
th{background:#eef5ee}
.right{text-align:right}
.center{text-align:center}
.note{font-size:13px;color:#555}
@media print{a[href]:after{content:""}}
</style>
</head>

<body>
<div class="page">

<h1 id="title"></h1>

<!-- ================= LOAD DATA ================= -->
<script>
const key = localStorage.getItem("activeProject");
const p = key ? JSON.parse(localStorage.getItem(key)) : {};
const s = p.shortInfo || {};
const bd = p.businessDetail || [];
const ex = p.expenseData || [];
const inc = p.incomeData || [];
const prod = JSON.parse(localStorage.getItem("productionSalesPlan")||"{}");
const bankInterest = Number(localStorage.getItem("ANNUAL_LOAN_INTEREST")||0);
</script>

<!-- ================= SHORT INFO ================= -->
<h2>१. संक्षिप्त परिचय</h2>
<table>
<tr><th>व्यवसाय</th><td id="si_name"></td></tr>
<tr><th>स्थान</th><td id="si_location"></td></tr>
<tr><th>संस्था</th><td id="si_org"></td></tr>
<tr><th>प्रोप्राइटर</th><td id="si_owner"></td></tr>
<tr><th>सम्पर्क</th><td id="si_phone"></td></tr>
</table>

<h3>संस्थागत परिचय</h3>
<table>
<tr><th>दर्ता निकाय</th><td id="reg_auth"></td></tr>
<tr><th>दर्ता नं</th><td id="reg_no"></td></tr>
<tr><th>PAN</th><td id="pan_no"></td></tr>
</table>

<h3>लाभान्वित समूह</h3>
<table>
<tr><th>समूह</th><td id="bg_type"></td></tr>
<tr><th>महिला</th><td id="bg_female"></td></tr>
<tr><th>पुरुष</th><td id="bg_male"></td></tr>
<tr><th>जम्मा</th><td id="bg_total"></td></tr>
</table>

<!-- ================= BUSINESS DETAIL ================= -->
<h2>२. व्यवसाय विवरण</h2>
<div id="businessDetail"></div>

<!-- ================= EXPENSE ================= -->
<h2>४. खर्च विवरण (विधागत)</h2>
<table id="expenseTable">
<tr><th>विधा</th><th class="right">रकम</th></tr>
</table>

<!-- ================= FINANCING ================= -->
<h2>५. लगानीको स्रोत</h2>
<table>
<tr><th>स्रोत</th><th class="right">रकम</th></tr>
<tr><td>स्व–लगानी</td><td class="right" id="ownAmt"></td></tr>
<tr><td>अनुदान / प्रस्ताव</td><td class="right" id="grantAmt"></td></tr>
<tr><td>सहकारी / बैंक ऋण</td><td class="right" id="loanAmt"></td></tr>
<tr><td><b>वार्षिक बैंक ब्याज</b></td><td class="right" id="bankInt"></td></tr>
</table>

<!-- ================= PROFIT LOSS ================= -->
<h2>६. नाफा / नोक्सान (वार्षिक)</h2>
<table>
<tr><td>कुल आम्दानी</td><td class="right" id="pl_income"></td></tr>
<tr><td>चालु खर्च</td><td class="right" id="pl_operating"></td></tr>
<tr><td>ह्रासकट्टी</td><td class="right" id="pl_depr"></td></tr>
<tr><td>बैंक ब्याज</td><td class="right" id="pl_interest"></td></tr>
<tr><td>कर अघिको नाफा</td><td class="right" id="pl_pbt"></td></tr>
<tr><td>कर (२५%)</td><td class="right" id="pl_tax"></td></tr>
<tr><th>खुद नाफा</th><th class="right" id="pl_pat"></th></tr>
</table>

<!-- ================= ROI ================= -->
<h2>७. ५ वर्षे ROI (Year-wise)</h2>
<table>
<tr><th>वर्ष</th><th>आम्दानी</th><th>खर्च</th><th>नाफा</th><th>नगद प्रवाह</th></tr>
<tbody id="roiTable"></tbody>
</table>

<p class="note center">✔ FarmerBase BPMS – Final Freeze Proposal</p>

<script>
/* ===== Render Short Info ===== */
title.innerText = s.bp_name || "व्यवसायिक प्रस्ताव";
si_name.innerText=s.bp_name||"";
si_location.innerText=s.bp_location||"";
si_org.innerText=s.bp_org||"";
si_owner.innerText=s.bp_owner||"";
si_phone.innerText=s.bp_phone||"";
reg_auth.innerText=s.reg_authority||"";
reg_no.innerText=s.reg_no||"";
pan_no.innerText=s.pan_no||"";
bg_type.innerText=s.benef_group_type||"";
bg_female.innerText=s.female_count||0;
bg_male.innerText=s.male_count||0;
bg_total.innerText=s.total_count||0;

/* ===== Business Detail ===== */
businessDetail.innerHTML = bd.length
 ? bd.map(d=>`<h4>${d.topic}</h4><p>${d.content}</p>`).join("")
 : "<i>विवरण उपलब्ध छैन</i>";


/* ===== Expense ===== */
let eg={},operating=0,depr=0,capital=0;
ex.forEach(e=>{
 eg[e.category]=(eg[e.category]||0)+Number(e.amount||0);
 if(e.category.includes("मेशीन")||e.category.includes("पूर्वाधार")){
   depr+=e.amount*0.15; capital+=e.amount;
 } else operating+=e.amount;
});
Object.keys(eg).forEach(c=>{
 expenseTable.innerHTML+=`<tr><td>${c}</td><td class="right">${Math.round(eg[c])}</td></tr>`;
});

/* ===== Financing ===== */
const own=capital*(p.ownPct||40)/100;
const grant=capital*(p.grantPct||30)/100;
const loan=capital*(p.loanPct||30)/100;
ownAmt.innerText=Math.round(own);
grantAmt.innerText=Math.round(grant);
loanAmt.innerText=Math.round(loan);
bankInt.innerText=Math.round(bankInterest);

/* ===== Profit ===== */
let income=inc.reduce((s,i)=>s+Number(i.amount||0),0);
let pbt=income-operating-depr-bankInterest;
let tax=pbt>0?pbt*0.25:0;
let pat=pbt-tax;
pl_income.innerText=Math.round(income);
pl_operating.innerText=Math.round(operating);
pl_depr.innerText=Math.round(depr);
pl_interest.innerText=Math.round(bankInterest);
pl_pbt.innerText=Math.round(pbt);
pl_tax.innerText=Math.round(tax);
pl_pat.innerText=Math.round(pat);

/* ===== ROI ===== */
let cash=pat+depr;
for(let y=1;y<=5;y++){
 roiTable.innerHTML+=`
 <tr><td>${y}</td>
 <td>${Math.round(income)}</td>
 <td>${Math.round(operating+depr+bankInterest)}</td>
 <td>${Math.round(pat)}</td>
 <td>${Math.round(cash)}</td></tr>`;
}
</script>

</div>
</body>
</html>
