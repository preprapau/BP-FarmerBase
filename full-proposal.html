<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Business Proposal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
@page{margin:25mm}
body{
  font-family:"Noto Sans Devanagari","Kalimati","Mangal","Nirmala UI",system-ui,Arial;
  margin:0;background:#f4f7f6
}
.page{
  max-width:900px;margin:0 auto;background:#fff;
  padding:30px;position:relative;z-index:1
}
h1,h2,h3{color:#1b5e20}
h1{font-size:28px}
h2{margin-top:32px;border-bottom:2px solid #c8e6c9;padding-bottom:6px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#f1f8e9}
.right{text-align:right}
.center{text-align:center}

/* LETTERHEAD */
.letterhead{display:flex;align-items:center;gap:15px;border-bottom:3px solid #2e7d32;padding-bottom:10px;margin-bottom:20px}
.lh-left img{height:70px;max-width:120px;object-fit:contain}
.lh-center{flex:1;text-align:center}
.lh-org{font-size:22px;font-weight:700;color:#1b5e20}
.lh-tagline{font-size:14px;color:#555}
.lh-address{font-size:13px;color:#333}

/* COVER */
.cover{height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}

/* WATERMARK */
.watermark-img{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:520px;height:520px;background:url("project-image.jpg") center/contain no-repeat;
  opacity:0.05;pointer-events:none;z-index:0
}

/* SUMMARY */
.summary-box{border:2px solid #c8e6c9;background:#f1f8e9;padding:15px;border-radius:8px}

/* MAP */
iframe{width:100%;height:260px;border:0;margin-top:10px}

/* TOC */
#autoTOC ol{padding-left:20px}
#autoTOC a{text-decoration:none;color:#000}

/* WARNING */
.warn{border:2px solid #f44336;background:#ffebee;padding:12px;border-radius:8px;color:#b71c1c;margin-bottom:15px}

/* FOOTER */
footer{text-align:center;font-size:12px;color:#555;margin-top:40px}

/* PAGE BREAK */
.page-break{page-break-before:always}

/* PRINT */
.no-print{display:block}
@media print{
  body{background:#fff}
  .no-print{display:none}
  table{page-break-inside:avoid}
  h2{page-break-after:avoid}
}
</style>
</head>

<body>

<div class="watermark-img"></div>

<!-- ================= COVER ================= -->
<div class="page cover">
  <h1 id="cProject"></h1>
  <h2 data-key="proposalTitle"></h2>
  <p><b id="cOrg"></b></p>
  <p id="cAddress"></p>
  <p><span data-key="dateLabel"></span>: <span id="cDate"></span></p>
</div>

<div class="page-break"></div>

<!-- ================= CONTENT ================= -->
<div class="page">

<!-- LANGUAGE TOGGLE -->
<div class="no-print" style="text-align:right;margin-bottom:10px">
  <button onclick="setLang('ne')">üá≥üáµ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä</button>
  <button onclick="setLang('en')">üá¨üáß English</button>
</div>

<!-- LETTERHEAD -->
<div class="letterhead">
  <div class="lh-left"><img id="orgLogo" alt="Logo"></div>
  <div class="lh-center">
    <div class="lh-org" id="lhOrgName"></div>
    <div class="lh-tagline" id="lhTagline"></div>
    <div class="lh-address" id="lhAddress"></div>
  </div>
</div>

<div id="siWarning"></div>

<h2 data-key="execSummaryTitle"></h2>
<div class="summary-box" id="execSummary"></div>

<h2 data-key="tocTitle"></h2>
<div id="autoTOC"></div>

<h2 data-key="overview"></h2>
<p id="pDesc"></p>

<h2 data-key="orgDetails"></h2>
<table>
<tr><th data-key="orgName"></th><td id="oName"></td></tr>
<tr><th data-key="address"></th><td id="oAddr"></td></tr>
<tr><th data-key="regDate"></th><td id="oRegDate"></td></tr>
<tr><th data-key="regBody"></th><td id="oRegBody"></td></tr>
<tr><th data-key="regNo"></th><td id="oRegNo"></td></tr>
<tr><th data-key="pan"></th><td id="oPan"></td></tr>
</table>

<h2 data-key="location"></h2>
<iframe id="mapFrame"></iframe>

<h2 data-key="expenseDetails"></h2>
<div id="expenseTable"></div>

<h2 data-key="incomeDetails"></h2>
<div id="incomeTable"></div>

<h2 data-key="profitROI"></h2>
<table>
<tr><th data-key="investment"></th><td class="right" id="roiInv"></td></tr>
<tr><th data-key="totalReturn"></th><td class="right" id="roiReturn"></td></tr>
<tr><th data-key="roi"></th><td class="right" id="roiPct"></td></tr>
<tr><th data-key="payback"></th><td id="roiPay"></td></tr>
</table>

<!-- ANNEX -->
<h2 data-annex="shortInfo"></h2>
<div id="annexShortInfo"></div>

<footer>
  ¬© <span id="fYear"></span> <span id="fOrg"></span> | <span id="fTag"></span>
</footer>

</div>

<script>
/* ================= LOAD PROJECT ================= */
let key = localStorage.getItem("activeProject");
if(!key){ alert("Project open ‡§õ‡•à‡§®"); location.href="index.html"; }
let p = JSON.parse(localStorage.getItem(key));
let si = p.shortInfo || {};

/* ================= LANGUAGE DICTIONARY ================= */
const LANG={
  ne:{
    proposalTitle:"‡§ï‡•É‡§∑‡§ø ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ",
    dateLabel:"‡§Æ‡§ø‡§§‡§ø",
    execSummaryTitle:"‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ (Executive Summary)",
    tocTitle:"‡§µ‡§ø‡§∑‡§Ø ‡§∏‡•Ç‡§ö‡•Ä (Table of Contents)",
    overview:"‡•ß. ‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§ï‡•ã ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£",
    orgDetails:"‡•®. ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£",
    location:"‡•©. ‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∏‡•ç‡§•‡§æ‡§®",
    expenseDetails:"‡•™. ‡§µ‡§ø‡§ß‡§æ‡§ó‡§§ ‡§ñ‡§∞‡•ç‡§ö ‡§µ‡§ø‡§µ‡§∞‡§£",
    incomeDetails:"‡•´. ‡§Ü‡§Æ‡•ç‡§¶‡§æ‡§®‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£",
    profitROI:"‡•¨. ‡§®‡§æ‡§´‡§æ ‡§§‡§•‡§æ ROI ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£",
    orgName:"‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ ‡§®‡§æ‡§Æ",
    address:"‡§†‡•á‡§ó‡§æ‡§®‡§æ",
    regDate:"‡§¶‡§∞‡•ç‡§§‡§æ ‡§Æ‡§ø‡§§‡§ø",
    regBody:"‡§¶‡§∞‡•ç‡§§‡§æ ‡§®‡§ø‡§ï‡§æ‡§Ø",
    regNo:"‡§¶‡§∞‡•ç‡§§‡§æ ‡§®‡§Ç",
    pan:"‡§™‡§æ‡§® ‡§®‡§Ç",
    investment:"‡§ï‡•Å‡§≤ ‡§≤‡§ó‡§æ‡§®‡•Ä",
    totalReturn:"‡•´ ‡§µ‡§∞‡•ç‡§∑‡•á ‡§ï‡•Å‡§≤ ‡§®‡§æ‡§´‡§æ",
    roi:"ROI (%)",
    payback:"Payback Period",
    execSummary:(si)=>`
      <b>${si.businessName||""}</b> ‡§®‡§æ‡§Æ‡§ï ‡§Ø‡•ã
      ${si.businessType||"‡§ï‡•É‡§∑‡§ø"} ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø
      ${si.location||""} ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§Æ‡§æ ‡§∏‡§û‡•ç‡§ö‡§æ‡§≤‡§® ‡§ó‡§∞‡§ø‡§®‡•á
      ${si.startYear||""} ‡§¶‡•á‡§ñ‡§ø
      ${si.duration||""} ‡§µ‡§∞‡•ç‡§∑ ‡§Ö‡§µ‡§ß‡§ø‡§ï‡•ã ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§π‡•ã‡•§
      <br><br>
      ‡§Ø‡§∏ ‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§¨‡§æ‡§ü ${si.beneficiaryType||""} ‡§∏‡§Æ‡•Ç‡§π‡§ï‡§æ
      ‡§ú‡§Æ‡•ç‡§Æ‡§æ <b>${si.totalBeneficiary||(Number(si.femaleCount||0)+Number(si.maleCount||0))}</b>
      ‡§ú‡§®‡§æ ‡§≤‡§æ‡§≠‡§æ‡§®‡•ç‡§µ‡§ø‡§§ ‡§π‡•Å‡§®‡•á‡§õ‡§®‡•ç‡•§
    `
  },
  en:{
    proposalTitle:"Business Proposal",
    dateLabel:"Date",
    execSummaryTitle:"Executive Summary",
    tocTitle:"Table of Contents",
    overview:"1. Project Overview",
    orgDetails:"2. Organization Details",
    location:"3. Project Location",
    expenseDetails:"4. Expense Details",
    incomeDetails:"5. Income Details",
    profitROI:"6. Profit and ROI Analysis",
    orgName:"Organization Name",
    address:"Address",
    regDate:"Registration Date",
    regBody:"Registering Authority",
    regNo:"Registration No.",
    pan:"PAN No.",
    investment:"Total Investment",
    totalReturn:"Total Return (5 Years)",
    roi:"ROI (%)",
    payback:"Payback Period",
    execSummary:(si)=>`
      The project titled <b>${si.businessName||""}</b> is a
      ${si.businessType||"agricultural"} enterprise located in
      ${si.location||""}. The project will be implemented for
      ${si.duration||""} years starting from ${si.startYear||""}.
      <br><br>
      The project will directly benefit a total of
      <b>${si.totalBeneficiary||(Number(si.femaleCount||0)+Number(si.maleCount||0))}</b>
      people under the ${si.beneficiaryType||""} group.
    `
  }
};

/* ================= LETTERHEAD BILINGUAL ================= */
const LETTERHEAD_LANG={
  ne:{tagline:(si)=>si.businessType?`(${si.businessType} ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø)`:"‡§ï‡•É‡§∑‡§ø ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ",
      footer:"FarmerBase BPMS ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§§‡§Ø‡§æ‡§∞ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã"},
  en:{tagline:(si)=>si.businessType?`(${si.businessType} Enterprise)`:"Business Proposal",
      footer:"Generated by FarmerBase BPMS"}
};

/* ================= APPLY LANGUAGE ================= */
function setLang(lang){
  localStorage.setItem("proposalLang",lang);
  applyLang();
}
function applyLang(){
  const lang = localStorage.getItem("proposalLang") || "ne";
  const L = LANG[lang];

  document.querySelectorAll("[data-key]").forEach(el=>{
    const k = el.getAttribute("data-key");
    if(L[k]) el.innerHTML = L[k];
  });

  execSummary.innerHTML = L.execSummary(si);
  applyLetterheadLang();
  generateTOCBilingual();
  applyAnnexBilingual();
  appendAnnexToTOC();
}

/* ================= LETTERHEAD APPLY ================= */
function applyLetterheadLang(){
  const lang = localStorage.getItem("proposalLang") || "ne";
  const L = LETTERHEAD_LANG[lang];
  orgLogo.src = si.logoURL || "logo.png";
  lhOrgName.innerText = si.organization || "";
  lhTagline.innerText = L.tagline(si);
  lhAddress.innerText = si.location || "";
  fOrg.innerText = si.organization || "";
  fYear.innerText = new Date().getFullYear();
  fTag.innerText = L.footer;
}

/* ================= TOC BILINGUAL ================= */
function generateTOCBilingual(){
  const lang = localStorage.getItem("proposalLang") || "ne";
  const L = LANG[lang];
  const toc = document.getElementById("autoTOC");
  const heads = document.querySelectorAll(".page h2[data-key]");
  let html="<ol>", n=1;
  heads.forEach(h=>{
    const key=h.getAttribute("data-key");
    const id="sec_"+n; h.id=id;
    const title=L[key]||h.innerText;
    h.innerHTML=title;
    html+=`<li><a href="#${id}">${title}</a></li>`;
    n++;
  });
  html+="</ol>"; toc.innerHTML=html;
}

/* ================= ANNEX BILINGUAL ================= */
const ANNEX={
  ne:{shortInfo:"‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§ï‡•ã ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£"},
  en:{shortInfo:"Project Summary"}
};
function applyAnnexBilingual(){
  const lang = localStorage.getItem("proposalLang") || "ne";
  let letter=0;
  document.querySelectorAll("[data-annex]").forEach(h=>{
    const k=h.getAttribute("data-annex");
    const L=String.fromCharCode(65+letter);
    h.id="annex_"+L;
    h.innerHTML=`Annex ${L} : ${ANNEX[lang][k]||""}`;
    letter++;
  });
}
function appendAnnexToTOC(){
  const toc=document.getElementById("autoTOC");
  let html="<h4>Annex</h4><ul>";
  document.querySelectorAll("[data-annex]").forEach(h=>{
    html+=`<li><a href="#${h.id}">${h.innerText}</a></li>`;
  });
  html+="</ul>";
  toc.innerHTML+=html;
}

/* ================= DATA INSERT ================= */
/* Cover */
cProject.innerText = si.businessName || "Business";
cOrg.innerText = si.organization || "";
cAddress.innerText = si.location || "";
cDate.innerText = new Date().toLocaleDateString("ne-NP");

/* Validation */
let miss=[];
["businessName","organization","location","beneficiaryType"].forEach(k=>{if(!si[k]) miss.push(k);});
if(miss.length){ siWarning.innerHTML=`<div class="warn">‚ö†Ô∏è Short-info incomplete: ${miss.join(", ")}</div>`; }

/* Description */
pDesc.innerText = si.description || "";

/* Org table */
oName.innerText=si.organization||""; oAddr.innerText=si.location||"";
oRegDate.innerText=si.regDate||""; oRegBody.innerText=si.regBody||"";
oRegNo.innerText=si.regNo||""; oPan.innerText=si.pan||"";

/* Map */
mapFrame.src="https://www.google.com/maps?q="+encodeURIComponent(si.location||"Nepal")+"&output=embed";

/* Expense */
let eHtml="<table><tr><th>Category</th><th>Title</th><th>Amount</th></tr>";
(p.expenseData||[]).forEach(e=>{ eHtml+=`<tr><td>${e.category}</td><td>${e.title}</td><td class="right">${e.amount}</td></tr>`; });
expenseTable.innerHTML=eHtml+"</table>";

/* Income */
let iHtml="<table><tr><th>Title</th><th>Amount</th></tr>";
(p.incomeData||[]).forEach(i=>{ iHtml+=`<tr><td>${i.title}</td><td class="right">${i.amount}</td></tr>`; });
incomeTable.innerHTML=iHtml+"</table>";

/* ROI */
roiInv.innerText=p.fiveYearROI?.investment||0;
roiReturn.innerText=p.fiveYearROI?.totalReturn||0;
roiPct.innerText=p.fiveYearROI?.roi||0;
roiPay.innerText=p.fiveYearROI?.payback||"";

/* Annex table */
let rows="";
Object.entries({
 "Business Name":si.businessName,
 "Business Type":si.businessType,
 "Location":si.location,
 "Beneficiary Type":si.beneficiaryType,
 "Female":si.femaleCount,
 "Male":si.maleCount,
 "Total":si.totalBeneficiary
}).forEach(([k,v])=>{ rows+=`<tr><th>${k}</th><td>${v||""}</td></tr>`; });
annexShortInfo.innerHTML="<table>"+rows+"</table>";

/* Init */
applyLang();
</script>

</body>
</html>
