<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Business Proposal</title>

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati","Mangal",system-ui,Arial;
  line-height:1.6;color:#000
}
h1,h2,h3{color:#1b5e20}
table{border-collapse:collapse;width:100%;margin:10px 0}
th,td{border:1px solid #999;padding:6px}
th{background:#eef5ee}
.page{page-break-after:always}
.annex{page-break-before:always}
.center{text-align:center}
.small{font-size:13px;color:#555}

/* screen only */
.no-print{}

/* buttons */
.toggle,.print-btn{
  position:fixed;right:15px;padding:8px 14px;
  background:#2e7d32;color:#fff;border:none;
  border-radius:6px;cursor:pointer
}
.toggle{top:15px}
.print-btn{bottom:15px}

/* print */
@media print{
  .no-print,button{display:none!important}
  @page{size:A4;margin:18mm}
  body{font-size:14px}
}
</style>
</head>

<body>

<button class="toggle no-print" onclick="toggleAutoEN()">NE / EN</button>
<button class="print-btn no-print" onclick="window.print()">ЁЯЦия╕П Print / PDF</button>

<!-- ================= COVER ================= -->
<div class="page center">
<h1>рдХреГрд╖рд┐ рд╡реНрдпрд╡рд╕рд╛рдпрд┐рдХ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдкреНрд░рд╕реНрддрд╛рд╡</h1>
<h2 id="projectName">тАФ</h2>
<p>
<b id="orgName">тАФ</b><br>
<span id="orgAddress">тАФ</span>
</p>
<p class="small">рдкреНрд░рд╕реНрддрд╛рд╡ рдорд┐рддрд┐ : <span id="proposalDate"></span></p>
</div>

<!-- ================= TOC ================= -->
<div class="page">
<h2>рд╡рд┐рд╖рдп рд╕реВрдЪреА</h2>
<ol>
<li>рд╕рдВрдХреНрд╖рд┐рдкреНрдд рд╡рд┐рд╡рд░рдг</li>
<li>рд╡реНрдпрд╡рд╕рд╛рдп рд╡рд┐рд╡рд░рдг</li>
<li>рдЖрд░реНрдерд┐рдХ рд╡рд┐рд╢реНрд▓реЗрд╖рдг</li>
<li>рдирд╛рдлрд╛ / рдиреЛрдХреНрд╕рд╛рди</li>
<li>рдкрд░рд┐рд╢рд┐рд╖реНрдЯ</li>
</ol>
</div>

<!-- ================= SHORT INFO ================= -->
<div class="page">
<h2>рд╕рдВрдХреНрд╖рд┐рдкреНрдд рд╡рд┐рд╡рд░рдг</h2>
<p id="shortInfoBox">тАФ</p>
</div>

<!-- ================= BUSINESS DETAIL ================= -->
<div class="page">
<h2>рд╡реНрдпрд╡рд╕рд╛рдп рд╡рд┐рд╡рд░рдг</h2>
<p id="bizDetail">тАФ</p>
</div>

<!-- ================= FINANCIAL SUMMARY ================= -->
<div class="page">
<h2>рдЖрд░реНрдерд┐рдХ рд╡рд┐рд╢реНрд▓реЗрд╖рдг</h2>
<table>
<tr><th>рдХреБрд▓ рдЦрд░реНрдЪ</th><td id="sumExpense">тАФ</td></tr>
<tr><th>рдХреБрд▓ рдЖрдореНрджрд╛рдиреА</th><td id="sumIncome">тАФ</td></tr>
<tr><th>рд╡рд╛рд░реНрд╖рд┐рдХ рдирд╛рдлрд╛</th><td id="sumProfit">тАФ</td></tr>
</table>
</div>

<!-- ================= ANNEX : MAP ================= -->
<div class="annex">
<h2>рдкрд░рд┐рд╢рд┐рд╖реНрдЯ : рдкрд░рд┐рдпреЛрдЬрдирд╛ рд╕реНрдерд╛рди</h2>
<iframe id="mapFrame" width="100%" height="380" style="border:0"></iframe>
</div>

<script>
/* ================= AUTO PICK PROJECT ================= */
let project=null;

// 1. try activeProject
const activeKey = localStorage.getItem("activeProject");
if(activeKey && localStorage.getItem(activeKey)){
  project = JSON.parse(localStorage.getItem(activeKey));
}

// 2. fallback: last saved object
if(!project){
  for(let i=localStorage.length-1;i>=0;i--){
    try{
      const k = localStorage.key(i);
      const obj = JSON.parse(localStorage.getItem(k));
      if(obj && typeof obj==="object"){
        project = obj;
        break;
      }
    }catch(e){}
  }
}

// final fallback
project = project || {};

/* ================= SAFE READERS ================= */
const get = (...keys)=>{
  for(const k of keys){
    if(project[k]!==undefined && project[k]!==null) return project[k];
  }
  return "тАФ";
};

const getArr = (...keys)=>{
  for(const k of keys){
    if(Array.isArray(project[k])) return project[k];
  }
  return [];
};

/* ================= FILL BASIC ================= */
projectName.innerText = get("projectName","name","title");
orgName.innerText = get("orgName","organization","organizationName");
orgAddress.innerText = get("address","orgAddress","location");

/* ================= SHORT INFO ================= */
shortInfoBox.innerHTML = `
<b>${get("orgName","organization","organizationName")}</b><br>
рджрд░реНрддрд╛ рдирдВ: ${get("regNo","registrationNo")} |
PAN: ${get("panNo","pan")}<br>
рд▓рд╛рднрд╛рдиреНрд╡рд┐рдд рд╕рдореВрд╣: ${get("beneficiaryType","beneficiary")}<br>
рдорд╣рд┐рд▓рд╛: ${get("female","women",0)},
рдкреБрд░реБрд╖: ${get("male","men",0)}
`;

/* ================= BUSINESS DETAIL ================= */
bizDetail.innerHTML = `
<b>рдЙрджреНрджреЗрд╢реНрдп:</b> ${get("objective","goal")}<br>
<b>рд╕реНрдерд╛рди:</b> ${get("location","address")}<br>
<b>рдЕрд╡рдзрд┐:</b> ${get("duration","period")}
`;

/* ================= FINANCIAL ================= */
let expense=0,income=0;
getArr("expenses","expenseData").forEach(e=>expense+=Number(e.amount||0));
getArr("incomes","incomeData").forEach(i=>income+=Number(i.amount||0));
const profit = income-expense;

sumExpense.innerText = expense.toLocaleString();
sumIncome.innerText = income.toLocaleString();
sumProfit.innerText = profit.toLocaleString();

/* ================= MAP ================= */
const loc = get("location","address");
if(loc!=="тАФ"){
  mapFrame.src =
   "https://maps.google.com/maps?q="+
   encodeURIComponent(loc)+"&z=13&output=embed";
}

/* ================= DATE ================= */
proposalDate.innerText = new Date().toLocaleDateString();

/* ================= AUTO ENGLISH ================= */
const dict={
 "рдХреГрд╖рд┐ рд╡реНрдпрд╡рд╕рд╛рдпрд┐рдХ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдкреНрд░рд╕реНрддрд╛рд╡":"Agricultural Business Proposal",
 "рд╡рд┐рд╖рдп рд╕реВрдЪреА":"Table of Contents",
 "рд╕рдВрдХреНрд╖рд┐рдкреНрдд рд╡рд┐рд╡рд░рдг":"Executive Summary",
 "рд╡реНрдпрд╡рд╕рд╛рдп рд╡рд┐рд╡рд░рдг":"Business Details",
 "рдЖрд░реНрдерд┐рдХ рд╡рд┐рд╢реНрд▓реЗрд╖рдг":"Financial Analysis",
 "рдХреБрд▓ рдЦрд░реНрдЪ":"Total Expense",
 "рдХреБрд▓ рдЖрдореНрджрд╛рдиреА":"Total Income",
 "рд╡рд╛рд░реНрд╖рд┐рдХ рдирд╛рдлрд╛":"Annual Net Profit",
 "рдкрд░рд┐рд╢рд┐рд╖реНрдЯ":"Annex",
 "рдкрд░рд┐рдпреЛрдЬрдирд╛ рд╕реНрдерд╛рди":"Project Location",
 "рдкреНрд░рд╕реНрддрд╛рд╡ рдорд┐рддрд┐":"Proposal Date"
};

let en=false;
function toggleAutoEN(){
 en=!en;
 document.querySelectorAll("h1,h2,h3,p,th,td,li").forEach(el=>{
   if(!el.dataset.ne) el.dataset.ne=el.innerText.trim();
   el.dataset.en = dict[el.dataset.ne] || el.dataset.ne;
   el.innerText = en ? el.dataset.en : el.dataset.ne;
 });
 document.documentElement.lang=en?"en":"ne";
}
</script>

</body>
</html>
