<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>Final Proposal | FarmerBase BPMS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;margin:0
}
.page{
  max-width:1100px;margin:25px auto;background:#fff;
  padding:30px;border-radius:12px
}
h1,h2,h3{color:#2e7d32;margin-top:0}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border:1px solid #ccc;padding:8px}
th{background:#eef5ee}
.right{text-align:right}
.note{font-size:13px;color:#555;margin-top:8px}

@media print{
  a[href]:after{content:""}
  button{display:none}
}
</style>
</head>

<body>
<div class="page">

<h1>ЁЯУД рд╡реНрдпрд╡рд╕рд╛рдпрд┐рдХ рдкреНрд░рд╕реНрддрд╛рд╡ (Final)</h1>

<!-- ================= SHORT INFO ================= -->
<h2>рез. рд╕рдВрдХреНрд╖рд┐рдкреНрдд рд╡рд┐рд╡рд░рдг</h2>
<table>
<tr><th>рд╡реНрдпрд╡рд╕рд╛рдп рдирд╛рдо</th><td id="si_name"></td></tr>
<tr><th>рд╕реНрдерд╛рди</th><td id="si_location"></td></tr>
<tr><th>рд╕рдВрд╕реНрдерд╛</th><td id="si_org"></td></tr>
<tr><th>рдкреНрд░реЛрдкреНрд░рд╛рдЗрдЯрд░</th><td id="si_owner"></td></tr>
<tr><th>рд╕рдореНрдкрд░реНрдХ</th><td id="si_phone"></td></tr>
</table>

<!-- ================= EXPENSE (CATEGORY WISE) ================= -->
<h2>реи. рдЦрд░реНрдЪ рд╡рд┐рд╡рд░рдг (рд╡рд┐рдзрд╛рдЧрдд)</h2>
<table>
<thead>
<tr>
  <th>рд╡рд┐рдзрд╛</th>
  <th>рд╢реАрд░реНрд╖рдХ</th>
  <th class="right">рд░рдХрдо</th>
</tr>
</thead>
<tbody id="expBody"></tbody>
<tfoot>
<tr>
  <th colspan="2" class="right">рдХреБрд▓ рдЪрд╛рд▓реБ рдЦрд░реНрдЪ</th>
  <th class="right" id="opTotal"></th>
</tr>
<tr>
  <th colspan="2" class="right">рд╣реНрд░рд╛рд╕рдХрдЯреНрдЯреА</th>
  <th class="right" id="depTotal"></th>
</tr>
</tfoot>
</table>

<!-- ================= PROFIT / LOSS ================= -->
<h2>рей. рдирд╛рдлрд╛ / рдиреЛрдХреНрд╕рд╛рди рд╡рд┐рд╡рд░рдг</h2>
<table>
<tr><td>рдХреБрд▓ рдЖрдореНрджрд╛рдиреА</td><td class="right" id="inc"></td></tr>
<tr><td>рдЪрд╛рд▓реБ рдЦрд░реНрдЪ</td><td class="right" id="op"></td></tr>
<tr><td>рд╣реНрд░рд╛рд╕рдХрдЯреНрдЯреА</td><td class="right" id="dep"></td></tr>
<tr><td>рдмреИрдВрдХ рдмреНрдпрд╛рдЬ</td><td class="right" id="int"></td></tr>
<tr><td><b>рдХрд░ рдЕрдШрд┐рдХреЛ рдирд╛рдлрд╛ (PBT)</b></td><td class="right" id="pbt"></td></tr>
<tr><td>рдХрд░ (реирел%)</td><td class="right" id="tax"></td></tr>
<tr><td><b>рдЦреБрдж рдирд╛рдлрд╛ (PAT)</b></td><td class="right" id="pat"></td></tr>
</table>

<!-- ================= ROI ================= -->
<h2>рек. рел рд╡рд░реНрд╖реЗ ROI рд╕рд╛рд░рд╛рдВрд╢</h2>
<table>
<tr><td>рдкреНрд░рд╛рд░рдореНрднрд┐рдХ рд▓рдЧрд╛рдиреА</td><td class="right" id="inv"></td></tr>
<tr><td>Payback Period</td><td class="right" id="payback"></td></tr>
<tr><td>IRR (Approx)</td><td class="right" id="irr"></td></tr>
<tr><td>NPV (10%)</td><td class="right" id="npv"></td></tr>
</table>

<p class="note">
тЬФя╕П рдмреНрдпрд╛рдЬ Financing Source рдмрд╛рдЯ рд▓рд┐рдЗрдПрдХреЛ рдЫ  
тЬФя╕П Expense рдорд╛ рдмреНрдпрд╛рдЬ рдЦреЛрдЬрд┐рдБрджреИрди  
тЬФя╕П Bank Proposal / Grant Friendly
</p>

</div>

<script>
/* ================= LOAD PROJECT ================= */
let key = localStorage.getItem("activeProject");
let p = key ? JSON.parse(localStorage.getItem(key)) : {};

/* ================= SHORT INFO ================= */
let s = p.shortInfo||{};
si_name.innerText = s.bp_name||"";
si_location.innerText = s.bp_location||"";
si_org.innerText = s.bp_org||"";
si_owner.innerText = s.bp_owner||"";
si_phone.innerText = s.bp_phone||"";

/* ================= INCOME ================= */
let income = 0;
(p.incomeData||[]).forEach(i=>income+=Number(i.amount||0));
inc.innerText = Math.round(income);

/* ================= EXPENSE ================= */
let op=0, dep=0;
let body=document.getElementById("expBody");
(p.expenseData||[]).forEach(e=>{
  let amt=Number(e.amount||0);
  body.innerHTML+=`
    <tr>
      <td>${e.category}</td>
      <td>${e.title}</td>
      <td class="right">${amt}</td>
    </tr>`;
  if(e.category==="рдореЗрд╢реАрди рдФрдЬрд╛рд░ / рдкреНрд░рд╡рд┐рдзрд┐" || e.category==="рдкреВрд░реНрд╡рд╛рдзрд╛рд░ рдирд┐рд░реНрдорд╛рдг")
    dep+=amt*0.15;
  else
    op+=amt;
});
opTotal.innerText=Math.round(op);
depTotal.innerText=Math.round(dep);

/* ================= BANK INTEREST (FINAL FIX) ================= */
let interest = Number(localStorage.getItem("ANNUAL_LOAN_INTEREST")) || 0;
int.innerText = Math.round(interest);

/* ================= PROFIT ================= */
let PBT = income - op - dep - interest;
let tax = PBT>0 ? PBT*0.25 : 0;
let PAT = PBT - tax;

op.innerText=Math.round(op);
dep.innerText=Math.round(dep);
pbt.innerText=Math.round(PBT);
tax.innerText=Math.round(tax);
pat.innerText=Math.round(PAT);

/* ================= ROI ================= */
let investment = Number((s.bp_capital||"").replace(/[^\d]/g,""))||0;
inv.innerText = investment;

let ocf = PAT + dep;
payback.innerText = ocf>0 ? (investment/ocf).toFixed(2)+" рд╡рд░реНрд╖" : "N/A";
irr.innerText = investment>0 ? ((PAT/investment)*100).toFixed(1)+" %" : "N/A";

let rate=0.10,npv=-investment;
for(let y=1;y<=5;y++) npv+=ocf/Math.pow(1+rate,y);
npv.innerText=Math.round(npv);
</script>

</body>
</html>
