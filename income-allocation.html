<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>рдЖрдореНрджрд╛рдиреА рдмрд╛рдБрдбрдлрд╛рдБрдЯ | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;
  margin:0;
}
header,footer{
  background:#e8f5e9;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header a,footer a{
  text-decoration:none;
  font-weight:700;
  color:#2e7d32;
}
.container{
  max-width:1100px;
  margin:0 auto;
  padding:20px;
}
h2,h3{color:#2e7d32;margin:8px 0}
.small{font-size:13px;color:#555}

.section{
  background:#fff;
  padding:16px;
  border-radius:12px;
  margin-bottom:16px;
}

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  font-size:14px;
}
th{background:#eef5ee}
.right{text-align:right}

input{
  width:100%;
  padding:6px;
  box-sizing:border-box;
}

.btn{
  padding:6px 12px;
  background:#2e7d32;
  color:#fff;
  border:none;
  cursor:pointer;
}

.del{
  color:#c62828;
  cursor:pointer;
  font-weight:700;
}

.highlight{
  background:#e8f5e9;
  font-weight:700;
}

.totalBox{
  background:#e8f5e9;
  padding:14px;
  border-radius:12px;
  font-size:18px;
  font-weight:700;
  text-align:center;
}

.footerNav{
  display:flex;
  justify-content:space-between;
  width:100%;
}

@media print{
  header, footer, button{display:none}
  body{background:#fff}
}
</style>
</head>

<body>

<!-- TOP NAV -->
<header>
  <a href="income-demo.html">тмЕя╕П Income</a>
  <strong>ЁЯФБ рдЖрдореНрджрд╛рдиреА рдмрд╛рдБрдбрдлрд╛рдБрдЯ</strong>
  <a href="profit-loss.html">тЮбя╕П ProfitтАУLoss</a>
</header>

<div class="container">

<h2>рд╡реНрдпрд╡рд╕рд╛рдпрдХреЛ рдЖрдореНрджрд╛рдиреА рдмрд╛рдБрдбрдлрд╛рдБрдЯ</h2>
<p class="small">
тД╣я╕П рдХреБрд▓ рдЖрдореНрджрд╛рдиреАрд▓рд╛рдИ рд╡рд┐рднрд┐рдиреНрди рдЙрджреНрджреЗрд╢реНрдп рдЕрдиреБрд╕рд╛рд░ рдкреНрд░рддрд┐рд╢рддрдХрд╛ рдЖрдзрд╛рд░рдорд╛ рдмрд╛рдБрдбрдлрд╛рдБрдЯ рдЧрд░рд┐рдПрдХреЛ рдЫред
рд╢реАрд░реНрд╖рдХ рдердкреНрди, рд╣рдЯрд╛рдЙрди рд╡рд╛ рдкреНрд░рддрд┐рд╢рдд рд╕рдЪреНрдпрд╛рдЙрди рд╕рдХрд┐рдиреНрдЫред
</p>

<!-- NARRATION -->
<div class="section">
<h3>ЁЯУЭ рдмрд╛рдБрдбрдлрд╛рдБрдЯ рд╕рдореНрдмрдиреНрдзреА рд╡рд┐рд╡рд░рдг (Narration)</h3>
<textarea id="narration" rows="3"
  placeholder="рдпрд╣рд╛рдБ рдЖрдореНрджрд╛рдиреА рдмрд╛рдБрдбрдлрд╛рдБрдЯ рд╕рдореНрдмрдиреНрдзреА рдиреАрддрд┐ / рдЙрджреНрджреЗрд╢реНрдп рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН..."
  style="width:100%;padding:8px"></textarea>
</div>

<!-- ALLOCATION TABLE -->
<div class="section">
<h3>ЁЯУК рдмрд╛рдБрдбрдлрд╛рдБрдЯ рд╡рд┐рд╡рд░рдг</h3>

<table>
<thead>
<tr>
  <th>рд╢реАрд░реНрд╖рдХ</th>
  <th class="right">рдкреНрд░рддрд┐рд╢рдд (%)</th>
  <th class="right">рд░рдХрдо (рд░реБ)</th>
  <th></th>
</tr>
</thead>
<tbody id="tbody"></tbody>
<tr class="highlight">
  <th>рдЬрдореНрдорд╛</th>
  <th class="right" id="totalPercent">0 %</th>
  <th class="right" id="totalAmount">0</th>
  <th></th>
</tr>
</table>

<div style="margin-top:10px">
  <input id="newTitle" placeholder="рдирдпрд╛рдБ рд╢реАрд░реНрд╖рдХ (рдЬрд╕реНрддреИ: рдкреБрдирдГ рд▓рдЧрд╛рдиреА)">
  <input type="number" id="newPercent" placeholder="рдкреНрд░рддрд┐рд╢рдд">
  <button class="btn" onclick="addRow()">тЮХ Add</button>
</div>
</div>

<div class="totalBox">
рдХреБрд▓ рдЖрдореНрджрд╛рдиреА : рд░реБ <span id="incomeTotal">0</span>
</div>

</div>

<!-- BOTTOM NAV -->
<footer>
  <div class="footerNav">
    <a href="income-demo.html">тмЕя╕П Income</a>
    <span class="small">FarmerBase BP Engine тАУ Income Allocation</span>
    <a href="profit-loss.html">тЮбя╕П ProfitтАУLoss</a>
  </div>
</footer>

<script>
/* ===============================
   INCOME ALLOCATION тАУ FINAL
   =============================== */

const key = localStorage.getItem("activeProject");
if(!key){ alert("Active рдпреЛрдЬрдирд╛ рднреЗрдЯрд┐рдПрди"); }

const project = JSON.parse(localStorage.getItem(key)) || {};
project.incomeAllocation = project.incomeAllocation || {
  narration:"",
  rows:[
    {title:"рдкреБрдирдГ рд▓рдЧрд╛рдиреА", percent:40},
    {title:"рд╡рд╛рддрд╛рд╡рд░рдг / рд╕рд╛рдореБрджрд╛рдпрд┐рдХ рд╡рд┐рдХрд╛рд╕", percent:20},
    {title:"рдХрд╛рдорджрд╛рд░ рд╡рд┐рдХрд╛рд╕ рдХреЛрд╖", percent:20},
    {title:"рд╡реНрдпрдХреНрддрд┐рдЧрдд рдЖрдореНрджрд╛рдиреА", percent:20}
  ]
};

const rows = project.incomeAllocation.rows;

/* --- total income from income-demo --- */
function getIncomeTotal(){
  const inc = project.income || [];
  let sum = 0;
  inc.forEach(i=>{
    sum += (i.sellingRate||0) * (i.qty||0);
  });
  return sum;
}

/* --- save --- */
function save(){
  project.incomeAllocation.narration = narration.value;
  localStorage.setItem(key, JSON.stringify(project));
  render();
}

/* --- add row --- */
function addRow(){
  if(!newTitle.value || !newPercent.value) return;
  rows.push({
    title:newTitle.value,
    percent:+newPercent.value||0
  });
  newTitle.value="";
  newPercent.value="";
  save();
}

/* --- delete row --- */
function del(i){
  if(!confirm("рдпреЛ рд╢реАрд░реНрд╖рдХ рд╣рдЯрд╛рдЙрдиреЗ ?")) return;
  rows.splice(i,1);
  save();
}

/* --- render --- */
function render(){
  tbody.innerHTML="";
  let totalP=0,totalA=0;
  const income = getIncomeTotal();

  rows.forEach((r,i)=>{
    const amt = income * (r.percent||0)/100;
    totalP += r.percent||0;
    totalA += amt;

    tbody.innerHTML += `
    <tr>
      <td>
        <input value="${r.title}"
          oninput="rows[${i}].title=this.value;save()">
      </td>
      <td class="right">
        <input type="number" value="${r.percent}"
          oninput="rows[${i}].percent=+this.value||0;save()">
      </td>
      <td class="right">${amt.toLocaleString()}</td>
      <td class="del" onclick="del(${i})">тЬЦ</td>
    </tr>`;
  });

  totalPercent.innerText = totalP + " %";
  totalAmount.innerText = totalA.toLocaleString();
  incomeTotal.innerText = income.toLocaleString();
}

/* --- init --- */
narration.value = project.incomeAllocation.narration || "";
narration.oninput = save;

render();
</script>

</body>
</html>
