<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>рдЙрддреНрдкрд╛рджрди рдпреЛрдЬрдирд╛ | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;
  margin:0;
}
header{
  background:#e8f5e9;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
}
header a{color:#2e7d32;font-weight:700;text-decoration:none}
.wrap{
  max-width:1100px;
  margin:18px auto;
  background:#fff;
  padding:22px;
  border-radius:12px;
}
h2{color:#2e7d32;margin-top:0}
.small{font-size:13px;color:#555}
hr{margin:20px 0}

.row{
  display:grid;
  grid-template-columns:2fr 1fr 1fr 1fr auto;
  gap:8px;
  margin-bottom:10px;
}
input,select,textarea{padding:6px;width:100%}
button{
  padding:6px 12px;
  border:none;
  border-radius:6px;
  background:#2e7d32;
  color:#fff;
  cursor:pointer;
}
.gray{background:#607d8b}
.red{background:#c62828}
.blue{background:#0277bd}

.card{
  border:1px solid #c8e6c9;
  border-radius:10px;
  margin-bottom:14px;
}
.cardHead{
  background:#f1f8e9;
  padding:8px 12px;
  display:flex;
  justify-content:space-between;
  cursor:pointer;
}
.cardBody{padding:10px;display:none}
.item{
  display:grid;
  grid-template-columns:2fr 1fr 1fr auto auto auto;
  gap:6px;
  margin-bottom:6px;
}
.item input:disabled{background:#f5f5f5}
</style>
</head>

<body>

<header>
  <a href="business-detail.html">тмЕ Business Detail</a>
  <strong>рдЙрддреНрдкрд╛рджрди рдпреЛрдЬрдирд╛</strong>
  <a href="expense-demo.html">тЮб Expense</a>
</header>

<div class="wrap">

<h2>тЪЩя╕П рдЙрддреНрдкрд╛рджрдирдХрд╛ рдкреНрд░рдХрд╛рд░</h2>
<div class="row" style="grid-template-columns:3fr auto">
  <input id="newType" placeholder="рдирдпрд╛рдБ рдЙрддреНрдкрд╛рджрди рдкреНрд░рдХрд╛рд░">
  <button onclick="addType()">тЮХ Add Type</button>
</div>
<div id="typeList" class="small"></div>

<hr>

<h2>тЮХ рдЙрддреНрдкрд╛рджрди рдердкреНрдиреБрд╣реЛрд╕реН</h2>
<div class="row">
  <input id="pName" placeholder="рдЙрддреНрдкрд╛рджрди рдирд╛рдо">
  <input id="pUnit" placeholder="рдЗрдХрд╛рдИ">
  <input id="pQty" type="number" placeholder="рдкрд░рд┐рдорд╛рдг">
  <select id="pType"></select>
  <button onclick="addProduct()">Add</button>
</div>

<hr>

<h2>ЁЯУж рдЙрддреНрдкрд╛рджрди рд╕реВрдЪреА</h2>
<div id="products"></div>

</div>

<script>
/* ===== STORAGE (STABLE) ===== */
const STORAGE_KEY = "FB_PRODUCTION_PLAN";
let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
  types: [],
  products: [],
  typeNotes: {}
};

function save(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
}

/* ===== TYPES ===== */
function addType(){
  if(!newType.value) return;
  if(data.types.includes(newType.value)){
    alert("рдпреЛ рдкреНрд░рдХрд╛рд░ рдкрд╣рд┐рд▓реЗ рдиреИ рдЫ"); return;
  }
  data.types.push(newType.value);
  newType.value="";
  save(); render();
}
function renderTypes(){
  typeList.innerHTML="";
  pType.innerHTML="";
  data.types.forEach(t=>{
    typeList.innerHTML += `тАв ${t}<br>`;
    const o=document.createElement("option");
    o.textContent=t;
    pType.appendChild(o);
  });
}

/* ===== PRODUCTS ===== */
function addProduct(){
  if(!pName.value || !pQty.value || !pType.value){
    alert("рдЙрддреНрдкрд╛рджрди рдирд╛рдо, рдкрд░рд┐рдорд╛рдг рд░ рдкреНрд░рдХрд╛рд░ рдЕрдирд┐рд╡рд╛рд░реНрдп рдЫ");
    return;
  }
  data.products.push({
    id:Date.now(),
    name:pName.value,
    unit:pUnit.value,
    qty:Number(pQty.value),
    type:pType.value,
    edit:false
  });
  pName.value=pUnit.value=pQty.value="";
  save(); render();
}

function startEdit(id){
  const p = data.products.find(x=>x.id===id);
  p._backup = {...p};
  p.edit=true;
  render();
}
function saveEdit(id){
  const p = data.products.find(x=>x.id===id);
  delete p._backup;
  p.edit=false;
  save(); render();
}
function cancelEdit(id){
  const i = data.products.findIndex(x=>x.id===id);
  data.products[i]=data.products[i]._backup;
  data.products[i].edit=false;
  render();
}
function del(id){
  if(!confirm("рд╣рдЯрд╛рдЙрдиреЗ?")) return;
  data.products=data.products.filter(p=>p.id!==id);
  save(); render();
}

/* ===== RENDER ===== */
function render(){
  renderTypes();
  products.innerHTML="";
  const g={};
  data.products.forEach(p=>{
    if(!g[p.type]) g[p.type]=[];
    g[p.type].push(p);
  });

  Object.keys(g).forEach(t=>{
    const total=g[t].reduce((s,p)=>s+p.qty,0);
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`
      <div class="cardHead"
        onclick="this.nextElementSibling.style.display=
        this.nextElementSibling.style.display==='none'?'block':'none'">
        <b>${t}</b><span>рдЬрдореНрдорд╛: ${total}</span>
      </div>
      <div class="cardBody"></div>`;
    const b=c.querySelector(".cardBody");

    g[t].forEach(p=>{
      b.innerHTML+=`
        <div class="item">
          <input ${p.edit?"":"disabled"} value="${p.name}"
            oninput="pEdit(${p.id},'name',this.value)">
          <input ${p.edit?"":"disabled"} value="${p.unit}"
            oninput="pEdit(${p.id},'unit',this.value)">
          <input type="number" ${p.edit?"":"disabled"} value="${p.qty}"
            oninput="pEdit(${p.id},'qty',this.value)">
          ${
            p.edit
            ? `<button class="blue" onclick="saveEdit(${p.id})">ЁЯТ╛</button>
               <button class="gray" onclick="cancelEdit(${p.id})">тЖй</button>`
            : `<button class="blue" onclick="startEdit(${p.id})">тЬПя╕П</button>
               <button class="red" onclick="del(${p.id})">тЭМ</button>`
          }
        </div>`;
    });

    products.appendChild(c);
  });
}

function pEdit(id,f,v){
  const p=data.products.find(x=>x.id===id);
  p[f]=f==="qty"?Number(v):v;
}

render();
</script>

</body>
</html>
