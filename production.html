<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>рдЙрддреНрдкрд╛рджрди рдпреЛрдЬрдирд╛ | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;
  margin:0;
}
header,footer{
  background:#e8f5e9;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header a{
  color:#2e7d32;
  font-weight:700;
  text-decoration:none;
}
.wrap{
  max-width:1100px;
  margin:18px auto;
  background:#fff;
  padding:22px;
  border-radius:12px;
}
h2,h3{color:#2e7d32;margin-top:0}
.small{font-size:13px;color:#555}
hr{margin:20px 0}

/* form rows */
.row{
  display:grid;
  grid-template-columns:2fr 1fr 1fr 1fr auto;
  gap:8px;
  margin-bottom:10px;
}
input,select,textarea{
  padding:6px;
  width:100%;
}
button{
  padding:6px 14px;
  border:none;
  border-radius:6px;
  background:#2e7d32;
  color:#fff;
  cursor:pointer;
}
.gray{background:#607d8b}
.red{background:#c62828}

/* cards */
.card{
  border:1px solid #c8e6c9;
  border-radius:10px;
  margin-bottom:16px;
}
.cardHead{
  background:#f1f8e9;
  padding:8px 12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}
.cardBody{
  padding:10px;
  display:none;
}
.item{
  display:grid;
  grid-template-columns:2fr 1fr 1fr auto;
  gap:6px;
  margin-bottom:6px;
}
.item input:disabled{
  background:#f5f5f5;
}
.typeNote{
  margin-top:8px;
}
</style>
</head>

<body>

<header>
  <a href="business-detail.html">тмЕ Business Detail</a>
  <strong>рдЙрддреНрдкрд╛рджрди рдпреЛрдЬрдирд╛ (Production Plan)</strong>
  <a href="expense-demo.html">тЮб Expense</a>
</header>

<div class="wrap">

<!-- ================= TYPES ================= -->
<h2>тЪЩя╕П рдЙрддреНрдкрд╛рджрдирдХрд╛ рдкреНрд░рдХрд╛рд░ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди</h2>

<div class="row" style="grid-template-columns:3fr auto">
  <input id="newType" placeholder="рдирдпрд╛рдБ рдЙрддреНрдкрд╛рджрди рдкреНрд░рдХрд╛рд░ (рдЬрд╕реНрддреИ: рддрд░рдХрд╛рд░реА)">
  <button onclick="addType()">тЮХ Add Type</button>
</div>

<div id="typeList" class="small"></div>

<hr>

<!-- ================= ADD PRODUCT ================= -->
<h2>тЮХ рдЙрддреНрдкрд╛рджрди рдердкреНрдиреБрд╣реЛрд╕реН</h2>
<p class="small">
рдкрд╣рд┐рд▓реЗ рдЙрддреНрдкрд╛рджрдирдХреЛ рдкреНрд░рдХрд╛рд░ рдмрдирд╛рдЙрдиреБрд╣реЛрд╕реН, рддреНрдпрд╕рдкрдЫрд┐ рдорд╛рддреНрд░ рдЙрддреНрдкрд╛рджрди рдердкреНрди рд╕рдХрд┐рдиреНрдЫред
</p>

<div class="row">
  <input id="pName" placeholder="рдЙрддреНрдкрд╛рджрди рдирд╛рдо">
  <input id="pUnit" placeholder="рдЗрдХрд╛рдИ">
  <input id="pQty" type="number" placeholder="рдкрд░рд┐рдорд╛рдг">
  <select id="pType"></select>
  <button onclick="addProduct()">Add</button>
</div>

<hr>

<!-- ================= PRODUCTION LIST ================= -->
<h2>ЁЯУж рдЙрддреНрдкрд╛рджрди рд╕реВрдЪреА (Type-wise)</h2>
<div id="products"></div>

<hr>

<!-- ================= GLOBAL NARRATION ================= -->
<h2>ЁЯУЭ рд╕рдордЧреНрд░ рдЙрддреНрдкрд╛рджрди Narration</h2>
<textarea id="globalNarration" rows="4"
 placeholder="рд╕рдордЧреНрд░ рдЙрддреНрдкрд╛рджрди рдпреЛрдЬрдирд╛ рд╕рдореНрдмрдиреНрдзреА рд╡рд┐рд╡рд░рдг..."></textarea>
<button class="gray" onclick="autoGlobalNarration()">Auto Narration</button>

<hr>

<!-- ================= NEW TAB LINKS ================= -->
<h3>ЁЯФЧ рдЕрдиреНрдп рджреГрд╢реНрдп (New Tab)</h3>
<ul class="small">
  <li><a href="production-report.html" target="_blank">ЁЯУК Production Report</a></li>
  <li><a href="production-print.html" target="_blank">ЁЯЦи Print View</a></li>
  <li><a href="production-income-link.html" target="_blank">ЁЯУИ Production тЖТ Income</a></li>
</ul>

</div>

<footer>
  <span class="small">FarmerBase BP Engine тАУ Unicode Friendly Production</span>
</footer>

<script>
/* ================= LOAD ================= */
const key = localStorage.getItem("activeProject");
let project = JSON.parse(localStorage.getItem(key)) || {};

project.productionTypes = project.productionTypes || [];
project.production = project.production || [];
project.typeNarrations = project.typeNarrations || {};
project.globalNarration = project.globalNarration || "";

/* ================= SAVE ================= */
function save(){
  localStorage.setItem(key,JSON.stringify(project));
}

/* ================= TYPES ================= */
function addType(){
  if(!newType.value) return;
  if(project.productionTypes.includes(newType.value)){
    alert("рдпреЛ рдкреНрд░рдХрд╛рд░ рдкрд╣рд┐рд▓реЗ рдиреИ рдЫ"); return;
  }
  project.productionTypes.push(newType.value);
  newType.value="";
  save(); render();
}
function renderTypes(){
  typeList.innerHTML="";
  pType.innerHTML="";
  project.productionTypes.forEach(t=>{
    typeList.innerHTML += `тАв ${t}<br>`;
    const o=document.createElement("option");
    o.textContent=t;
    pType.appendChild(o);
  });
}

/* ================= PRODUCTS ================= */
function addProduct(){
  if(!pName.value || !pQty.value || !pType.value) return;
  project.production.push({
    id:Date.now(),
    name:pName.value,
    unit:pUnit.value,
    qty:Number(pQty.value),
    type:pType.value
  });
  pName.value=pUnit.value=pQty.value="";
  save(); render();
}

function deleteProduct(id){
  if(!confirm("рдпреЛ рдЙрддреНрдкрд╛рджрди рд╣рдЯрд╛рдЙрдиреЗ?")) return;
  project.production = project.production.filter(p=>p.id!==id);
  save(); render();
}

/* ================= RENDER PRODUCTS ================= */
function renderProducts(){
  products.innerHTML="";
  const groups={};

  project.production.forEach(p=>{
    if(!groups[p.type]) groups[p.type]=[];
    groups[p.type].push(p);
  });

  Object.keys(groups).forEach(type=>{
    const total = groups[type].reduce((s,p)=>s+p.qty,0);

    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="cardHead"
        onclick="this.nextElementSibling.style.display=
        this.nextElementSibling.style.display==='none'?'block':'none'">
        <b>${type}</b>
        <span>рдЬрдореНрдорд╛ рдкрд░рд┐рдорд╛рдг: ${total}</span>
      </div>
      <div class="cardBody"></div>
    `;

    const body = card.querySelector(".cardBody");

    groups[type].forEach(p=>{
      body.innerHTML += `
        <div class="item">
          <input value="${p.name}" disabled>
          <input value="${p.unit}" disabled>
          <input value="${p.qty}" disabled>
          <button class="red" onclick="deleteProduct(${p.id})">тЭМ</button>
        </div>
      `;
    });

    /* Type-wise Narration */
    const note=document.createElement("textarea");
    note.className="typeNote";
    note.rows=2;
    note.placeholder=`${type} рд╕рдореНрдмрдиреНрдзреА рдЙрддреНрдкрд╛рджрди рд╡рд┐рд╡рд░рдг...`;
    note.value = project.typeNarrations[type] || "";
    note.oninput = ()=>{
      project.typeNarrations[type]=note.value;
      save();
    };
    body.appendChild(note);

    products.appendChild(card);
  });
}

/* ================= NARRATION ================= */
function autoGlobalNarration(){
  if(!project.productionTypes.length){
    globalNarration.value="";
    return;
  }
  globalNarration.value =
    "рдпрд╕ рд╡реНрдпрд╡рд╕рд╛рдпрдорд╛ " +
    project.productionTypes.join(", ") +
    " рдЕрдиреНрддрд░реНрдЧрдд рдЙрддреНрдкрд╛рджрди рдпреЛрдЬрдирд╛ рддрдпрд╛рд░ рдЧрд░рд┐рдПрдХреЛ рдЫред";
  project.globalNarration = globalNarration.value;
  save();
}

/* ================= RENDER ================= */
function render(){
  renderTypes();
  renderProducts();
  globalNarration.value = project.globalNarration || "";
}
render();
</script>

</body>
</html>
