<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<title>рдЙрддреНрдкрд╛рджрди рдпреЛрдЬрдирд╛ | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;
  margin:0;
}
header,footer{
  background:#e8f5e9;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header a{
  text-decoration:none;
  font-weight:700;
  color:#2e7d32;
}
.wrap{
  max-width:1150px;
  margin:18px auto;
  background:#fff;
  padding:22px;
  border-radius:12px;
}
h2,h3{color:#2e7d32;margin-top:0}
.small{font-size:13px;color:#555}

/* ADD BAR */
.addBar{
  display:grid;
  grid-template-columns:2fr 1fr 1fr 1fr auto;
  gap:8px;
  margin-bottom:14px;
}
.addBar input,.addBar select{
  padding:6px;
}

/* TYPE CARD */
.typeCard{
  border:1px solid #c8e6c9;
  border-radius:10px;
  margin-bottom:16px;
}
.typeHead{
  background:#f1f8e9;
  padding:8px 12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}
.typeHead b{color:#2e7d32}
.typeBody{padding:10px}

/* PRODUCT ROW */
.prod{
  display:grid;
  grid-template-columns:2fr 1fr 1fr 2fr auto auto;
  gap:6px;
  margin-bottom:6px;
}
.prod input{
  padding:5px;
}
.prod input:disabled{
  background:#f5f5f5;
  color:#333;
}
.actionBtn{
  padding:4px 8px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.edit{background:#0277bd;color:#fff}
.save{background:#2e7d32;color:#fff}
.cancel{background:#607d8b;color:#fff}
.del{background:#c62828;color:#fff}

/* TYPE NARRATION */
.typeNote{
  margin-top:10px;
}

/* GLOBAL NARRATION */
textarea{
  width:100%;
  padding:8px;
  resize:vertical;
}
.grayBtn{
  margin-top:8px;
  background:#607d8b;
  color:#fff;
  padding:6px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <a href="business-detail.html">тмЕ Business Detail</a>
  <strong>рдЙрддреНрдкрд╛рджрди рдпреЛрдЬрдирд╛ (Production Plan)</strong>
  <a href="expense-demo.html">тЮб Expense</a>
</header>

<div class="wrap">

<h2>ЁЯМ▒ рдЙрддреНрдкрд╛рджрди рдпреЛрдЬрдирд╛</h2>
<p class="small">
рдпрд╣рд╛рдБ рдХреЗтАУрдХреБрди рдЙрддреНрдкрд╛рджрди рдЧрд░реНрдиреЗ рд░ рдХрддрд┐ рдкрд░рд┐рдорд╛рдгрдорд╛ рдЧрд░реНрдиреЗ рднрдиреНрдиреЗ рдпреЛрдЬрдирд╛ рдмрдирд╛рдЗрдиреНрдЫред
<b>рджрд░ рддрдерд╛ рд░рдХрдо Income рдкреЗрдЬрдорд╛ рдирд┐рд░реНрдзрд╛рд░рдг рд╣реБрдиреЗрдЫред</b>
</p>

<!-- ADD PRODUCT -->
<div class="addBar">
  <input id="pName" placeholder="рдЙрддреНрдкрд╛рджрди">
  <input id="pUnit" placeholder="рдЗрдХрд╛рдИ">
  <input id="pQty" type="number" placeholder="рдкрд░рд┐рдорд╛рдг">
  <select id="pType"></select>
  <button onclick="addProduct()">тЮХ Add</button>
</div>

<!-- TYPE MANAGEMENT (INLINE WITH DROPDOWN) -->
<p class="small">
ЁЯФз рдкреНрд░рдХрд╛рд░ рд╕рдЪреНрдпрд╛рдЙрди / рд╣рдЯрд╛рдЙрди рдбреНрд░рдкрдбрд╛рдЙрдирдмрд╛рдЯ рдкреНрд░рдХрд╛рд░ рдЫрд╛рдиреЗрд░ рддрд▓рдХреЛ рдмрдЯрди рдкреНрд░рдпреЛрдЧ рдЧрд░реНрдиреБрд╣реЛрд╕реН
</p>

<div class="addBar" style="grid-template-columns:2fr auto auto">
  <input id="newType" placeholder="рдирдпрд╛рдБ рдЙрддреНрдкрд╛рджрди рдкреНрд░рдХрд╛рд░">
  <button onclick="addType()">тЮХ Add Type</button>
  <button onclick="editSelectedType()">тЬПя╕П Edit Type</button>
</div>

<hr>

<!-- PRODUCTION LIST -->
<div id="types"></div>

<!-- GLOBAL NARRATION -->
<h3>ЁЯУЭ рд╕рдордЧреНрд░ рдЙрддреНрдкрд╛рджрди Narration</h3>
<textarea id="globalNarration" rows="4"
 placeholder="рд╕рдордЧреНрд░ рдЙрддреНрдкрд╛рджрди рдпреЛрдЬрдирд╛ рд╕рдореНрдмрдиреНрдзреА рд╡рд┐рд╡рд░рдг..."
 oninput="saveProject()"></textarea>

<button class="grayBtn" onclick="autoNarration()">тЪЩя╕П Auto Narration</button>

</div>

<footer>
  <span class="small">FarmerBase BP Engine тАУ Production (Quantity Only)</span>
</footer>

<script>
/* ================= LOAD PROJECT ================= */
const key = localStorage.getItem("activeProject");
if(!key){ alert("Project рднреЗрдЯрд┐рдПрди"); }
let project = JSON.parse(localStorage.getItem(key)) || {};

project.production = project.production || [];
project.productionNarration = project.productionNarration || "";
project.productionTypes = project.productionTypes || [
  "рддрд░рдХрд╛рд░реА","рдкрд╢реБрдЬрдиреНрдп","рджреБрдЧреНрдз","рдЕрдиреНрдп"
];
project.typeNarrations = project.typeNarrations || {};

/* ================= SAVE ================= */
function saveProject(){
  project.productionNarration = globalNarration.value;
  localStorage.setItem(key,JSON.stringify(project));
}

/* ================= TYPE DROPDOWN ================= */
function renderTypeDropdown(){
  const current = pType.value;
  pType.innerHTML="";
  project.productionTypes.forEach(t=>{
    const o=document.createElement("option");
    o.value=o.textContent=t;
    pType.appendChild(o);
  });
  if(current) pType.value=current;
}

/* ================= TYPE ACTIONS ================= */
function addType(){
  if(!newType.value) return;
  if(project.productionTypes.includes(newType.value)){
    alert("рдпреЛ рдкреНрд░рдХрд╛рд░ рдкрд╣рд┐рд▓реЗ рдиреИ рдЫ"); return;
  }
  project.productionTypes.push(newType.value);
  newType.value="";
  saveProject();
  render();
}

function editSelectedType(){
  const t = pType.value;
  if(!t) return;
  const n = prompt("рдирдпрд╛рдБ рдирд╛рдо", t);
  if(!n) return;

  project.productionTypes =
    project.productionTypes.map(x=>x===t?n:x);

  project.production.forEach(p=>{
    if(p.type===t) p.type=n;
  });

  project.typeNarrations[n] = project.typeNarrations[t] || "";
  delete project.typeNarrations[t];

  saveProject();
  render();
}

/* ================= PRODUCT CRUD ================= */
function addProduct(){
  if(!pName.value || !pQty.value) return;
  project.production.push({
    id:Date.now(),
    name:pName.value,
    unit:pUnit.value,
    qty:Number(pQty.value),
    type:pType.value,
    remark:"",
    _edit:false
  });
  pName.value=pUnit.value=pQty.value="";
  saveProject();
  render();
}

function startEdit(id){
  const p = project.production.find(x=>x.id===id);
  if(!p) return;
  p._backup = {...p};
  p._edit = true;
  render();
}

function tempEdit(id,f,v){
  const p = project.production.find(x=>x.id===id);
  if(!p) return;
  p[f] = f==="qty"?Number(v):v;
}

function saveEdit(id){
  const p = project.production.find(x=>x.id===id);
  if(!p) return;
  delete p._backup;
  p._edit = false;
  saveProject();
  render();
}

function cancelEdit(id){
  const i = project.production.findIndex(x=>x.id===id);
  if(i<0) return;
  project.production[i] = project.production[i]._backup;
  delete project.production[i]._backup;
  project.production[i]._edit=false;
  render();
}

function delProd(id){
  if(!confirm("рдпреЛ рдЙрддреНрдкрд╛рджрди рд╣рдЯрд╛рдЙрдиреЗ?")) return;
  project.production = project.production.filter(p=>p.id!==id);
  saveProject();
  render();
}

/* ================= RENDER ================= */
function render(){
  renderTypeDropdown();
  types.innerHTML="";

  const groups={};
  project.production.forEach(p=>{
    if(!groups[p.type]) groups[p.type]=[];
    groups[p.type].push(p);
  });

  Object.keys(groups).forEach(t=>{
    const total = groups[t].reduce((s,p)=>s+p.qty,0);

    const card=document.createElement("div");
    card.className="typeCard";
    card.innerHTML=`
      <div class="typeHead"
        onclick="this.nextElementSibling.style.display=
        this.nextElementSibling.style.display==='none'?'block':'none'">
        <b>${t}</b>
        <span>рдЬрдореНрдорд╛ рдкрд░рд┐рдорд╛рдг: ${total}</span>
      </div>
      <div class="typeBody"></div>
    `;

    const body=card.querySelector(".typeBody");

    groups[t].forEach(p=>{
      const d=document.createElement("div");
      d.className="prod";
      d.innerHTML=`
        <input value="${p.name}" ${p._edit?"":"disabled"}
          oninput="tempEdit(${p.id},'name',this.value)">
        <input value="${p.unit}" ${p._edit?"":"disabled"}
          oninput="tempEdit(${p.id},'unit',this.value)">
        <input type="number" value="${p.qty}" ${p._edit?"":"disabled"}
          oninput="tempEdit(${p.id},'qty',this.value)">
        <input placeholder="Remarks"
          value="${p.remark||""}" ${p._edit?"":"disabled"}
          oninput="tempEdit(${p.id},'remark',this.value)">

        ${
          p._edit
          ? `<button class="actionBtn save" onclick="saveEdit(${p.id})">ЁЯТ╛</button>
             <button class="actionBtn cancel" onclick="cancelEdit(${p.id})">тЖй</button>`
          : `<button class="actionBtn edit" onclick="startEdit(${p.id})">тЬПя╕П</button>
             <button class="actionBtn del" onclick="delProd(${p.id})">тЭМ</button>`
        }
      `;
      body.appendChild(d);
    });

    /* TYPE NARRATION */
    const note=document.createElement("textarea");
    note.className="typeNote";
    note.placeholder=`${t} рд╕рдореНрдмрдиреНрдзреА рдЯрд┐рдкреНрдкрдгреА...`;
    note.value = project.typeNarrations[t] || "";
    note.oninput = ()=>{
      project.typeNarrations[t]=note.value;
      saveProject();
    };
    body.appendChild(note);

    types.appendChild(card);
  });

  globalNarration.value = project.productionNarration || "";
}

/* ================= AUTO NARRATION ================= */
function autoNarration(){
  if(!project.production.length){
    globalNarration.value="";
    saveProject();
    return;
  }
  const c={};
  project.production.forEach(p=>{
    c[p.type]=(c[p.type]||0)+1;
  });
  globalNarration.value =
    "рдпрд╕ рд╡реНрдпрд╡рд╕рд╛рдпрдорд╛ " +
    Object.keys(c).map(t=>`${t} (${c[t]} рдкреНрд░рдХрд╛рд░)`).join(" рддрдерд╛ ") +
    " рдорд╛рд░реНрдлрдд рдЙрддреНрдкрд╛рджрди рдпреЛрдЬрдирд╛ рддрдпрд╛рд░ рдЧрд░рд┐рдПрдХреЛ рдЫред";
  saveProject();
}

/* INIT */
render();
</script>

</body>
</html>
