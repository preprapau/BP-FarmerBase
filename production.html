<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Production Plan | FarmerBase BP Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Noto Sans Devanagari","Kalimati",system-ui;
  background:#f4f7f6;margin:0
}
header,footer{
  background:#e8f5e9;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center
}
header a,footer a{
  text-decoration:none;
  font-weight:700;
  color:#2e7d32
}
.container{
  max-width:1200px;
  margin:auto;
  padding:20px
}
h2,h3{color:#2e7d32;margin-bottom:6px}
.small{font-size:13px;color:#555}

.section{
  background:#fff;
  padding:14px;
  border-radius:10px;
  margin-bottom:14px
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:8px
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  font-size:14px
}
th{background:#eef5ee}
input,select,textarea{
  width:100%;
  padding:6px;
  box-sizing:border-box
}
textarea{resize:vertical}

.inline{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  align-items:center
}
.inline input{max-width:160px}

.btn{
  padding:6px 12px;
  background:#2e7d32;
  color:#fff;
  border:none;
  cursor:pointer
}

.del{
  color:#c62828;
  font-weight:700;
  cursor:pointer;
  position:relative
}
.del:hover::after{
  content:"рд╣рдЯрд╛рдЙрдиреЗ";
  position:absolute;
  top:-22px;
  left:0;
  background:#c62828;
  color:#fff;
  font-size:11px;
  padding:2px 6px;
  border-radius:4px;
}

.totalBox{
  font-size:16px;
  font-weight:700;
  color:#2e7d32;
  margin-top:10px
}

.reportBar{
  margin-top:16px;
  display:flex;
  gap:10px;
  flex-wrap:wrap
}
.reportBar a{
  background:#fff;
  border:2px solid #2e7d32;
  padding:8px 12px;
  font-weight:700;
  color:#2e7d32;
  text-decoration:none
}

.typeHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  user-select:none
}
.typeHeader span{font-size:13px}

.stickyBar{
  position:sticky;
  top:0;
  z-index:20;
  background:#f4f7f6;
  padding-bottom:8px
}

.undoBar{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#263238;
  color:#fff;
  padding:10px 14px;
  border-radius:8px;
  display:none;
  gap:10px;
  align-items:center
}
.undoBar button{
  background:#2e7d32;
  color:#fff;
  border:none;
  padding:4px 10px;
  cursor:pointer
}

.footerNav{
  display:flex;
  justify-content:space-between;
  width:100%
}
</style>
</head>

<body>

<header>
  <a href="business-detail.html">тмЕя╕П Business</a>
  <strong>ЁЯУж Production Plan</strong>
  <a href="expense-demo.html">тЮбя╕П Expense</a>
</header>

<div class="container">

<h2>рдЙрддреНрдкрд╛рджрди рдпреЛрдЬрдирд╛ (Production Plan)</h2>

<!-- STICKY CONTROLS -->
<div class="stickyBar">

<div class="section">
<h3>тЮХ рдЫрд┐рдЯреЛ рдЙрддреНрдкрд╛рджрди рдердкреНрдиреБрд╣реЛрд╕реН</h3>
<div class="inline">
  <input id="qName" placeholder="рдЙрддреНрдкрд╛рджрди">
  <input id="qUnit" placeholder="рдЗрдХрд╛рдИ">
  <input type="number" id="qRate" placeholder="рджрд░">
  <input type="number" id="qQty" placeholder="рдкрд░рд┐рдорд╛рдг">
  <select id="qType"></select>
  <button class="btn" onclick="quickAdd()">Add</button>
</div>
</div>

<div class="section" style="text-align:right">
  <button class="btn" onclick="expandAll()">тЮХ рд╕рдмреИ рдЦреЛрд▓реНрдиреБрд╣реЛрд╕реН</button>
  <button class="btn" onclick="collapseAll()">тЮЦ рд╕рдмреИ рдмрдиреНрдж рдЧрд░реНрдиреБрд╣реЛрд╕реН</button>
</div>

</div>

<!-- CATEGORY MANAGER -->
<div class="section">
<h3 onclick="toggleType()" style="cursor:pointer">тЪЩя╕П рдЙрддреНрдкрд╛рджрдирдХрд╛ рдкреНрд░рдХрд╛рд░ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди</h3>
<div id="typeSection" style="display:none">
  <div id="typeBox"></div>
  <div class="inline">
    <input id="newType" placeholder="рдирдпрд╛рдБ рдкреНрд░рдХрд╛рд░">
    <button class="btn" onclick="addType()">Add</button>
  </div>
</div>
</div>

<!-- NARRATION -->
<div class="section">
<h3>ЁЯУЭ рд╕рдордЧреНрд░ рдЙрддреНрдкрд╛рджрди Narration</h3>
<textarea id="tableNarration" rows="3"></textarea>
<button class="btn" onclick="generateNarration()">тЬи Auto Generate</button>
</div>

<!-- TABLES -->
<div id="tables"></div>

<div class="totalBox">
рдХреБрд▓ рдЙрддреНрдкрд╛рджрди рдореВрд▓реНрдп: рд░реБ <span id="grandTotal">0</span>
</div>

<div class="reportBar">
  <a href="#" onclick="mapToIncome()">ЁЯФБ Map to Income</a>
  <a href="production-report.html" target="_blank">ЁЯУК Report</a>
  <a href="production-chart.html" target="_blank">ЁЯУИ Chart</a>
</div>

</div>

<footer>
  <div class="footerNav">
    <a href="business-detail.html">тмЕя╕П Business</a>
    <span class="small" id="saveStatus"></span>
    <a href="expense-demo.html">тЮбя╕П Expense</a>
  </div>
</footer>

<div id="undoBar" class="undoBar">
  <span>рдЙрддреНрдкрд╛рджрди рд╣рдЯрд╛рдЗрдпреЛ</span>
  <button onclick="undoDelete()">Undo</button>
</div>

<script>
/* ========= CORE ========= */
const key = localStorage.getItem("activeProject");
if(!key) alert("Active рдпреЛрдЬрдирд╛ рднреЗрдЯрд┐рдПрди ред");
let project = JSON.parse(localStorage.getItem(key))||{};
project.production = project.production || {
  types:["рдкрд╢реБ","рддрд░рдХрд╛рд░реА","рджреБрдЧреНрдз","рдЕрдиреНрдп"],
  items:[],
  narration:""
};

const TYPES = project.production.types;
const ITEMS = project.production.items;

/* ========= SAVE ========= */
function save(){
  localStorage.setItem(key,JSON.stringify(project));
  saveStatus.innerText="ЁЯТ╛ Saved";
  setTimeout(()=>saveStatus.innerText="",1000);
  render();
}

/* ========= TYPE ========= */
function toggleType(){
  typeSection.style.display =
    typeSection.style.display==="none"?"block":"none";
}
function renderTypes(){
  typeBox.innerHTML="";
  TYPES.forEach((t,i)=>{
    typeBox.innerHTML+=`
    <div class="inline">
      <input value="${t}" oninput="editType(${i},this.value)">
      <span class="del" onclick="delType(${i})">тЬЦ</span>
    </div>`;
  });
}
function addType(){
  if(!newType.value) return;
  TYPES.push(newType.value);
  newType.value="";
  save();
}
function editType(i,v){TYPES[i]=v;save();}
function delType(i){
  if(!confirm("рдкреНрд░рдХрд╛рд░ рд╣рдЯрд╛рдЙрдиреЗ ?"))return;
  const t=TYPES[i];
  TYPES.splice(i,1);
  project.production.items=ITEMS.filter(p=>p.type!==t);
  save();
}

/* ========= QUICK ADD ========= */
function fillQuickTypes(){
  qType.innerHTML="";
  TYPES.forEach(t=>qType.innerHTML+=`<option>${t}</option>`);
}
function quickAdd(){
  if(!qName.value) return;
  ITEMS.push({
    id:Date.now(),
    name:qName.value,
    unit:qUnit.value,
    rate:+qRate.value||0,
    qty:+qQty.value||0,
    type:qType.value,
    note:""
  });
  qName.value=qUnit.value=qRate.value=qQty.value="";
  save();
}

/* ========= COLLAPSE ========= */
function getState(){
  return JSON.parse(localStorage.getItem("PROD_COLLAPSE"))||{};
}
function saveState(t,v){
  const s=getState();s[t]=v;
  localStorage.setItem("PROD_COLLAPSE",JSON.stringify(s));
}
function toggleTypeTable(t){
  const b=document.getElementById("box-"+t);
  const i=document.getElementById("icon-"+t);
  const open=b.style.display!=="none";
  b.style.display=open?"none":"block";
  i.innerText=open?"тЮХ Show":"тЮЦ Hide";
  saveState(t,!open);
}
function expandAll(){TYPES.forEach(t=>saveState(t,true));render();}
function collapseAll(){TYPES.forEach(t=>saveState(t,false));render();}

/* ========= DELETE + UNDO ========= */
let lastDeleted=null,undoTimer=null;
function remove(id){
  if(!confirm("рдЙрддреНрдкрд╛рджрди рд╣рдЯрд╛рдЙрдиреЗ ?"))return;
  const i=ITEMS.findIndex(x=>x.id==id);
  lastDeleted=ITEMS[i];
  ITEMS.splice(i,1);
  undoBar.style.display="flex";
  clearTimeout(undoTimer);
  undoTimer=setTimeout(()=>undoBar.style.display="none",10000);
  save();
}
function undoDelete(){
  if(lastDeleted){
    ITEMS.push(lastDeleted);
    lastDeleted=null;
    undoBar.style.display="none";
    save();
  }
}

/* ========= NARRATION ========= */
tableNarration.value=project.production.narration;
function generateNarration(){
  let sum={};
  ITEMS.forEach(p=>{
    const a=p.rate*p.qty;
    sum[p.type]=(sum[p.type]||0)+a;
  });
  let txt="рдпрд╕ рд╡реНрдпрд╡рд╕рд╛рдпрдорд╛ ";
  Object.keys(sum).forEach((t,i)=>{
    txt+=`${t} рдЙрддреНрдкрд╛рджрдирдмрд╛рдЯ рд░реБ ${sum[t].toLocaleString()}`;
    if(i<Object.keys(sum).length-1)txt+=" рд░ ";
  });
  txt+=" рдмрд░рд╛рдмрд░рдХреЛ рдЙрддреНрдкрд╛рджрди рдпреЛрдЬрдирд╛ рддрдпрд╛рд░ рдЧрд░рд┐рдПрдХреЛ рдЫред";
  tableNarration.value=txt;
  project.production.narration=txt;
  save();
}
tableNarration.oninput=()=>{project.production.narration=tableNarration.value;save();};

/* ========= MAP TO INCOME ========= */
function mapToIncome(){
  project.income=project.income||[];
  ITEMS.forEach(p=>{
    project.income.push({
      source:p.name,unit:p.unit,rate:p.rate,qty:p.qty,
      amount:p.rate*p.qty
    });
  });
  localStorage.setItem(key,JSON.stringify(project));
  alert("Income draft рддрдпрд╛рд░ рднрдпреЛ");
}

/* ========= RENDER ========= */
function render(){
  renderTypes();
  fillQuickTypes();
  tables.innerHTML="";
  let g=0,s=getState();

  TYPES.forEach(t=>{
    const rows=ITEMS.filter(p=>p.type===t);
    if(!rows.length)return;
    let sub=0;
    let html=`<div class="section">
    <div class="typeHeader" onclick="toggleTypeTable('${t}')">
      <h3>${t}</h3><span id="icon-${t}">тЮЦ Hide</span>
    </div>
    <div id="box-${t}">
    <table>
    <tr><th>рдЙрддреНрдкрд╛рджрди</th><th>рдЗрдХрд╛рдИ</th><th>рджрд░</th><th>рдкрд░рд┐рдорд╛рдг</th><th>рд░рдХрдо</th><th></th></tr>`;
    rows.forEach(p=>{
      const a=p.rate*p.qty;sub+=a;g+=a;
      html+=`<tr>
<td><input value="${p.name}" oninput="p.name=this.value;save()"></td>
<td><input value="${p.unit}" oninput="p.unit=this.value;save()"></td>
<td><input type="number" value="${p.rate}" oninput="p.rate=+this.value;save()"></td>
<td><input type="number" value="${p.qty}" oninput="p.qty=+this.value;save()"></td>
<td>${a.toLocaleString()}</td>
<td class="del" onclick="remove('${p.id}')">тЬЦ</td>
</tr>`;
    });
    html+=`<tr><th colspan="4">рдЙрдктАУрдЬрдореНрдорд╛</th><th>${sub.toLocaleString()}</th><th></th></tr>
    </table></div></div>`;
    tables.innerHTML+=html;

    if(s[t]===false){
      document.getElementById("box-"+t).style.display="none";
      document.getElementById("icon-"+t).innerText="тЮХ Show";
    }
  });
  grandTotal.innerText=g.toLocaleString();
}

/* ========= SHORTCUT ========= */
document.addEventListener("keydown",e=>{
  if(e.altKey&&e.key==="ArrowUp"){e.preventDefault();expandAll();}
  if(e.altKey&&e.key==="ArrowDown"){e.preventDefault();collapseAll();}
});

render();
</script>

</body>
</html>
